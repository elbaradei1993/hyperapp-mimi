<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HyperApp - Community Safety Platform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --primary: #2D5BFF;
      --primary-dark: #1A46E0;
      --secondary: #FF6B35;
      --success: #28A745;
      --danger: #DC3545;
      --warning: #FFC107;
      --info: #17A2B8;
      --dark-bg: #0A192F;
      --card-bg: rgba(255, 255, 255, 0.05);
      --text-light: #F8F9FC;
      --text-muted: #A0AEC0;
      --border-radius: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    body {
      background: var(--dark-bg);
      color: var(--text-light);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
    }

    .container {
      max-width: 100%;
      padding: 16px;
      margin: 0 auto;
      padding-bottom: 70px;
    }

    header {
      text-align: center;
      padding: 15px 0;
      position: relative;
    }

    .logo {
      width: 60px;
      height: 60px;
      margin: 0 auto 10px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(45, 91, 255, 0.3);
    }

    .logo i {
      font-size: 24px;
      color: white;
    }

    h1 {
      font-size: 24px;
      margin-bottom: 5px;
      background: linear-gradient(to right, #fff, var(--primary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 20px;
    }

    .language-switcher {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 12px 15px;
      margin: 15px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .connected {
      color: var(--success);
    }

    .disconnected {
      color: var(--danger);
    }

    .app-nav {
      display: flex;
      justify-content: space-around;
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      margin: 15px 0;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      position: fixed;
      bottom: 15px;
      left: 15px;
      right: 15px;
      z-index: 100;
    }

    .nav-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 10px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      flex: 1;
      display: flex;
      justify-content: center;
    }

    .nav-btn.active {
      background: rgba(45, 91, 255, 0.2);
      color: var(--primary);
    }

    .nav-btn i {
      font-size: 20px;
    }

    .content-area {
      margin-bottom: 70px;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 极细线);
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-weight: 600;
      color: var(--primary);
    }

    .reports-container {
      max-height: 300px;
      overflow-y: auto;
    }

    .report-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .report-info {
      flex: 1;
    }

    .report-type {
      font-weight: 500;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .report-details {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 5px;
    }

    .report-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 10px;
    }

    .report-actions {
      display: flex;
      gap: 8px;
    }

    .vote-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      color: var(--text-light);
      transition: all 0.3s ease;
    }

    .vote-btn:hover:not([aria-disabled="true"]) {
      background: rgba(255, 255, 255, 0.2);
    }

    .vote-btn[aria-disabled="true"] {
      opacity: 0.5;
      cursor: not-allowed;
      background: rgba(255, 255, 255, 0.05);
    }

    .upvote-btn.active {
      color: var(--success);
      background: rgba(40, 167, 69, 0.2);
    }

    .downvote-btn.active {
      color: var(--danger);
      background: rgba(220, 53, 69, 0.2);
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px 0;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn:hover {
      background: rgba(45, 91, 255, 0.15);
      transform: translateY(-2px);
    }

    .action-btn i {
      font-size: 20px;
      color: var(--primary);
      margin-bottom: 5px;
      display: block;
    }

    .action-btn span {
      font-size: 13px;
      font-weight: 500;
    }

    .emergency-btn {
      background: rgba(220, 53, 69, 0.2);
      border-color: rgba(220, 53, 69, 0.3);
    }

    .emergency-btn i {
      color: var(--danger);
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(45, 91, 255, 0.3);
    }

    .refresh-btn {
      width: 100%;
      margin-top: 15px;
    }

    .btn-emergency {
      background: var(--danger);
      width: 100%;
    }

    .btn-emergency:hover {
      background: #c82333;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--primary);
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .map-container {
      height: 400px;
      position: relative;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .map-visualization {
      height: 100%;
      position: relative;
    }

    .map-header {
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }

    .map-header h3 {
      margin: 0 0 5px 0;
      color: white;
      font-size: 16px;
    }

    .map-header p {
      margin: 0;
      font-size: 12px;
      opacity: 0.8;
    }

    .map-points {
      position: absolute;
      top: 60px;
      left: 15px;
      right: 15px;
      bottom: 70px;
      padding: 0;
    }

    .map-point {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate(-50%, -50%);
      animation: pulse 2s infinite ease-in-out;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      z-index: 5;
    }

    .map-point:hover {
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 20;
    }

    .map-point i {
      font-size: 12px;
      color: white;
    }

    .map-point[data-vibe="crowded"] { background: rgba(255, 165, 0, 0.8); }
    .map-point[data-vibe="noisy"] { background: rgba(255, 107, 53, 0.8); }
    .map-point[data-vibe="festive"] { background: rgba(40, 167, 69, 0.8); }
    .map-point[data-vibe="calm"] { background: rgba(23, 162, 184, 0.8); }
    .map-point[data-vibe="suspicious"] { background: rgba(255, 193, 7, 0.8); }
    .map-point[data-vibe="dangerous"] { background: rgba(220, 53, 69, 0.8); }

    .map-controls {
      position: absolute;
      top: 80px;
      right: 15px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-control-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      color: #333;
    }

    .map-control-btn:hover {
      background: white;
      transform: scale(1.05);
    }

    .map-control-btn:active {
      transform: scale(0.95);
    }

    .map-legend {
      position: absolute;
      bottom: 15px;
      left: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.8);
      border-radius: 8px;
      padding: 12px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .legend-item i {
      font-size: 12px;
      min-width: 12px;
      text-align: center;
    }

    .map-placeholder-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: var(--text-light);
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
    }

    .map-placeholder-center i {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.7;
    }

    .map-placeholder-center p {
      font-size: 16px;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .map-placeholder-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 15;
    }

    .map-canvas {
      position: relative;
      height: 100%;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: 8px;
      overflow: hidden;
    }

    .map-background {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 70px;
      background: linear-gradient(135deg, #e8f5e8 0%, #f3e5f5 100%);
    }

    .map-grid {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .grid-line {
      position: absolute;
      background: rgba(0, 0, 0, 0.1);
    }

    .grid-line.horizontal {
      width: 100%;
      height: 1px;
    }

    .grid-line.vertical {
      width: 1px;
      height: 100%;
    }

    .map-landmarks {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .landmark {
      position: absolute;
      color: rgba(0, 0, 0, 0.3);
      font-size: 16px;
      transform: translate(-50%, -50%);
    }

    .map-reports {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 70px;
    }

    .map-report-point {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate(-50%, -50%);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      z-index: 10;
      border: 2px solid white;
    }

    .map-report-point:hover {
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 20;
    }

    .map-report-point i {
      font-size: 14px;
      color: white;
    }

    .map-report-point[data-vibe="crowded"] { background: rgba(255, 165, 0, 0.9); }
    .map-report-point[data-vibe="noisy"] { background: rgba(255, 107, 53, 0.9); }
    .map-report-point[data-vibe="festive"] { background: rgba(40, 167, 69, 0.9); }
    .map-report-point[data-vibe="calm"] { background: rgba(23, 162, 184, 0.9); }
    .map-report-point[data-vibe="suspicious"] { background: rgba(255, 193, 7, 0.9); }
    .map-report-point[data-vibe="dangerous"] { background: rgba(220, 53, 69, 0.9); }

    .report-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 30;
      margin-bottom: 8px;
    }

    .map-report-point:hover .report-tooltip {
      opacity: 1;
    }

    .report-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.8);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--dark-bg);
      margin: 1% auto;
      width: 90%;
      max-width: 500px;
      border-radius: var(--border-radius);
      overflow: hidden;
      animation: modalFadeIn 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 98vh;
      display: flex;
      flex-direction: column;
    }

    .modal-content.emergency {
      border: 2px solid var(--danger);
    }

    .modal-header {
      background: var(--card-bg);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h2 {
      font-size: 18px;
      color: var(--text-light);
    }

    .close {
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close:hover {
      color: var(--text-light);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .vibe-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .vibe-option {
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .vibe-option:hover {
      border-color: var(--primary);
      background: rgba(45, 91, 255, 0.1);
    }

    .vibe-option.selected {
      border-color: var(--primary);
      background: rgba(45, 91, 255, 0.15);
    }

    .vibe-option i {
      font-size: 20px;
      margin-bottom: 5px;
      display: block;
    }

    .vibe-option span {
      font-size: 12px;
      font-weight: 500;
    }

    textarea, select, input {
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 12px;
      color: var(--text-light);
      resize: vertical;
    }

    textarea:focus, select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      min-height: 100px;
    }

    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h3 {
      margin-bottom: 15px;
      color: var(--primary);
      font-size: 16px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .notification {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 12px 20px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      z-index: 1000;
      max-width: 90%;
      animation: slideInUp 0.3s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .notification.hidden {
      display: none;
    }

    .notification.success {
      background: rgba(40, 167, 69, 0.9);
      border-color: rgba(40, 167, 69, 0.5);
    }

    .notification.error {
      background: rgba(220, 53, 69, 0.9);
      border-color: rgba(220, 53, 69, 0.5);
    }

    .notification.warning {
      background: rgba(255, 193, 7, 0.9);
      border-color: rgba(255, 193, 7, 0.5);
      color: #000;
    }

    .notification.info {
      background: rgba(23, 162, 184, 0.9);
      border-color: rgba(23, 162, 184, 0.5);
    }

    .no-data {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Authentication Styles */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }
    
    .auth-content {
      background: var(--dark-bg);
      margin: 2% auto;
      width: 90%;
      max-width: 400px;
      border-radius: var(--border-radius);
      overflow-y: auto;
      max-height: 96vh;
      animation: modalFadeIn 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-header {
      background: var(--card-bg);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-tabs {
      display: flex;
      background: var(--card-bg);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.3s ease;
    }
    
    .auth-tab.active {
      opacity: 1;
      border-bottom: 2px solid var(--primary);
      background: rgba(45, 91, 255, 0.1);
    }
    
    .auth-form {
      padding: 20px;
    }
    
    .auth-form.hidden {
      display: none;
    }
    
    .auth-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .auth-btn:hover {
      background: var(--primary-dark);
    }
    
    .auth-footer {
      padding: 15px 20px;
      text-align: center;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      color: var(--text-muted);
    }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    }

    @keyframes slideInUp {
      from {
        transform: translate(-50%, 100%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Top Areas Modal Styles */
    .top-areas-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .area-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .area-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .area-rank {
      background: var(--primary);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .area-info h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: var(--text-light);
    }

    .area-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .area-vibes {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .vibe-tag {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 4px 8px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .vibe-tag.vibe-crowded { background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.3); }
    .vibe-tag.vibe-noisy { background: rgba(255, 107, 53, 0.2); border-color: rgba(255, 107, 53, 0.3); }
    .vibe-tag.vibe-festive { background: rgba(40, 167, 69, 0.2); border-color: rgba(40, 167, 69, 0.3); }
    .vibe-tag.vibe-calm { background: rgba(23, 162, 184, 0.2); border-color: rgba(23, 162, 184, 0.3); }
    .vibe-tag.vibe-suspicious { background: rgba(255, 193, 7, 0.2); border-color: rgba(255, 193, 7, 0.3); }
    .vibe-tag.vibe-dangerous { background: rgba(220, 53, 69, 0.2); border-color: rgba(220, 53, 69, 0.3); }

    .vibe-tag i {
      font-size: 10px;
    }


  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div id="authModal" class="auth-modal">
    <div class="auth-content">
      <div class="auth-header">
        <h2 data-en="Authentication Required" data-ar="مطلوب مصادقة">Authentication Required</h2>
        <span class="close" id="closeAuth">&times;</span>
      </div>
      
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Login</div>
        <div class="auth-tab" data-tab="signup">Sign Up</div>
      </div>
      
      <div class="auth-form" id="loginForm">
        <div class="form-group">
          <label data-en="Email" data-ar="البريد الإلكتروني">Email</label>
          <input type="email" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label data-en="Password" data-ar="كلمة المرور">Password</label>
          <input type="password" id="loginPassword" placeholder="••••••••">
        </div>
        <button class="auth-btn" id="loginBtn" data-en="Login" data-ar="تسجيل الدخول">Login</button>
      </div>
      
      <div class="auth-form hidden" id="signupForm">
        <div class="form-group">
          <label data-en="Username" data-ar="اسم المستخدم">Username</label>
          <input type="text" id="signupUsername" placeholder="Choose a username">
        </div>
        <div class="form-group">
          <label data-en="Email" data-ar="البريد الإلكتروني">Email</label>
          <input type="email" id="signupEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label data-en="Password" data-ar="كلمة المرور">Password</label>
          <input type="password" id="signupPassword" placeholder="••••••••">
        </div>
        <div class="form-group">
          <label data-en="Confirm Password" data-ar="تأكيد كلمة المرور">Confirm Password</label>
          <input type="password" id="signupPasswordConfirm" placeholder="••••••••">
        </div>
        <button class="auth-btn" id="signupBtn" data-en="Sign Up" data-ar="إنشاء حساب">Sign Up</button>
      </div>
      
      <div class="auth-footer">
        <p data-en="You need to authenticate to use all features" data-ar="تحتاج إلى المصادقة لاستخدام جميع الميزات">You need to authenticate to use all features</p>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Header Section -->
    <header>
      <div class="logo">
        <i class="fas fa-shield-alt"></i>
      </div>
      <h1>HyperApp</h1>
      <p class="subtitle">Community-Powered Safety Reports</p>
      
      <div class="language-switcher" id="languageSwitcher">
        <i class="fas fa-globe"></i> <span id="currentLanguage">EN</span>
      </div>
    </header>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item" id="connectionStatus">
        <i class="fas fa-circle-notch fa-spin"></i>
        <span data-en="Connecting..." data-ar="جاري الاتصال...">Connecting...</span>
      </div>
      <div class="status-item">
        <i class="fas fa-star"></i>
        <span data-en="Rep:" data-ar="النقاط:">Rep:</span> <span id="userReputation">0</span>
      </div>
    </div>

    <!-- Main Navigation -->
    <nav class="app-nav">
      <button class="nav-btn active" data-view="main"><i class="fas fa-home"></i></button>
      <button class="nav-btn" data-view="map"><i class="fas fa-map"></i></button>
      <button class="nav-btn" data-view="reports"><i class="fas fa-list"></i></button>
      <button class="nav-btn" data-view="settings"><i class="fas fa-cog"></i></button>
    </nav>

    <!-- Main Content Area -->
    <main class="content-area">
      <!-- Main View -->
      <div id="mainView" class="view active">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-map-marker-alt"></i> 
            <span data-en="Nearby Reports" data-ar="التقارير القريبة">Nearby Reports</span>
          </div>
          <div id="nearbyReports" class="reports-container">
            <div class="loading-spinner"></div>
          </div>
          <button class="btn refresh-btn" id="refreshReports">
            <i class="fas fa-sync-alt"></i> 
            <span data-en="Refresh" data-ar="تحديث">Refresh</span>
          </button>
        </div>

        <div class="quick-actions">
          <div class="action-btn" data-action="report">
            <i class="fas fa-plus-circle"></i>
            <span data-en="Report Vibe" data-ar="الإبلاغ عن حالة">Report Vibe</span>
          </div>
          <div class="action-btn" data-action="areas">
            <i class="fas fa-chart-line"></i>
            <span data-en="Top Areas" data-ar="أهم المناطق">Top Areas</span>
          </div>
          <div class="action-btn emergency-btn" data-action="emergency">
            <i class="fas fa-exclamation-triangle"></i>
            <span data-en="Emergency" data-ar="طارئ">Emergency</span>
          </div>
        </div>
      </div>

      <!-- Map View -->
      <div id="mapView" class="view">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-map"></i> 
            <span data-en="Vibe Map" data-ar="خريطة الحالات">Vibe Map</span>
          </div>
          <div id="mapContainer" class="map-container">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- Reports View -->
      <div id="reportsView" class="view">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-list"></i> 
            <span data-en="My Reports" data-ar="تقاريري">My Reports</span>
          </div>
          <div id="userReports" class="reports-container">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div id="settingsView" class="view">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-cog"></i> 
            <span data-en="Settings" data-ar="الإعدادات">Settings</span>
          </div>
          
          <div class="settings-section">
            <h3 data-en="Account" data-ar="الحساب">Account</h3>
            <div class="setting-item">
              <span data-en="Username" data-ar="اسم المستخدم">Username</span>
              <span id="settingsUsername">-</span>
            </div>
            <div class="setting-item">
              <span data-en="Reputation" data-ar="النقاط">Reputation</span>
              <span id="settingsReputation">0</span>
            </div>
            <div class="setting-item">
              <span data-en="Account Actions" data-ar="إجراءات الحساب">Account Actions</span>
              <button class="btn btn-danger" id="logoutBtn" data-en="Logout" data-ar="تسجيل الخروج">Logout</button>
            </div>
          </div>
          
          <div class="settings-section">
            <h3 data-en="Preferences" data-ar="التفضيلات">Preferences</h3>
            <div class="setting-item">
              <span data-en="Language" data-ar="اللغة">Language</span>
              <select id="languageSelect">
                <option value="en">English</option>
                <option value="ar">العربية</option>
              </select>
            </div>
          </div>
          
          <div class="settings-section">
            <h3 data-en="About" data-ar="عن التطبيق">About</h3>
            <p data-en="HyperApp helps communities stay informed about safety conditions in their area." data-ar="يساعد HyperApp المجتمعات على البقاء على اطلاع بظروف السلامة في منطقتهم.">
              HyperApp helps communities stay informed about safety conditions in their area.
            </p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Report Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-en="Report Vibe" data-ar="الإبلاغ عن حالة">Report Vibe</h2>
        <span class="close" data-dismiss="reportModal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label data-en="What's the vibe?" data-ar="ما هي الحالة؟">What's the vibe?</label>
          <div class="vibe-options">
            <div class="vibe-option" data-vibe="crowded">
              <i class="fas fa-users"></i>
              <span data-en="Crowded" data-ar="مزدحم">Crowded</span>
            </div>
            <div class="vibe-option" data-vibe="noisy">
              <i class="fas fa-volume-up"></i>
              <span data-en="Noisy" data-ar="صاخب">Noisy</span>
            </div>
            <div class="vibe-option" data-vibe="festive">
              <i class="fas fa-glass-cheers"></i>
              <span data-en="Festive" data-ar="احتفالي">Festive</span>
            </div>
            <div class="vibe-option" data-vibe="calm">
              <i class="fas fa-peace"></i>
              <span data-en="Calm" data-ar="هادئ">Calm</span>
            </div>
            <div class="vibe-option" data-vibe="suspicious">
              <i class="fas fa-eye-slash"></i>
              <span data-en="Suspicious" data-ar="مشبوه">Suspicious</span>
            </div>
            <div class="vibe-option" data-vibe="dangerous">
              <i class="fas fa-exclamation-triangle"></i>
              <span data-en="Dangerous" data-ar="خطير">Dangerous</span>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label data-en="Location (optional)" data-ar="الموقع (اختياري)">Location (optional)</label>
          <input type="text" id="reportLocation" placeholder="Enter location">
        </div>
        <div class="form-group">
          <label data-en="Notes (optional)" data-ar="ملاحظات (اختياري)">Notes (optional)</label>
          <textarea id="reportNotes" placeholder="Add details about what you're experiencing"></textarea>
        </div>
        <button class="btn" id="submitReportBtn" data-en="Submit Report" data-ar="إرسال التقرير">Submit Report</button>
      </div>
    </div>
  </div>

  <!-- Emergency Modal -->
  <div id="emergencyModal" class="modal">
    <div class="modal-content emergency">
      <div class="modal-header">
        <h2 data-en="Emergency Report" data-ar="تقرير طارئ">Emergency Report</h2>
        <span class="close" data-dismiss="emergencyModal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label data-en="Emergency Type" data-ar="نوع الطوارئ">Emergency Type</label>
          <select id="emergencyType">
            <option value="medical" data-en="Medical Emergency" data-ar="طوارئ طبية">Medical Emergency</option>
            <option value="police" data-en="Police Needed" data-ar="الحاجة إلى الشرطة">Police Needed</option>
            <option value="fire" data-en="Fire Emergency" data-ar="طوارئ حريق">Fire Emergency</option>
            <option value="other" data-en="Other Emergency" data-ar="طوارئ أخرى">Other Emergency</option>
          </select>
        </div>
        <div class="form-group">
          <label data-en="Location" data-ar="الموقع">Location</label>
          <input type="text" id="emergencyLocation" placeholder="Enter your current location" required>
        </div>
        <div class="form-group">
          <label data-en="Details" data-ar="التفاصيل">Details</label>
          <textarea id="emergencyDetails" placeholder="Please provide details about the emergency" required></textarea>
        </div>
        <button class="btn btn-emergency" id="submitEmergencyBtn" data-en="Report Emergency" data-ar="الإبلاغ عن حالة الطوارئ">Report Emergency</button>
      </div>
    </div>
  </div>

  <script>
    // HyperApp Mini App - Complete Fixed Implementation
    class HyperApp {
      constructor() {
        this.tg = window.Telegram.WebApp;
        this.currentLanguage = 'en';
        this.userData = null;
        this.nearbyReports = [];
        this.userReports = [];
        this.selectedVibe = null;
        this.isConnected = false;
        this.userLocation = null;
        this.isAuthenticated = false;
        
        // Initialize Supabase with the correct API key
        this.supabaseUrl = 'https://nqwejzbayquzsvcodunl.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xd2VqemJheXF1enN2Y29kdW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTA0MjAsImV4cCI6MjA3Mzk2NjQyMH0.01yifC-tfEbBHD5u315fpb_nZrqMZCbma_UrMacMb78';
        this.supabase = window.supabase.createClient(this.supabaseUrl, this.supabaseKey);
        
        // Check authentication state
        this.checkAuthState();
        
        // Bind all methods to maintain 'this' context
        this.bindMethods();
        
        this.init();
      }
      
      // Bind all methods to maintain proper 'this' context
      bindMethods() {
        const methods = [
          'init', 'setupEventListeners', 'syncUserWithSupabase', 'updateConnectionStatus',
          'updateUserInfo', 'loadInitialData', 'loadNearbyReports', 'displayNearbyReports',
          'loadUserReports', 'displayUserReports', 'voteReport', 'showReportModal',
          'selectVibe', 'submitReport', 'showEmergencyReport', 'submitEmergencyReport',
          'showView', 'loadMap', 'displayMap', 'loadTopAreas', 'toggleLanguage',
          'changeLanguage', 'applyLanguage', 'showNotification', 'closeModal',
          'getVibeIcon', 'getVibeArabicName', 'capitalizeFirstLetter', 'formatTimeAgo',
          'updateTextDirection', 'requestUserLocation', 'checkAuthState',
          'showAuthModal', 'hideAuthModal', 'setupAuthListeners', 'handleAuthLogin',
          'handleAuthSignup'
        ];
        
        methods.forEach(method => {
          this[method] = this[method].bind(this);
        });
      }
      
      async init() {
        console.log("Initializing HyperApp with Supabase...");
        
        // Set up auth listeners
        this.setupAuthListeners();
        
        // Initialize Telegram WebApp
        if (this.tg) {
          this.tg.expand();
          this.tg.MainButton.hide();
          
          // Get user data
          const user = this.tg.initDataUnsafe.user;
          if (user) {
            this.userData = user;
            this.isAuthenticated = true;
            await this.syncUserWithSupabase();
            this.updateUserInfo();
          }
          
          // Try to get user location
          this.requestUserLocation();
          
          // Set up event listeners
          this.setupEventListeners();
          
          // Update connection status
          this.updateConnectionStatus(true);
        } else {
          console.log("Not in Telegram environment");
          this.updateConnectionStatus(false);
          this.showNotification("Running in standalone mode", "info");
          
          // For testing without Telegram, show auth modal
          this.showAuthModal();
        }
        
        // Load initial data
        await this.loadInitialData();
        
        // Make app instance globally available
        window.hyperApp = this;
      }
      
      async checkAuthState() {
        // Check if we have a Telegram user first
        if (this.tg && this.tg.initDataUnsafe && this.tg.initDataUnsafe.user) {
          const telegramUser = this.tg.initDataUnsafe.user;
          this.userData = telegramUser;
          this.isAuthenticated = true;
          await this.syncUserWithSupabase();
          this.updateUserInfo();
          return;
        }
        
        // Check Supabase authentication as fallback
        const { data: { session }, error } = await this.supabase.auth.getSession();
        if (session && session.user) {
          this.isAuthenticated = true;
          this.userData = {
            id: session.user.id,
            email: session.user.email,
            ...session.user.user_metadata
          };
          await this.syncUserWithSupabase();
          this.updateUserInfo();
        } else {
          // Show auth modal if no authentication found
          this.showAuthModal();
        }
      }
      
      showAuthModal() {
        document.getElementById('authModal').style.display = 'block';
      }
      
      hideAuthModal() {
        document.getElementById('authModal').style.display = 'none';
      }
      
      async setupAuthListeners() {
        // Auth tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.target.getAttribute('data-tab');
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            e.target.classList.add('active');
            document.getElementById(tabName + 'Form').classList.remove('hidden');
          });
        });
        
        // Close auth modal
        document.getElementById('closeAuth').addEventListener('click', () => {
          this.hideAuthModal();
        });
        
        // Login button
        document.getElementById('loginBtn').addEventListener('click', this.handleAuthLogin);
        
        // Signup button
        document.getElementById('signupBtn').addEventListener('click', this.handleAuthSignup);
      }
      
      async handleAuthLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
          this.showNotification("Please fill all fields", "error");
          return;
        }

        // Show loading state
        const loginBtn = document.getElementById('loginBtn');
        const originalText = loginBtn.textContent;
        loginBtn.textContent = 'Logging in...';
        loginBtn.disabled = true;

        try {
          const { data, error } = await this.supabase.auth.signInWithPassword({
            email,
            password
          });

          if (error) {
            let errorMessage = error.message;
            if (error.message.includes('Invalid login credentials')) {
              errorMessage = "Account not found. Please sign up first.";
            } else if (error.message.includes('Email not confirmed')) {
              errorMessage = "Please check your email and confirm your account.";
            }
            this.showNotification(errorMessage, "error");
          } else {
            this.isAuthenticated = true;
            this.userData = {
              id: data.user.id,
              email: data.user.email,
              ...data.user.user_metadata
            };
            await this.syncUserWithSupabase();
            this.updateUserInfo();
            this.hideAuthModal();
            this.loadInitialData();
            this.showNotification("Login successful", "success");
          }
        } catch (error) {
          this.showNotification("Login failed. Please try again.", "error");
          console.error("Login error:", error);
        } finally {
          // Reset button state
          loginBtn.textContent = originalText;
          loginBtn.disabled = false;
        }
      }
      
      async handleAuthSignup() {
        const username = document.getElementById('signupUsername').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

        if (!username || !email || !password || !passwordConfirm) {
          this.showNotification("Please fill all fields", "error");
          return;
        }

        if (password !== passwordConfirm) {
          this.showNotification("Passwords don't match", "error");
          return;
        }

        if (password.length < 6) {
          this.showNotification("Password must be at least 6 characters", "error");
          return;
        }

        // Show loading state
        const signupBtn = document.getElementById('signupBtn');
        const originalText = signupBtn.textContent;
        signupBtn.textContent = 'Signing up...';
        signupBtn.disabled = true;

        try {
          const { data, error } = await this.supabase.auth.signUp({
            email,
            password,
            options: {
              data: {
                username: username,
                reputation: 0,
                language: 'en'
              }
            }
          });

          if (error) {
            let errorMessage = error.message;
            if (error.message.includes('User already registered')) {
              errorMessage = "Account already exists. Please login instead.";
            }
            this.showNotification(errorMessage, "error");
          } else {
            this.showNotification("Signup successful! Please check your email for verification.", "success");
            // Switch to login tab
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            document.querySelector('[data-tab="login"]').classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
          }
        } catch (error) {
          this.showNotification("Signup failed. Please try again.", "error");
          console.error("Signup error:", error);
        } finally {
          // Reset button state
          signupBtn.textContent = originalText;
          signupBtn.disabled = false;
        }
      }

      async handleLogout() {
        try {
          const { error } = await this.supabase.auth.signOut();

          if (error) {
            this.showNotification("Logout failed", "error");
            console.error("Logout error:", error);
          } else {
            // Reset app state
            this.isAuthenticated = false;
            this.userData = null;
            this.userReports = [];
            this.nearbyReports = [];

            // Update UI
            this.updateUserInfo();
            this.showAuthModal();
            this.loadInitialData();

            this.showNotification("Logged out successfully", "success");
          }
        } catch (error) {
          this.showNotification("Logout failed", "error");
          console.error("Logout error:", error);
        }
      }
      
      async syncUserWithSupabase() {
        if (!this.userData) {
          console.error("No userData available for sync");
          return false;
        }

        console.log("Syncing user with Supabase:", this.userData.id);

        try {
          // Check if user exists in users table
          const { data, error } = await this.supabase
            .from('users')
            .select('*')
            .eq('user_id', this.userData.id)
            .maybeSingle();

          if (error) {
            console.error("Error checking user in database:", error);
            console.error("Check error details:", JSON.stringify(error, null, 2));
            return false;
          } else if (data) {
            // Update user data with Supabase info
            console.log("User found in database:", data);
            this.userData.reputation = data.reputation || 0;
            this.userData.language = data.language || 'en';
            this.currentLanguage = data.language || 'en';
            this.applyLanguage(this.currentLanguage);

            // Update language selector
            document.getElementById('languageSelect').value = this.currentLanguage;
            document.getElementById('currentLanguage').textContent = this.currentLanguage === 'en' ? 'EN' : 'AR';

            return true;
          } else {
            // User doesn't exist in users table, create a new record
            console.log("User not found in users table, creating new record");
            const { data: newUser, error: insertError } = await this.supabase
              .from('users')
              .insert([
                {
                  user_id: this.userData.id,
                  username: this.userData.username || this.userData.first_name || 'User',
                  reputation: 0,
                  language: 'en'
                }
              ])
              .select()
              .single();

            if (insertError) {
              console.error("Error creating user in database:", insertError);
              console.error("Insert error details:", JSON.stringify(insertError, null, 2));
              return false;
            }

            console.log("User created successfully:", newUser);
            this.userData.reputation = 0;
            this.userData.language = 'en';
            return true;
          }
        } catch (error) {
          console.error("Error syncing user with Supabase:", error);
          console.error("Sync error details:", JSON.stringify(error, null, 2));
          return false;
        }
      }
      
      updateConnectionStatus(connected) {
        this.isConnected = connected;
        const statusElement = document.getElementById('connectionStatus');
        
        if (statusElement) {
          if (connected) {
            statusElement.innerHTML = '<i class="fas fa-check-circle connected"></i> <span data-en="Connected" data-ar="متصل">Connected</span>';
            statusElement.classList.add('connected');
            statusElement.classList.remove('disconnected');
          } else {
            statusElement.innerHTML = '<i class="fas fa-times-circle disconnected"></i> <span data-en="Disconnected" data-ar="غير متصل">Disconnected</span>';
            statusElement.classList.add('disconnected');
            statusElement.classList.remove('connected');
          }
        }
      }
      
      updateUserInfo() {
        if (this.userData) {
          const usernameElement = document.getElementById('settingsUsername');
          if (usernameElement) {
            usernameElement.textContent = this.userData.username || this.userData.first_name;
          }
          
          document.getElementById('userReputation').textContent = this.userData.reputation || 0;
          document.getElementById('settingsReputation').textContent = this.userData.reputation || 0;
        }
      }
      
      async loadInitialData() {
        await this.loadNearbyReports();
        if (this.isAuthenticated) {
          await this.loadUserReports();
        }
        this.loadMap();
      }
      
      async loadNearbyReports(retryCount = 0) {
        const maxRetries = 2;

        try {
          document.getElementById('nearbyReports').innerHTML = '<div class="loading-spinner"></div>';

          const { data: reports, error } = await this.supabase
            .from('reports')
            .select(`id, vibe_type, location, notes, created_at, upvotes, downvotes, latitude, longitude, votes (user_id, vote_type)`)
            .order('created_at', { ascending: false })
            .limit(20);

          if (error) {
            console.error("Error loading reports:", error);

            // Retry on network errors
            if (retryCount < maxRetries && (error.message.includes('network') || error.message.includes('fetch'))) {
              console.log(`Retrying loadNearbyReports (${retryCount + 1}/${maxRetries})...`);
              setTimeout(() => this.loadNearbyReports(retryCount + 1), 1000);
              return;
            }

            document.getElementById('nearbyReports').innerHTML =
              '<div class="no-data" data-en="Error loading reports. Please try again." data-ar="خطأ في تحميل التقارير. يرجى المحاولة مرة أخرى.">Error loading reports. Please try again.</div>';
            return;
          }

          this.nearbyReports = reports.map(report => {
            const userVote = report.votes && report.votes.length > 0 ?
              report.votes.find(v => v.user_id === this.userData?.id)?.vote_type : null;

            return { ...report, user_vote: userVote };
          });

          this.displayNearbyReports();
        } catch (error) {
          console.error("Error loading nearby reports:", error);

          if (retryCount < maxRetries) {
            console.log(`Retrying loadNearbyReports (${retryCount + 1}/${maxRetries})...`);
            setTimeout(() => this.loadNearbyReports(retryCount + 1), 1000);
            return;
          }

          document.getElementById('nearbyReports').innerHTML =
            '<div class="no-data" data-en="Error loading reports. Please try again." data-ar="خطأ في تحميل التقارير. يرجى المحاولة مرة أخرى.">Error loading reports. Please try again.</div>';
        }
      }
      
      displayNearbyReports() {
        const container = document.getElementById('nearbyReports');

        if (!this.nearbyReports || this.nearbyReports.length === 0) {
          container.innerHTML = '<div class="no-data" data-en="No reports nearby" data-ar="لا توجد تقارير قريبة">No reports nearby</div>';
          this.updateTextDirection();
          return;
        }

        container.innerHTML = this.nearbyReports.map(report => `
          <div class="report-item" data-id="${report.id}">
            <div class="report-info">
              <div class="report-type">
                <i class="${this.getVibeIcon(report.vibe_type)}"></i>
                <span data-en="${this.capitalizeFirstLetter(report.vibe_type)}" data-ar="${this.getVibeArabicName(report.vibe_type)}">
                  ${this.capitalizeFirstLetter(report.vibe_type)}
                </span>
              </div>
              <div class="report-details">${report.notes || ''}</div>
              <div class="report-meta">
                <span>${report.location || 'Unknown location'}</span>
                <span>${this.formatTimeAgo(report.created_at)}</span>
              </div>
            </div>
            <div class="report-actions">
              <button class="vote-btn upvote-btn ${report.user_vote === 'upvote' ? 'active' : ''}" data-report-id="${report.id}" data-vote-type="upvote" ${!this.isAuthenticated ? 'aria-disabled="true" title="Login to vote"' : ''}>
                <i class="fas fa-thumbs-up"></i> ${report.upvotes || 0}
              </button>
              <button class="vote-btn downvote-btn ${report.user_vote === 'downvote' ? 'active' : ''}" data-report-id="${report.id}" data-vote-type="downvote" ${!this.isAuthenticated ? 'aria-disabled="true" title="Login to vote"' : ''}>
                <i class="fas fa-thumbs-down"></i> ${report.downvotes || 0}
              </button>
            </div>
          </div>
        `).join('');

        // Vote buttons are handled by delegated event listener in setupEventListeners()

        this.updateTextDirection();
      }
      
      async loadUserReports() {
        if (!this.userData) return;
        
        try {
          document.getElementById('userReports').innerHTML = '<div class="loading-spinner"></div>';
          
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select('*')
            .eq('user_id', this.userData.id)
            .order('created_at', { ascending: false });
          
          if (error) {
            console.error("Error loading user reports:", error);
            document.getElementById('userReports').innerHTML = 
              '<div class="no-data" data-en="Error loading your reports" data-ar="خطأ في تحميل تقاريرك">Error loading your reports</div>';
            return;
          }
          
          this.userReports = reports;
          this.displayUserReports();
        } catch (error) {
          console.error("Error loading user reports:", error);
          document.getElementById('userReports').innerHTML = 
            '<div class="no-data" data-en="Error loading your reports" data-ar="خطأ في تحميل تقاريرك">Error loading your reports</div>';
        }
      }
      
      displayUserReports() {
        const container = document.getElementById('userReports');
        
        if (!this.userReports || this.userReports.length === 0) {
          container.innerHTML = '<div class="no-data" data-en="You haven\'t submitted any reports" data-ar="لم تقم بإرسال أي تقارير">You haven\'t submitted any reports</div>';
          this.updateTextDirection();
          return;
        }
        
        container.innerHTML = this.userReports.map(report => `
          <div class="report-item">
            <div class="report-info">
              <div class="report-type">
                <i class="${this.getVibeIcon(report.vibe_type)}"></i>
                <span data-en="${this.capitalizeFirstLetter(report.vibe_type)}" data-ar="${this.getVibeArabicName(report.vibe_type)}">
                  ${this.capitalizeFirstLetter(report.vibe_type)}
                </span>
              </div>
              <div class="report-details">${report.notes || ''}</div>
              <div class="report-meta">
                <span>${report.location || 'Unknown location'}</span>
                <span>${this.formatTimeAgo(report.created_at)}</span>
                <span>👍 ${report.upvotes || 0} 👎 ${report.downvotes || 0}</span>
              </div>
            </div>
          </div>
        `).join('');
        
        this.updateTextDirection();
      }
      
      async voteReport(reportId, voteType) {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to vote", "error");
          return;
        }

        try {
          // Get current session to ensure we're authenticated
          const { data: sessionData, error: sessionError } = await this.supabase.auth.getSession();

          if (sessionError || !sessionData.session) {
            this.showNotification("Authentication expired. Please login again.", "error");
            this.showAuthModal();
            return;
          }

          // Use the authenticated user ID from the session
          const authUserId = sessionData.session.user.id;

          const { data: existingVote, error: voteError } = await this.supabase
            .from('votes')
            .select('*')
            .eq('user_id', authUserId)
            .eq('report_id', reportId)
            .maybeSingle();

          if (voteError && voteError.code !== 'PGRST116') {
            console.error("Error checking vote:", voteError);
            this.showNotification("Failed to submit vote", "error");
            return;
          }

          let operation;

          if (existingVote) {
            if (existingVote.vote_type === voteType) {
              const { error: deleteError } = await this.supabase
                .from('votes')
                .delete()
                .eq('id', existingVote.id);

              if (deleteError) {
                console.error("Error removing vote:", deleteError);
                this.showNotification("Failed to update vote", "error");
                return;
              }

              operation = 'remove';
            } else {
              const { error: updateError } = await this.supabase
                .from('votes')
                .update({ vote_type: voteType })
                .eq('id', existingVote.id);

              if (updateError) {
                console.error("Error updating vote:", updateError);
                this.showNotification("Failed to update vote", "error");
                return;
              }

              operation = 'change';
            }
          } else {
            const { error: insertError } = await this.supabase
              .from('votes')
              .insert([
                {
                  user_id: authUserId,
                  report_id: reportId,
                  vote_type: voteType
                }
              ]);

            if (insertError) {
              console.error("Error inserting vote:", insertError);
              this.showNotification("Failed to submit vote", "error");
              return;
            }

            operation = 'add';
          }

      // Update UI locally for immediate feedback
      this.updateVoteUI(reportId, voteType, operation);
      this.showNotification("Vote recorded", "success");
        } catch (error) {
          console.error("Error voting on report:", error);
          this.showNotification("Failed to submit vote", "error");
        }
      }

      updateVoteUI(reportId, voteType, operation) {
        // Find the report item in the DOM
        const reportItem = document.querySelector(`.report-item[data-id="${reportId}"]`);
        if (!reportItem) return;

        // Find the vote buttons
        const upvoteBtn = reportItem.querySelector('.upvote-btn');
        const downvoteBtn = reportItem.querySelector('.downvote-btn');

        if (!upvoteBtn || !downvoteBtn) return;

        // Get current vote counts from the buttons
        let upvotes = parseInt(upvoteBtn.textContent.match(/\d+/)[0]) || 0;
        let downvotes = parseInt(downvoteBtn.textContent.match(/\d+/)[0]) || 0;

        // Update vote counts based on operation
        if (operation === 'add') {
          if (voteType === 'upvote') {
            upvotes++;
            upvoteBtn.classList.add('active');
            downvoteBtn.classList.remove('active');
          } else if (voteType === 'downvote') {
            downvotes++;
            downvoteBtn.classList.add('active');
            upvoteBtn.classList.remove('active');
          }
        } else if (operation === 'change') {
          if (voteType === 'upvote') {
            upvotes++;
            downvotes--;
            upvoteBtn.classList.add('active');
            downvoteBtn.classList.remove('active');
          } else if (voteType === 'downvote') {
            downvotes++;
            upvotes--;
            downvoteBtn.classList.add('active');
            upvoteBtn.classList.remove('active');
          }
        } else if (operation === 'remove') {
          if (voteType === 'upvote') {
            upvotes--;
            upvoteBtn.classList.remove('active');
          } else if (voteType === 'downvote') {
            downvotes--;
            downvoteBtn.classList.remove('active');
          }
        }

        // Update button text with new counts
        upvoteBtn.innerHTML = `<i class="fas fa-thumbs-up"></i> ${upvotes}`;
        downvoteBtn.innerHTML = `<i class="fas fa-thumbs-down"></i> ${downvotes}`;

        // Update local data for consistency
        const reportIndex = this.nearbyReports.findIndex(r => r.id == reportId);
        if (reportIndex !== -1) {
          this.nearbyReports[reportIndex].upvotes = upvotes;
          this.nearbyReports[reportIndex].downvotes = downvotes;
          this.nearbyReports[reportIndex].user_vote = operation === 'remove' ? null : voteType;
        }
      }
      }

      showReportModal() {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to submit reports", "error");
          return;
        }

        this.selectedVibe = null;
        document.querySelectorAll('.vibe-option').forEach(option => {
          option.classList.remove('selected');
        });

        // Auto-fill location with current position
        this.getCurrentLocation((location) => {
          document.getElementById('reportLocation').value = location;
        });

        document.getElementById('reportNotes').value = '';
        document.getElementById('reportModal').style.display = 'block';
      }
      
      selectVibe(vibe) {
        this.selectedVibe = vibe;
        document.querySelectorAll('.vibe-option').forEach(option => {
          option.classList.remove('selected');
        });
        document.querySelector(`.vibe-option[data-vibe="${vibe}"]`).classList.add('selected');
      }
      
      async submitReport() {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to submit reports", "error");
          return;
        }

        if (!this.selectedVibe) {
          this.showNotification("Please select a vibe type", "error");
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitReportBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        submitBtn.disabled = true;

        try {
          // Ensure user is synced with database before submitting
          const synced = await this.syncUserWithSupabase();
          if (!synced) {
            this.showNotification("Account sync failed. Please try logging out and back in.", "error");
            return;
          }

          const location = document.getElementById('reportLocation').value;
          const notes = document.getElementById('reportNotes').value;

          // Prepare report data with coordinates if available
          const reportData = {
            user_id: this.userData.id,
            vibe_type: this.selectedVibe,
            location: location || null,
            notes: notes || null
          };

          // Add coordinates if available
          if (this.userLocation) {
            reportData.latitude = this.userLocation.latitude;
            reportData.longitude = this.userLocation.longitude;
          }

          console.log("Submitting report:", reportData);

          const { data, error } = await this.supabase
            .from('reports')
            .insert([reportData])
            .select();

          if (error) {
            console.error("Error submitting report:", error);
            let errorMessage = "Failed to submit report";
            if (error.message.includes('foreign key constraint')) {
              errorMessage = "User account issue. Please try logging out and back in.";
            } else if (error.message.includes('row-level security')) {
              errorMessage = "Permission denied. Please contact support.";
            } else if (error.message.includes('network') || error.message.includes('fetch')) {
              errorMessage = "Network error. Please check your connection and try again.";
            } else {
              errorMessage = `Failed to submit report: ${error.message}`;
            }
            this.showNotification(errorMessage, "error");
          } else {
            console.log("Report submitted successfully:", data);
            this.showNotification("Report submitted successfully", "success");
            this.closeModal('reportModal');
            // Reload data to show the new report
            await this.loadNearbyReports();
            if (this.isAuthenticated) {
              await this.loadUserReports();
            }
            // Refresh map to show new report
            this.loadMap();
          }
        } catch (error) {
          console.error("Error submitting report:", error);
          let errorMessage = "Failed to submit report";
          if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = "Network error. Please check your connection and try again.";
          }
          this.showNotification(errorMessage, "error");
        } finally {
          // Reset button state
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }
      
      showEmergencyReport() {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to submit emergency reports", "error");
          return;
        }

        // Auto-fill location with current position
        this.getCurrentLocation((location) => {
          document.getElementById('emergencyLocation').value = location;
        });

        document.getElementById('emergencyDetails').value = '';
        document.getElementById('emergencyModal').style.display = 'block';
      }
      
      async submitEmergencyReport() {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to submit emergency reports", "error");
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitEmergencyBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        submitBtn.disabled = true;

        try {
          const emergencyType = document.getElementById('emergencyType').value;
          const location = document.getElementById('emergencyLocation').value;
          const details = document.getElementById('emergencyDetails').value;

          if (!location || !details) {
            this.showNotification("Please fill all required fields", "error");
            return;
          }

          // Ensure user is synced with database before submitting
          const synced = await this.syncUserWithSupabase();
          if (!synced) {
            this.showNotification("Account sync failed. Please try logging out and back in.", "error");
            return;
          }

          // Get current session to ensure we're authenticated
          const { data: sessionData, error: sessionError } = await this.supabase.auth.getSession();

          if (sessionError || !sessionData.session) {
            this.showNotification("Authentication expired. Please login again.", "error");
            this.showAuthModal();
            return;
          }

          console.log("Submitting emergency report:", {
            user_id: this.userData.id,
            auth_user_id: sessionData.session.user.id,
            vibe_type: 'dangerous',
            location: location,
            notes: `EMERGENCY (${emergencyType}): ${details}`
          });

          // Use the authenticated user ID from the session
          const authUserId = sessionData.session.user.id;

          const { data, error } = await this.supabase
            .from('reports')
            .insert([
              {
                user_id: authUserId,
                vibe_type: 'dangerous',
                location: location,
                notes: `EMERGENCY (${emergencyType}): ${details}`
              }
            ])
            .select();

          if (error) {
            console.error("Error submitting emergency report:", error);
            let errorMessage = "Failed to submit emergency report";
            if (error.message.includes('foreign key constraint')) {
              errorMessage = "User account issue. Please try logging out and back in.";
            } else if (error.message.includes('row-level security')) {
              errorMessage = "Permission denied. Please contact support.";
            } else if (error.message.includes('network') || error.message.includes('fetch')) {
              errorMessage = "Network error. Please check your connection and try again.";
            } else {
              errorMessage = `Failed to submit emergency report: ${error.message}`;
            }
            this.showNotification(errorMessage, "error");
          } else {
            console.log("Emergency report submitted successfully:", data);
            this.showNotification("Emergency report submitted successfully", "success");
            this.closeModal('emergencyModal');
            // Reload data to show the new emergency report
            await this.loadNearbyReports();
            if (this.isAuthenticated) {
              await this.loadUserReports();
            }
            // Refresh map to show new emergency report
            this.loadMap();
          }
        } catch (error) {
          console.error("Error submitting emergency report:", error);
          let errorMessage = "Failed to submit emergency report";
          if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = "Network error. Please check your connection and try again.";
          }
          this.showNotification(errorMessage, "error");
        } finally {
          // Reset button state
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }
      
      showView(viewId) {
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        document.getElementById(viewId + 'View').classList.add('active');
        document.querySelector(`.nav-btn[data-view="${viewId}"]`).classList.add('active');

        if (viewId === 'map') {
          this.loadMap();
        } else if (viewId === 'reports') {
          this.loadUserReports();
        } else if (viewId === 'settings') {
          // Attach logout button event listener when settings view is shown
          const logoutBtn = document.getElementById('logoutBtn');
          if (logoutBtn) {
            logoutBtn.addEventListener('click', this.handleLogout);
          }
        }
      }
      
      loadMap() {
        const mapContainer = document.getElementById('mapContainer');
        const hasReports = this.nearbyReports && this.nearbyReports.length > 0;

        // Clear any existing map
        if (this.map) {
          this.map.remove();
          this.map = null;
        }

        mapContainer.innerHTML = `
          <div class="map-header">
            <h3 data-en="Community Vibe Map" data-ar="خريطة حالة المجتمع">Community Vibe Map</h3>
            <p data-en="${hasReports ? 'Showing recent reports in your area' : 'Map of your area - submit reports to see them here'}" data-ar="${hasReports ? 'عرض التقارير الحديثة في منطقتك' : 'خريطة منطقتك - أرسل التقارير لرؤيتها هنا'}">
              ${hasReports ? 'Showing recent reports in your area' : 'Map of your area - submit reports to see them here'}
            </p>
          </div>
          <div id="leaflet-map" style="height: 320px; width: 100%; position: relative;"></div>
          <div class="map-controls">
            <button id="myLocationBtn" class="map-control-btn" title="Go to my location">
              <i class="fas fa-crosshairs"></i>
            </button>
          </div>
          <div class="map-legend">
            <div class="legend-item"><i class="fas fa-users" style="color: orange;"></i> <span data-en="Crowded" data-ar="مزدحم">Crowded</span></div>
            <div class="legend-item"><i class="fas fa-volume-up" style="color: var(--secondary);"></i> <span data-en="Noisy" data-ar="صاخب">Noisy</span></div>
            <div class="legend-item"><i class="fas fa-glass-cheers" style="color: var(--success);"></i> <span data-en="Festive" data-ar="احتفالي">Festive</span></div>
            <div class="legend-item"><i class="fas fa-peace" style="color: var(--info);"></i> <span data-en="Calm" data-ar="هادئ">Calm</span></div>
            <div class="legend-item"><i class="fas fa-eye-slash" style="color: var(--warning);"></i> <span data-en="Suspicious" data-ar="مشبوه">Suspicious</span></div>
            <div class="legend-item"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> <span data-en="Dangerous" data-ar="خطير">Dangerous</span></div>
          </div>
        `;

        // Initialize Leaflet map
        this.initializeLeafletMap();

        this.updateTextDirection();
      }

      initializeLeafletMap() {
        const mapElement = document.getElementById('leaflet-map');
        if (!mapElement) return;

        // Default center (can be user's location if available)
        let initialCenter = [30.0444, 31.2357]; // Cairo, Egypt as default
        let initialZoom = 10;

        // If we already have user location, use it
        if (this.userLocation) {
          initialCenter = [this.userLocation.latitude, this.userLocation.longitude];
          initialZoom = 13;
        }

        // Create map
        this.map = L.map('leaflet-map').setView(initialCenter, initialZoom);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19,
        }).addTo(this.map);

        // Add markers for reports
        this.addReportMarkers();

        // Try to get user's location for better centering if not already available
        if (navigator.geolocation && !this.userLocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              this.userLocation = { latitude, longitude };
              this.map.setView([latitude, longitude], 13);
            },
            (error) => {
              console.log('Geolocation not available or denied');
            },
            { timeout: 10000, enableHighAccuracy: true }
          );
        }

        // Add event listener for My Location button
        const myLocationBtn = document.getElementById('myLocationBtn');
        if (myLocationBtn) {
          myLocationBtn.addEventListener('click', () => {
            this.centerMapOnUserLocation();
          });
        }
      }

      async centerMapOnUserLocation() {
        if (!navigator.geolocation) {
          this.showNotification("Geolocation is not supported by this browser", "error");
          return;
        }

        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              timeout: 10000,
              enableHighAccuracy: true
            });
          });

          const { latitude, longitude } = position.coords;
          this.userLocation = { latitude, longitude };

          if (this.map) {
            this.map.setView([latitude, longitude], 15);
            this.showNotification("Centered on your location", "success");
          }
        } catch (error) {
          console.error('Error getting location:', error);
          let errorMessage = "Unable to get your location";
          if (error.code === 1) {
            errorMessage = "Location access denied. Please enable location permissions.";
          } else if (error.code === 2) {
            errorMessage = "Location unavailable. Please check your GPS settings.";
          } else if (error.code === 3) {
            errorMessage = "Location request timed out. Please try again.";
          }
          this.showNotification(errorMessage, "error");
        }
      }

      addReportMarkers() {
        if (!this.map || !this.nearbyReports) return;

        // Clear existing markers
        this.map.eachLayer((layer) => {
          if (layer instanceof L.Marker) {
            this.map.removeLayer(layer);
          }
        });

        // Add markers for each report
        this.nearbyReports.forEach(report => {
          // Use actual coordinates if available, otherwise use default location with slight randomization
          let lat, lng;
          if (report.latitude && report.longitude) {
            lat = report.latitude;
            lng = report.longitude;
          } else {
            // Default to Cairo area with some randomization
            const baseLat = 30.0444;
            const baseLng = 31.2357;
            lat = baseLat + (Math.random() - 0.5) * 0.1;
            lng = baseLng + (Math.random() - 0.5) * 0.1;
          }

          // Create custom icon based on vibe type
          const iconHtml = `<div style="
            background: ${this.getVibeColor(report.vibe_type)};
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          ">
            <i class="${this.getVibeIcon(report.vibe_type)}" style="color: white; font-size: 12px;"></i>
          </div>`;

          const customIcon = L.divIcon({
            html: iconHtml,
            className: 'custom-marker',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });

          // Create marker
          const marker = L.marker([lat, lng], { icon: customIcon }).addTo(this.map);

          // Add popup with report details
          const popupContent = `
            <div style="font-family: 'Segoe UI', sans-serif; max-width: 200px;">
              <h4 style="margin: 0 0 8px 0; color: ${this.getVibeColor(report.vibe_type)};">
                ${this.capitalizeFirstLetter(report.vibe_type)}
              </h4>
              <p style="margin: 4px 0;"><strong>Location:</strong> ${report.location || 'Unknown'}</p>
              ${report.notes ? `<p style="margin: 4px 0;"><strong>Notes:</strong> ${report.notes}</p>` : ''}
              <p style="margin: 4px 0; font-size: 12px; color: #666;">
                ${this.formatTimeAgo(report.created_at)}
              </p>
              <div style="margin-top: 8px;">
                <span style="color: #28a745;">👍 ${report.upvotes || 0}</span>
                <span style="color: #dc3545; margin-left: 8px;">👎 ${report.downvotes || 0}</span>
              </div>
            </div>
          `;

          marker.bindPopup(popupContent);
        });
      }

      getVibeColor(vibeType) {
        const colors = {
          crowded: '#FFA500',
          noisy: '#FF6B35',
          festive: '#28A745',
          calm: '#17A2B8',
          suspicious: '#FFC107',
          dangerous: '#DC3545'
        };
        return colors[vibeType] || '#6C757D';
      }
      
      displayMap() {
        // This will be called when the map view is shown
        this.loadMap();
      }
      
      async loadTopAreas() {
        try {
          // Show loading modal
          const modalContent = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 data-en="Top Areas" data-ar="أهم المناطق">Top Areas</h2>
                <span class="close" data-dismiss="topAreasModal">&times;</span>
              </div>
              <div class="modal-body">
                <div class="loading-spinner"></div>
                <p data-en="Analyzing community reports..." data-ar="تحليل تقارير المجتمع...">Analyzing community reports...</p>
              </div>
            </div>
          `;

          let modal = document.getElementById('topAreasModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'topAreasModal';
            modal.className = 'modal';
            document.body.appendChild(modal);
          }
          modal.innerHTML = modalContent;
          modal.style.display = 'block';

          // Fetch reports with location data
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select('location, vibe_type, latitude, longitude')
            .not('location', 'is', null)
            .not('location', 'eq', 'Unknown Location')
            .not('location', 'eq', 'Location unavailable')
            .not('location', 'eq', 'Location not supported')
            .order('created_at', { ascending: false })
            .limit(100);

          if (error) {
            console.error("Error loading reports for top areas:", error);
            modal.innerHTML = `
              <div class="modal-content">
                <div class="modal-header">
                  <h2 data-en="Top Areas" data-ar="أهم المناطق">Top Areas</h2>
                  <span class="close" data-dismiss="topAreasModal">&times;</span>
                </div>
                <div class="modal-body">
                  <p data-en="Error loading top areas data" data-ar="خطأ في تحميل بيانات أهم المناطق">Error loading top areas data</p>
                </div>
              </div>
            `;
            return;
          }

          // Analyze the data
          const areaStats = {};

          reports.forEach(report => {
            const location = report.location || 'Unknown';
            if (!areaStats[location]) {
              areaStats[location] = {
                total: 0,
                vibes: {},
                coordinates: report.latitude && report.longitude ? [report.latitude, report.longitude] : null
              };
            }

            areaStats[location].total++;
            if (!areaStats[location].vibes[report.vibe_type]) {
              areaStats[location].vibes[report.vibe_type] = 0;
            }
            areaStats[location].vibes[report.vibe_type]++;
          });

          // Convert to array and sort by total reports
          const topAreas = Object.entries(areaStats)
            .map(([location, data]) => ({ location, ...data }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 10);

          // Generate the modal content
          const areasHtml = topAreas.length > 0 ? topAreas.map((area, index) => `
            <div class="area-item">
              <div class="area-header">
                <div class="area-rank">#${index + 1}</div>
                <div class="area-info">
                  <h3>${area.location}</h3>
                  <span class="area-count">${area.total} report${area.total > 1 ? 's' : ''}</span>
                </div>
              </div>
              <div class="area-vibes">
                ${Object.entries(area.vibes)
                  .sort(([,a], [,b]) => b - a)
                  .map(([vibe, count]) => `
                    <span class="vibe-tag vibe-${vibe}">
                      <i class="${this.getVibeIcon(vibe)}"></i>
                      ${this.capitalizeFirstLetter(vibe)}: ${count}
                    </span>
                  `).join('')}
              </div>
            </div>
          `).join('') : `
            <p data-en="No area data available yet. Submit more reports to see top areas!" data-ar="لا توجد بيانات متاحة بعد. أرسل المزيد من التقارير لرؤية أهم المناطق!">
              No area data available yet. Submit more reports to see top areas!
            </p>
          `;

          modal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 data-en="Top Areas" data-ar="أهم المناطق">Top Areas</h2>
                <span class="close" data-dismiss="topAreasModal">&times;</span>
              </div>
              <div class="modal-body">
                <p data-en="Areas with the most community safety reports" data-ar="المناطق التي تحتوي على أكبر عدد من تقارير السلامة المجتمعية">
                  Areas with the most community safety reports
                </p>
                <div class="top-areas-list">
                  ${areasHtml}
                </div>
              </div>
            </div>
          `;

          // Attach close button event listener
          const closeBtn = modal.querySelector('.close');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              this.closeModal('topAreasModal');
            });
          }

          this.updateTextDirection();

        } catch (error) {
          console.error("Error loading top areas:", error);
          this.showNotification("Failed to load top areas", "error");
        }
      }
      
      toggleLanguage() {
        this.currentLanguage = this.currentLanguage === 'en' ? 'ar' : 'en';
        document.getElementById('currentLanguage').textContent = this.currentLanguage.toUpperCase();
        this.applyLanguage(this.currentLanguage);
        
        // Save language preference if user is authenticated
        if (this.isAuthenticated) {
          this.supabase
            .from('users')
            .update({ language: this.currentLanguage })
            .eq('user_id', this.userData.id)
            .then(({ error }) => {
              if (error) {
                console.error("Error updating language preference:", error);
              }
            });
        }
      }
      
      changeLanguage(lang) {
        this.currentLanguage = lang;
        document.getElementById('currentLanguage').textContent = this.currentLanguage.toUpperCase();
        this.applyLanguage(this.currentLanguage);
        
        // Save language preference if user is authenticated
        if (this.isAuthenticated) {
          this.supabase
            .from('users')
            .update({ language: this.currentLanguage })
            .eq('user_id', this.userData.id)
            .then(({ error }) => {
              if (error) {
                console.error("Error updating language preference:", error);
              }
            });
        }
      }
      
      applyLanguage(lang) {
        document.querySelectorAll('[data-en]').forEach(element => {
          if (element.getAttribute('data-' + lang)) {
            element.textContent = element.getAttribute('data-' + lang);
          }
        });
        
        this.updateTextDirection();
      }
      
      updateTextDirection() {
        document.body.setAttribute('dir', this.currentLanguage === 'ar' ? 'rtl' : 'ltr');
      }
      
      showNotification(message, type = 'info') {
        // Remove any existing notification
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
          existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        // Add icon based on notification type
        let icon = 'fas fa-info-circle';
        if (type === 'success') icon = 'fas fa-check-circle';
        if (type === 'error') icon = 'fas fa-exclamation-circle';
        if (type === 'warning') icon = 'fas fa-exclamation-triangle';
        
        notification.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 3000);
      }
      
      closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
      }
      
      getVibeIcon(vibeType) {
        const icons = {
          crowded: 'fas fa-users',
          noisy: 'fas fa-volume-up',
          festive: 'fas fa-glass-cheers',
          calm: 'fas fa-peace',
          suspicious: 'fas fa-eye-slash',
          dangerous: 'fas fa-exclamation-triangle'
        };
        
        return icons[vibeType] || 'fas fa-question-circle';
      }
      
      getVibeArabicName(vibeType) {
        const names = {
          crowded: 'مزدحم',
          noisy: 'صاخب',
          festive: 'احتفالي',
          calm: 'هادئ',
          suspicious: 'مشبوه',
          dangerous: 'خطير'
        };
        
        return names[vibeType] || vibeType;
      }
      
      capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
      
      formatTimeAgo(timestamp) {
        const now = new Date();
        const time = new Date(timestamp);
        const diffInSeconds = Math.floor((now - time) / 1000);
        
        if (diffInSeconds < 60) {
          return this.currentLanguage === 'en' ? 'Just now' : 'الآن';
        }
        
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
          return this.currentLanguage === 'en' 
            ? `${diffInMinutes} min ago` 
            : `منذ ${diffInMinutes} دقيقة`;
        }
        
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          return this.currentLanguage === 'en' 
            ? `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago` 
            : `منذ ${diffInHours} ساعة`;
        }
        
        const diffInDays = Math.floor(diffInHours / 24);
        return this.currentLanguage === 'en' 
          ? `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago` 
          : `منذ ${diffInDays} يوم`;
      }
      
      getCurrentLocation(callback) {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              this.userLocation = { latitude, longitude };

              // Try to get address from coordinates (reverse geocoding)
              this.getAddressFromCoordinates(latitude, longitude, (address) => {
                callback(address || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
              });
            },
            (error) => {
              console.log('Geolocation error:', error);
              callback('Location unavailable');
            },
            { timeout: 10000, enableHighAccuracy: true }
          );
        } else {
          callback('Location not supported');
        }
      }

      getAddressFromCoordinates(lat, lng, callback) {
        // Use Nominatim (OpenStreetMap) for reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1`)
          .then(response => response.json())
          .then(data => {
            if (data && data.display_name) {
              // Extract a simplified address
              const address = data.display_name.split(',')[0] + ', ' + data.display_name.split(',')[1];
              callback(address.trim());
            } else {
              callback(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            }
          })
          .catch(error => {
            console.log('Reverse geocoding error:', error);
            callback(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
          });
      }

      requestUserLocation() {
        if (this.tg && this.tg.showPopup && this.tg.isLocationRequested) {
          try {
            this.tg.showPopup({
              title: "Location Access",
              message: "HyperApp needs your location to show nearby reports and map features.",
              buttons: [{ type: "ok", text: "Allow" }, { type: "cancel", text: "Deny" }]
            }, async (buttonId) => {
              if (buttonId === "ok") {
                this.tg.requestLocation();
              }
            });
          } catch (e) {
            console.log("Location request not available in this Telegram version");
          }
        }
      }
      
      setupEventListeners() {
        // Navigation buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const view = e.currentTarget.getAttribute('data-view');
            this.showView(view);
          });
        });
        
        // Language switcher
        const languageSwitcher = document.getElementById('languageSwitcher');
        if (languageSwitcher) {
          languageSwitcher.addEventListener('click', this.toggleLanguage);
        }
        
        // Refresh button
        const refreshBtn = document.getElementById('refreshReports');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', this.loadNearbyReports);
        }
        
        // Quick action buttons
        document.querySelectorAll('.action-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = e.currentTarget.getAttribute('data-action');
            if (action === 'report') {
              this.showReportModal();
            } else if (action === 'areas') {
              this.loadTopAreas();
            } else if (action === 'emergency') {
              this.showEmergencyReport();
            }
          });
        });
        
        // Vibe option buttons
        document.querySelectorAll('.vibe-option').forEach(option => {
          option.addEventListener('click', (e) => {
            const vibe = e.currentTarget.getAttribute('data-vibe');
            this.selectVibe(vibe);
          });
        });
        
        // Modal close buttons
        document.querySelectorAll('.close').forEach(closeBtn => {
          closeBtn.addEventListener('click', (e) => {
            const modalId = e.target.getAttribute('data-dismiss');
            if (modalId) {
              this.closeModal(modalId);
            }
          });
        });
        
        // Form submit buttons
        const reportSubmitBtn = document.getElementById('submitReportBtn');
        if (reportSubmitBtn) {
          reportSubmitBtn.addEventListener('click', this.submitReport);
        }
        
        const emergencySubmitBtn = document.getElementById('submitEmergencyBtn');
        if (emergencySubmitBtn) {
          emergencySubmitBtn.addEventListener('click', this.submitEmergencyReport);
        }
        
        // Language select dropdown
        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect) {
          languageSelect.addEventListener('change', (e) => {
            this.changeLanguage(e.target.value);
          });
        }

        // Logout button event delegation
        document.addEventListener('click', (e) => {
          if (e.target.id === 'logoutBtn' || e.target.closest('#logoutBtn')) {
            this.handleLogout();
          }
        });

        // Delegated vote buttons handler
        document.addEventListener('click', (e) => {
          const btn = e.target.closest('.vote-btn');
          if (!btn) return;

          e.preventDefault();

          // If user not authenticated, show auth modal and info
          if (btn.getAttribute('aria-disabled') === 'true') {
            this.showNotification("Please login to vote on reports", "info");
            this.showAuthModal();
            return;
          }

          const reportId = btn.dataset.reportId;
          const voteType = btn.dataset.voteType;
          if (reportId && voteType) {
            this.voteReport(reportId, voteType);
          }
        });

        // Map button in empty state
        document.addEventListener('click', (e) => {
          if (e.target.id === 'firstReportBtn' || e.target.closest('#firstReportBtn')) {
            this.showReportModal();
          }
        });
      }
    }

    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new HyperApp();
    });
  </script>
</body>
</html>
