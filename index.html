<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HyperApp - Community Safety Platform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --primary-light: #a5b4fc;
      --secondary: #f59e0b;
      --secondary-dark: #d97706;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #06b6d4;
      --dark-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      --card-bg: rgba(255, 255, 255, 0.03);
      --card-bg-hover: rgba(255, 255, 255, 0.06);
      --text-light: #f8fafc;
      --text-muted: #94a3b8;
      --text-subtle: #64748b;
      --border: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(255, 255, 255, 0.12);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --border-radius: 16px;
      --border-radius-sm: 12px;
      --border-radius-lg: 20px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --transition-fast: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Light theme variables */
    [data-theme="light"] {
      --primary: #1A46E0;
      --primary-dark: #1E3A8A;
      --secondary: #EA580C;
      --success: #16A34A;
      --danger: #DC2626;
      --warning: #D97706;
      --info: #0891B2;
      --dark-bg: #F8FAFC;
      --card-bg: rgba(0, 0, 0, 0.05);
      --text-light: #1E293B;
      --text-muted: #64748B;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body {
      background: var(--dark-bg);
      color: var(--text-light);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
      line-height: 1.6;
      font-weight: 400;
    }

    .container {
      max-width: 100%;
      padding: 16px;
      margin: 0 auto;
      padding-bottom: 70px;
    }

    header {
      text-align: center;
      padding: 20px 0 15px;
      position: relative;
      background: linear-gradient(135deg, var(--dark-bg) 0%, rgba(15, 23, 42, 0.95) 100%);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 12px;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
      position: relative;
      overflow: hidden;
    }

    .logo::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      animation: logoShine 3s ease-in-out infinite;
    }

    @keyframes logoShine {
      0%, 100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
      50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
    }

    .logo i {
      font-size: 28px;
      color: white;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 6px;
      background: linear-gradient(135deg, var(--text-light), var(--primary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .subtitle {
      color: var(--text-muted);
      font-size: 15px;
      margin-bottom: 24px;
      font-weight: 500;
      opacity: 0.9;
    }

    .language-switcher {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-bar {
      display: none;
    }

    .app-nav {
      display: flex;
      justify-content: space-around;
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.05) 100%);
      border-radius: var(--border-radius-lg);
      padding: 16px 8px;
      margin: 20px 16px 16px;
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      z-index: 100;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      transition: var(--transition);
    }

    .app-nav:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
      transform: translateY(-2px);
    }

    /* Filter Controls */
    .filter-controls {
      display: flex;
      gap: 8px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      color: var(--text-light);
    }

    .filter-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .filter-btn.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }

    /* Emergency Contacts */
    .emergency-contacts {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      margin: 15px 0;
    }

    .emergency-btn {
      background: rgba(220, 53, 69, 0.9);
      border: 1px solid rgba(220, 53, 69, 0.5);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      color: white;
      font-size: 14px;
      font-weight: 500;
    }

    .emergency-btn:hover {
      background: rgba(220, 53, 69, 1);
      transform: scale(1.02);
    }

    .emergency-btn i {
      display: block;
      font-size: 20px;
      margin-bottom: 4px;
    }

    /* Theme Toggle */
    .theme-toggle {
      position: absolute;
      top: 15px;
      right: 60px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .theme-toggle:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .theme-toggle i {
      color: var(--text-light);
      font-size: 16px;
    }

    /* Statistics Card */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin: 20px 0;
    }

    .stat-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
      border-radius: var(--border-radius);
      padding: 20px 16px;
      text-align: center;
      border: 1px solid rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(15px);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .stat-card:hover {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
      border-color: rgba(255, 255, 255, 0.18);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
      transform: translateY(-4px);
    }

    .stat-card:hover::before {
      opacity: 1;
    }

    .stat-number {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      line-height: 1;
      letter-spacing: -0.025em;
    }

    .stat-label {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      opacity: 0.8;
    }

    /* Offline indicator */
    .offline-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 193, 7, 0.9);
      color: #000;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      z-index: 1000;
      display: none;
    }

    .offline-indicator.online {
      background: rgba(40, 167, 69, 0.9);
      color: white;
    }

    .nav-btn {
      background: none;
      border: none;
      color: var(--text-muted);
      padding: 12px 8px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      position: relative;
      overflow: hidden;
      min-height: 50px;
    }

    .nav-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      opacity: 0;
      transition: opacity 0.3s ease;
      border-radius: 12px;
    }

    .nav-btn:hover {
      color: var(--primary);
      transform: translateY(-2px);
    }

    .nav-btn:hover::before {
      opacity: 0.1;
    }

    .nav-btn.active {
      color: white;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
      transform: translateY(-2px);
    }

    .nav-btn.active::before {
      opacity: 1;
    }

    .nav-btn i {
      font-size: 18px;
      transition: transform 0.2s ease;
      position: relative;
      z-index: 2;
    }

    .nav-btn:hover i {
      transform: scale(1.1);
    }

    .nav-btn.active i {
      transform: scale(1.1);
    }

    .nav-btn span {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.025em;
      position: relative;
      z-index: 2;
      opacity: 0.8;
    }

    .nav-btn.active span {
      opacity: 1;
    }

    .content-area {
      margin-bottom: 70px;
    }

    .view {
      display: none;
    }

    .view.active {
      display: block;
    }

    .card {
      background: linear-gradient(135deg, var(--card-bg) 0%, rgba(255, 255, 255, 0.02) 100%);
      border-radius: var(--border-radius-lg);
      padding: 28px;
      margin-bottom: 24px;
      backdrop-filter: blur(25px);
      border: 1px solid var(--border);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      transition: var(--transition);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--info));
      opacity: 0;
      transition: opacity 0.4s ease;
      border-radius: var(--border-radius-lg) var(--border-radius-lg) 0 0;
    }

    .card::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.03) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }

    .card:hover {
      background: linear-gradient(135deg, var(--card-bg-hover) 0%, rgba(255, 255, 255, 0.04) 100%);
      border-color: var(--border-hover);
      box-shadow: 0 16px 48px rgba(0, 0, 0, 0.15);
      transform: translateY(-4px);
    }

    .card:hover::before {
      opacity: 1;
    }

    .card:hover::after {
      opacity: 1;
    }

    .card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
      font-weight: 600;
      color: var(--primary);
    }

    .reports-container {
      max-height: 300px;
      overflow-y: auto;
    }

    .report-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .report-info {
      flex: 1;
    }

    .report-type {
      font-weight: 500;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .report-details {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 5px;
    }

    .report-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      gap: 10px;
    }

    .report-actions {
      display: flex;
      gap: 8px;
    }

    .vote-btn {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
      border: 2px solid rgba(255, 255, 255, 0.12);
      border-radius: 16px;
      padding: 12px 20px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-size: 15px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      backdrop-filter: blur(15px);
      position: relative;
      overflow: hidden;
      min-width: 100px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .vote-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
    }

    .vote-btn:hover:not([aria-disabled="true"])::before {
      left: 100%;
    }

    .vote-btn:hover:not([aria-disabled="true"]) {
      background: rgba(255, 255, 255, 0.12);
      border-color: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .vote-btn[aria-disabled="true"] {
      opacity: 0.4;
      cursor: not-allowed;
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.08);
    }

    .vote-btn[aria-disabled="true"]:hover {
      transform: none;
      box-shadow: none;
    }

    .upvote-btn.active {
      color: var(--success);
      background: rgba(40, 167, 69, 0.15);
      border-color: rgba(40, 167, 69, 0.3);
      box-shadow: 0 0 0 1px rgba(40, 167, 69, 0.2);
    }

    .downvote-btn.active {
      color: var(--danger);
      background: rgba(220, 53, 69, 0.15);
      border-color: rgba(220, 53, 69, 0.3);
      box-shadow: 0 0 0 1px rgba(220, 53, 69, 0.2);
    }

    .vote-btn i {
      font-size: 14px;
      transition: transform 0.2s ease;
    }

    .vote-btn:hover:not([aria-disabled="true"]) i {
      transform: scale(1.1);
    }

    .upvote-btn.active i {
      color: var(--success);
    }

    .downvote-btn.active i {
      color: var(--danger);
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 20px 0;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .action-btn:hover {
      background: rgba(45, 91, 255, 0.15);
      transform: translateY(-2px);
    }

    .action-btn i {
      font-size: 20px;
      color: var(--primary);
      margin-bottom: 5px;
      display: block;
    }

    .action-btn span {
      font-size: 13px;
      font-weight: 500;
    }

    .emergency-btn {
      background: rgba(220, 53, 69, 0.2);
      border-color: rgba(220, 53, 69, 0.3);
    }

    .emergency-btn i {
      color: var(--danger);
    }

    .btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      border-radius: var(--border-radius-sm);
      padding: 14px 24px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      letter-spacing: 0.025em;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      transform: translateY(-3px);
      box-shadow: var(--shadow-lg);
    }

    .btn:active {
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .refresh-btn {
      width: 100%;
      margin-top: 15px;
    }

    .btn-emergency {
      background: var(--danger);
      width: 100%;
    }

    .btn-emergency:hover {
      background: #c82333;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-radius: 50%;
      border-top: 3px solid var(--primary);
      animation: spin 1s linear infinite;
      margin: 40px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .map-container {
      height: 400px;
      position: relative;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 15px;
    }

    .map-visualization {
      height: 100%;
      position: relative;
    }

    .map-header {
      padding: 15px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
    }

    .map-header h3 {
      margin: 0 0 5px 0;
      color: white;
      font-size: 16px;
    }

    .map-header p {
      margin: 0;
      font-size: 12px;
      opacity: 0.8;
    }

    .map-points {
      position: absolute;
      top: 60px;
      left: 15px;
      right: 15px;
      bottom: 70px;
      padding: 0;
    }

    .map-point {
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate(-50%, -50%);
      animation: pulse 2s infinite ease-in-out;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      z-index: 5;
    }

    .map-point:hover {
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 20;
    }

    .map-point i {
      font-size: 12px;
      color: white;
    }

    .map-point[data-vibe="crowded"] { background: rgba(255, 165, 0, 0.8); }
    .map-point[data-vibe="noisy"] { background: rgba(255, 107, 53, 0.8); }
    .map-point[data-vibe="festive"] { background: rgba(40, 167, 69, 0.8); }
    .map-point[data-vibe="calm"] { background: rgba(23, 162, 184, 0.8); }
    .map-point[data-vibe="suspicious"] { background: rgba(255, 193, 7, 0.8); }
    .map-point[data-vibe="dangerous"] { background: rgba(220, 53, 69, 0.8); }

    .map-controls {
      position: absolute;
      top: 80px;
      right: 15px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .map-control-btn {
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 8px;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      color: #333;
    }

    .map-control-btn:hover {
      background: white;
      transform: scale(1.05);
    }

    .map-control-btn:active {
      transform: scale(0.95);
    }

    .map-legend {
      position: absolute;
      bottom: 15px;
      left: 15px;
      right: 15px;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 8px;
      padding: 8px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 6px;
      z-index: 10;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 160px;
      overflow-y: auto;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .legend-item i {
      font-size: 12px;
      min-width: 12px;
      text-align: center;
    }

    .map-placeholder-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      text-align: center;
      color: var(--text-light);
      padding: 20px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
    }

    .map-placeholder-center i {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.7;
    }

    .map-placeholder-center p {
      font-size: 16px;
      margin-bottom: 20px;
      opacity: 0.8;
    }

    .map-placeholder-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      z-index: 15;
    }

    .map-canvas {
      position: relative;
      height: 100%;
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: 8px;
      overflow: hidden;
    }

    .map-background {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 70px;
      background: linear-gradient(135deg, #e8f5e8 0%, #f3e5f5 100%);
    }

    .map-grid {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .grid-line {
      position: absolute;
      background: rgba(0, 0, 0, 0.1);
    }

    .grid-line.horizontal {
      width: 100%;
      height: 1px;
    }

    .grid-line.vertical {
      width: 1px;
      height: 100%;
    }

    .map-landmarks {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
    }

    .landmark {
      position: absolute;
      color: rgba(0, 0, 0, 0.3);
      font-size: 16px;
      transform: translate(-50%, -50%);
    }

    .map-reports {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 70px;
    }

    .map-report-point {
      position: absolute;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate(-50%, -50%);
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      z-index: 10;
      border: 2px solid white;
    }

    .map-report-point:hover {
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 20;
    }

    .map-report-point i {
      font-size: 14px;
      color: white;
    }

    .map-report-point[data-vibe="crowded"] { background: rgba(255, 165, 0, 0.9); }
    .map-report-point[data-vibe="noisy"] { background: rgba(255, 107, 53, 0.9); }
    .map-report-point[data-vibe="festive"] { background: rgba(40, 167, 69, 0.9); }
    .map-report-point[data-vibe="calm"] { background: rgba(23, 162, 184, 0.9); }
    .map-report-point[data-vibe="suspicious"] { background: rgba(255, 193, 7, 0.9); }
    .map-report-point[data-vibe="dangerous"] { background: rgba(220, 53, 69, 0.9); }

    .report-tooltip {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      z-index: 30;
      margin-bottom: 8px;
    }

    .map-report-point:hover .report-tooltip {
      opacity: 1;
    }

    .report-tooltip::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: rgba(0, 0, 0, 0.8);
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      backdrop-filter: blur(5px);
    }

    .modal-content {
      background: var(--dark-bg);
      margin: 1% auto;
      width: 90%;
      max-width: 500px;
      border-radius: var(--border-radius);
      overflow: hidden;
      animation: modalFadeIn 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
      max-height: 98vh;
      display: flex;
      flex-direction: column;
    }

    .modal-content.emergency {
      border: 2px solid var(--danger);
    }

    .modal-header {
      background: var(--card-bg);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header h2 {
      font-size: 18px;
      color: var(--text-light);
    }

    .close {
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      transition: color 0.3s ease;
    }

    .close:hover {
      color: var(--text-light);
    }

    .modal-body {
      padding: 20px;
      overflow-y: auto;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }

    .vibe-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }

    .vibe-option {
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid transparent;
      border-radius: 10px;
      padding: 12px 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .vibe-option:hover {
      border-color: var(--primary);
      background: rgba(45, 91, 255, 0.1);
    }

    .vibe-option.selected {
      border-color: var(--primary);
      background: rgba(45, 91, 255, 0.15);
    }

    .vibe-option i {
      font-size: 20px;
      margin-bottom: 5px;
      display: block;
    }

    .vibe-option span {
      font-size: 12px;
      font-weight: 500;
    }

    textarea, select, input {
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 12px;
      color: var(--text-light);
      resize: vertical;
    }

    textarea:focus, select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
    }

    textarea {
      min-height: 100px;
    }

    .settings-section {
      margin-bottom: 25px;
    }

    .settings-section h3 {
      margin-bottom: 15px;
      color: var(--primary);
      font-size: 16px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 16px 24px;
      backdrop-filter: blur(20px);
      border: 2px solid rgba(255, 255, 255, 0.15);
      z-index: 1000;
      max-width: calc(100vw - 40px);
      min-width: 300px;
      animation: slideInDown 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      box-sizing: border-box;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
      text-align: left;
      justify-content: flex-start;
      font-weight: 500;
      font-size: 14px;
      line-height: 1.4;
    }

    .notification.hidden {
      display: none;
    }

    .notification.success {
      background: rgba(40, 167, 69, 0.9);
      border-color: rgba(40, 167, 69, 0.5);
    }

    .notification.error {
      background: rgba(220, 53, 69, 0.9);
      border-color: rgba(220, 53, 69, 0.5);
    }

    .notification.warning {
      background: rgba(255, 193, 7, 0.9);
      border-color: rgba(255, 193, 7, 0.5);
      color: #000;
    }

    .notification.info {
      background: rgba(23, 162, 184, 0.9);
      border-color: rgba(23, 162, 184, 0.5);
    }

    .no-data {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
      font-style: italic;
    }

    /* Authentication Styles */
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }
    
    .auth-content {
      background: var(--dark-bg);
      margin: 2% auto;
      width: 90%;
      max-width: 400px;
      border-radius: var(--border-radius);
      overflow-y: auto;
      max-height: 96vh;
      animation: modalFadeIn 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-header {
      background: var(--card-bg);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-tabs {
      display: flex;
      background: var(--card-bg);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.3s ease;
    }
    
    .auth-tab.active {
      opacity: 1;
      border-bottom: 2px solid var(--primary);
      background: rgba(45, 91, 255, 0.1);
    }
    
    .auth-form {
      padding: 20px;
    }
    
    .auth-form.hidden {
      display: none;
    }
    
    .auth-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .auth-btn:hover {
      background: var(--primary-dark);
    }
    
    .auth-footer {
      padding: 15px 20px;
      text-align: center;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      color: var(--text-muted);
    }

    @keyframes pulse {
      0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
      50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
    }

    @keyframes slideInUp {
      from {
        transform: translate(-50%, 100%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    @keyframes slideInDown {
      from {
        transform: translateX(-50%);
        opacity: 0;
        top: -20px;
      }
      to {
        transform: translateX(-50%);
        opacity: 1;
        top: 20px;
      }
    }

    @keyframes modalFadeIn {
      from {
        opacity: 0;
        transform: translateY(-50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Top Areas Modal Styles */
    .top-areas-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .area-item {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .area-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .area-rank {
      background: var(--primary);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .area-info h3 {
      margin: 0 0 4px 0;
      font-size: 16px;
      color: var(--text-light);
    }

    .area-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .area-vibes {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .vibe-tag {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 4px 8px;
      font-size: 11px;
      display: flex;
      align-items: center;
      gap: 4px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .vibe-tag.vibe-crowded { background: rgba(255, 165, 0, 0.2); border-color: rgba(255, 165, 0, 0.3); }
    .vibe-tag.vibe-noisy { background: rgba(255, 107, 53, 0.2); border-color: rgba(255, 107, 53, 0.3); }
    .vibe-tag.vibe-festive { background: rgba(40, 167, 69, 0.2); border-color: rgba(40, 167, 69, 0.3); }
    .vibe-tag.vibe-calm { background: rgba(23, 162, 184, 0.2); border-color: rgba(23, 162, 184, 0.3); }
    .vibe-tag.vibe-suspicious { background: rgba(255, 193, 7, 0.2); border-color: rgba(255, 193, 7, 0.3); }
    .vibe-tag.vibe-dangerous { background: rgba(220, 53, 69, 0.2); border-color: rgba(220, 53, 69, 0.3); }

    .vibe-tag i {
      font-size: 10px;
    }

    /* Action Buttons Section */
    .action-buttons-section {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin: 28px 0 20px;
      padding: 32px 24px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
      border-radius: var(--border-radius-lg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(30px);
      box-shadow: 0 16px 56px rgba(0, 0, 0, 0.18);
      position: relative;
      overflow: hidden;
      transition: var(--transition);
    }

    .action-buttons-section::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(245, 158, 11, 0.08) 50%, rgba(239, 68, 68, 0.08) 100%);
      opacity: 0.6;
      z-index: 0;
      border-radius: var(--border-radius-lg);
    }

    .action-buttons-section::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 1;
    }

    .action-buttons-section:hover::after {
      opacity: 1;
    }

    .action-buttons-section:hover {
      box-shadow: 0 20px 64px rgba(0, 0, 0, 0.22);
      transform: translateY(-2px);
    }

    .action-buttons-section .action-btn {
      flex: 1;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      border-radius: var(--border-radius);
      padding: 28px 24px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      box-shadow: 0 12px 40px rgba(99, 102, 241, 0.35);
      position: relative;
      overflow: hidden;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      z-index: 2;
      backdrop-filter: blur(15px);
      border: 1px solid rgba(255, 255, 255, 0.15);
    }

    .action-buttons-section .action-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
      transition: left 0.8s ease;
      z-index: 1;
    }

    .action-buttons-section .action-btn::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.12) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.4s ease;
      z-index: 1;
    }

    .action-buttons-section .action-btn:hover::before {
      left: 100%;
    }

    .action-buttons-section .action-btn:hover::after {
      opacity: 1;
    }

    .action-buttons-section .action-btn:hover {
      transform: translateY(-8px) scale(1.03);
      box-shadow: 0 20px 56px rgba(99, 102, 241, 0.45);
      border-color: rgba(255, 255, 255, 0.25);
    }

    .action-buttons-section .action-btn:active {
      transform: translateY(-4px) scale(0.97);
      box-shadow: 0 12px 40px rgba(99, 102, 241, 0.35);
      transition: all 0.1s ease;
    }

    .action-buttons-section .action-btn.primary {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
    }

    .action-buttons-section .action-btn.secondary {
      background: linear-gradient(135deg, var(--secondary), var(--secondary-dark));
      box-shadow: 0 12px 40px rgba(245, 158, 11, 0.35);
    }

    .action-buttons-section .action-btn.secondary:hover {
      box-shadow: 0 20px 56px rgba(245, 158, 11, 0.45);
    }

    .action-buttons-section .action-btn.emergency {
      background: linear-gradient(135deg, var(--danger), #c82333);
      box-shadow: 0 12px 40px rgba(239, 68, 68, 0.35);
      animation: emergencyPulse 2s ease-in-out infinite;
    }

    .action-buttons-section .action-btn.emergency:hover {
      box-shadow: 0 20px 56px rgba(239, 68, 68, 0.45);
    }

    @keyframes emergencyPulse {
      0%, 100% {
        box-shadow: 0 12px 40px rgba(239, 68, 68, 0.35);
      }
      50% {
        box-shadow: 0 12px 40px rgba(239, 68, 68, 0.55);
      }
    }

    .action-buttons-section .action-btn i {
      font-size: 32px;
      margin-bottom: 8px;
      display: block;
      position: relative;
      z-index: 3;
      transition: transform 0.3s ease;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }

    .action-buttons-section .action-btn:hover i {
      transform: scale(1.15);
    }

    .action-buttons-section .action-btn span {
      font-size: 15px;
      font-weight: 800;
      letter-spacing: 0.05em;
      position: relative;
      z-index: 3;
      opacity: 0.98;
      text-transform: uppercase;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    /* Safety Hub Styles */
    .safety-hub {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .weather-alert {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(23, 162, 184, 0.1);
      border: 1px solid rgba(23, 162, 184, 0.3);
      border-radius: 10px;
      padding: 12px;
      backdrop-filter: blur(10px);
    }

    .weather-alert i {
      font-size: 24px;
      color: var(--info);
    }

    .alert-content {
      flex: 1;
    }

    .alert-title {
      font-weight: 600;
      color: var(--info);
      margin-bottom: 2px;
    }

    .alert-message {
      font-size: 13px;
      color: var(--text-muted);
    }

    .safety-guidelines {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .guideline-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .guideline-item:last-child {
      border-bottom: none;
    }

    .guideline-item i {
      font-size: 16px;
      color: var(--success);
      min-width: 16px;
      text-align: center;
    }

    .guideline-item span {
      font-size: 13px;
      color: var(--text-light);
    }

    /* Vibe Categories Styles */
    .vibe-categories {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .vibe-category-card {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      padding: 12px;
      transition: var(--transition);
      cursor: pointer;
    }

    .vibe-category-card:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.15);
      transform: translateY(-1px);
    }

    .category-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .vibe-category-card[data-vibe="crowded"] .category-icon {
      background: rgba(255, 165, 0, 0.2);
      color: #FFA500;
    }

    .vibe-category-card[data-vibe="noisy"] .category-icon {
      background: rgba(255, 107, 53, 0.2);
      color: #FF6B35;
    }

    .vibe-category-card[data-vibe="festive"] .category-icon {
      background: rgba(40, 167, 69, 0.2);
      color: #28A745;
    }

    .vibe-category-card[data-vibe="calm"] .category-icon {
      background: rgba(23, 162, 184, 0.2);
      color: #17A2B8;
    }

    .vibe-category-card[data-vibe="suspicious"] .category-icon {
      background: rgba(255, 193, 7, 0.2);
      color: #FFC107;
    }

    .vibe-category-card[data-vibe="dangerous"] .category-icon {
      background: rgba(220, 53, 69, 0.2);
      color: #DC3545;
    }

    .category-info {
      flex: 1;
      min-width: 0;
    }

    .category-name {
      font-weight: 600;
      font-size: 14px;
      color: var(--text-light);
      margin-bottom: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .category-count {
      font-size: 18px;
      font-weight: bold;
      color: var(--primary);
    }

    /* Pulsing Map Icons */
    @keyframes pulse-map {
      0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
      50% {
        transform: translate(-50%, -50%) scale(1.3);
        opacity: 1;
      }
      100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.8;
      }
    }

    .map-point {
      animation: pulse-map 2s infinite ease-in-out;
      position: absolute;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: translate(-50%, -50%);
      animation: pulse-map 2s infinite ease-in-out;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      z-index: 5;
      border: 2px solid white;
    }

    .map-point:hover {
      transform: translate(-50%, -50%) scale(1.2);
      z-index: 20;
    }

    .map-point i {
      font-size: 12px;
      color: white;
    }

    .map-point[data-vibe="dangerous"] {
      animation-duration: 1.5s;
      animation-timing-function: ease-in-out;
    }

    .map-point[data-vibe="suspicious"] {
      animation-duration: 2.5s;
    }

    /* Mobile-First Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 12px;
      }

      .language-switcher {
        right: 50px;
        z-index: 10;
      }

      .theme-toggle {
        right: 10px;
        z-index: 5;
      }

      .header {
        padding: 12px 0;
      }

      h1 {
        font-size: 20px;
      }

      .subtitle {
        font-size: 12px;
      }

      .card {
        padding: 16px;
        margin-bottom: 16px;
      }

      .reports-container {
        max-height: 250px;
      }

      .report-item {
        padding: 10px;
      }

      .quick-actions {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        margin: 16px 0;
      }

      .action-btn {
        padding: 12px 8px;
        font-size: 12px;
      }

      .action-btn i {
        margin-bottom: 3px;
        font-size: 16px;
      }

      .nav-btn i {
        font-size: 16px;
      }

      .status-bar {
        padding: 10px 12px;
        font-size: 13px;
      }

      .filter-controls {
        gap: 6px;
        margin: 8px 0;
      }

      .filter-btn {
        padding: 4px 8px;
        font-size: 11px;
      }

      .emergency-contacts {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
      }

      .emergency-btn {
        padding: 10px;
        font-size: 12px;
      }

      .emergency-btn i {
        font-size: 16px;
        margin-bottom: 2px;
      }

      .btn {
        padding: 12px 20px;
        font-size: 13px;
      }

      /* Mobile-First Action Buttons */
      .action-buttons-section {
        gap: 12px;
        margin: 20px 0 16px;
        padding: 20px 16px;
      }

      .action-buttons-section .action-btn {
        flex: 1;
        min-height: 80px; /* Reduced from 100px for mobile */
        padding: 20px 16px;
        font-size: 14px;
      }

      .action-buttons-section .action-btn i {
        font-size: 28px; /* Reduced from 32px */
        margin-bottom: 6px;
      }

      .action-buttons-section .action-btn span {
        font-size: 13px; /* Reduced from 15px */
        letter-spacing: 0.025em; /* Reduced from 0.05em */
      }

      /* Mobile Notification Modal */
      .notification {
        position: fixed;
        bottom: 80px; /* Position at bottom instead of top */
        left: 16px;
        right: 16px;
        top: auto; /* Override top positioning */
        max-width: none;
        width: calc(100vw - 32px);
        font-size: 14px;
        padding: 12px 16px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        animation: slideInUp 0.3s ease-out; /* Bottom slide animation */
      }

      .modal-content {
        width: 95%;
        max-width: none;
        margin: 10% auto; /* Center vertically on mobile */
        max-height: 80vh; /* Don't cover full screen */
      }

      .modal-body {
        padding: 16px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .vibe-options {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .vibe-option {
        padding: 10px 6px;
        font-size: 11px;
        min-height: 60px; /* Ensure touch target */
      }

      .vibe-option i {
        font-size: 16px;
        margin-bottom: 3px;
      }

      .map-legend {
        grid-template-columns: repeat(2, 1fr);
        gap: 6px;
        padding: 10px;
      }

      .legend-item {
        font-size: 10px;
      }

      .legend-item i {
        font-size: 11px;
        min-width: 11px;
      }

      .stats-grid {
        gap: 8px;
      }

      .stat-card {
        padding: 10px;
      }

      .stat-number {
        font-size: 20px;
      }

      .stat-label {
        font-size: 11px;
      }
    }

    /* Extra Small Mobile Devices */
    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }

      .action-buttons-section {
        gap: 8px;
        margin: 16px 0 12px;
        padding: 16px 12px;
      }

      .action-buttons-section .action-btn {
        min-height: 70px; /* Even smaller for very small screens */
        padding: 16px 12px;
        font-size: 13px;
      }

      .action-buttons-section .action-btn i {
        font-size: 24px;
      }

      .action-buttons-section .action-btn span {
        font-size: 12px;
      }

      .notification {
        bottom: 70px;
        left: 12px;
        right: 12px;
        width: calc(100vw - 24px);
        font-size: 13px;
        padding: 10px 14px;
      }

      .modal-content {
        width: 98%;
        margin: 5% auto;
        max-height: 85vh;
      }

      .modal-body {
        padding: 12px;
        max-height: 65vh;
      }

      h1 {
        font-size: 18px;
      }

      .card {
        padding: 12px;
        margin-bottom: 12px;
      }
    }

    /* Enhanced Stats Charts */
    .vibe-distribution-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 15px;
    }

    .vibe-bar {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .vibe-label {
      min-width: 80px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-light);
    }

    .vibe-progress {
      flex: 1;
      height: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .vibe-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.8s ease;
      position: relative;
    }

    .vibe-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .vibe-count {
      min-width: 30px;
      text-align: right;
      font-size: 14px;
      font-weight: 600;
      color: var(--primary);
    }

    .activity-chart {
      margin-top: 15px;
    }

    .activity-bars {
      display: flex;
      align-items: end;
      justify-content: space-between;
      height: 120px;
      gap: 2px;
      margin-bottom: 10px;
    }

    .activity-bar {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px 2px 0 0;
      position: relative;
      min-height: 4px;
      transition: all 0.3s ease;
    }

    .activity-bar:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .activity-fill {
      background: linear-gradient(180deg, var(--primary), var(--primary-dark));
      border-radius: 2px 2px 0 0;
      width: 100%;
      transition: height 0.8s ease;
      position: relative;
    }

    .activity-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.2), transparent);
      border-radius: 2px 2px 0 0;
    }

    .activity-labels {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-muted);
      padding: 0 2px;
    }

    .activity-labels span {
      flex: 1;
      text-align: center;
    }

    /* Badge System Styles */
    .badge-notification {
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      border: 2px solid #FFD700;
      animation: badgePulse 0.6s ease-in-out;
    }

    @keyframes badgePulse {
      0% { transform: scale(0.9); opacity: 0.8; }
      50% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }

    .badge-showcase {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
      margin-top: 15px;
    }

    .badge-item {
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .badge-item.unlocked {
      border-color: var(--success);
      background: rgba(40, 167, 69, 0.1);
    }

    .badge-item.locked {
      opacity: 0.6;
      filter: grayscale(100%);
    }

    .badge-item.unlocked::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(40, 167, 69, 0.1) 0%, transparent 70%);
      animation: badgeGlow 2s ease-in-out infinite alternate;
    }

    @keyframes badgeGlow {
      0% { opacity: 0.3; }
      100% { opacity: 0.8; }
    }

    .badge-icon {
      width: 40px;
      height: 40px;
      margin: 0 auto 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      position: relative;
      z-index: 2;
    }

    .badge-item.unlocked .badge-icon {
      background: linear-gradient(135deg, var(--success), #28A745);
      color: white;
      box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }

    .badge-item.locked .badge-icon {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
    }

    .badge-name {
      font-weight: 600;
      font-size: 13px;
      color: var(--text-light);
      margin-bottom: 4px;
    }

    .badge-description {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.3;
    }

    /* Weather Alert Enhancements */
    .weather-alert.severe {
      border-color: rgba(220, 53, 69, 0.5);
      background: rgba(220, 53, 69, 0.1);
      animation: weatherAlertPulse 1s ease-in-out infinite alternate;
    }

    @keyframes weatherAlertPulse {
      0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.4); }
      100% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
    }

    .weather-alert i {
      animation: weatherIconPulse 2s ease-in-out infinite;
    }

    @keyframes weatherIconPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    /* Reputation Display Enhancement */
    .reputation-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      color: #FFD700;
    }

    .reputation-display i {
      color: #FFD700;
    }

    .reputation-display.high {
      background: rgba(40, 167, 69, 0.1);
      border-color: rgba(40, 167, 69, 0.3);
      color: var(--success);
    }

    .reputation-display.high i {
      color: var(--success);
    }

    /* User Profile Styles */
    .user-profile-section {
      margin-bottom: 20px;
    }

    .user-profile-card {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      transition: var(--transition);
    }

    .user-profile-card:hover {
      background: var(--card-bg-hover);
      border-color: var(--border-hover);
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }

    .user-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 24px;
      flex-shrink: 0;
    }

    .user-info {
      flex: 1;
      min-width: 0;
    }

    .user-info h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--text-light);
    }

    .reputation-display {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      color: #FFD700;
    }

    .reputation-display i {
      color: #FFD700;
    }

    .reputation-display.high {
      background: rgba(40, 167, 69, 0.1);
      border-color: rgba(40, 167, 69, 0.3);
      color: var(--success);
    }

    .reputation-display.high i {
      color: var(--success);
    }

    .user-join-date {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Force display for mobile views */
    @media (max-width: 480px) {
      #mainView,
      #mapView,
      #reportsView,
      #settingsView {
        display: none;
      }

      #mainView.active,
      #mapView.active,
      #reportsView.active,
      #settingsView.active {
        display: block !important;
      }

      .view.active {
        display: block !important;
      }

      .vibe-distribution-chart {
        gap: 10px;
      }

      .vibe-bar {
        gap: 8px;
      }

      .vibe-label {
        min-width: 60px;
        font-size: 13px;
      }

      .activity-bars {
        height: 100px;
      }

      .badge-showcase {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .badge-item {
        padding: 10px;
      }

      .badge-icon {
        width: 35px;
        height: 35px;
        font-size: 16px;
      }

      .badge-name {
        font-size: 12px;
      }

      .badge-description {
        font-size: 10px;
      }

      .user-profile-card {
        padding: 16px;
        gap: 12px;
      }

      .user-avatar {
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .user-info h3 {
        font-size: 16px;
      }

      .reputation-display {
        font-size: 12px;
        padding: 4px 8px;
      }
    }


  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div id="authModal" class="auth-modal">
    <div class="auth-content">
      <div class="auth-header">
        <h2 data-en="Authentication Required" data-ar=" ">Authentication Required</h2>
        <span class="close" id="closeAuth">&times;</span>
      </div>
      
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Login</div>
        <div class="auth-tab" data-tab="signup">Sign Up</div>
      </div>
      
      <div class="auth-form" id="loginForm">
        <div class="form-group">
          <label data-en="Email" data-ar=" ">Email</label>
          <input type="email" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label data-en="Password" data-ar=" ">Password</label>
          <input type="password" id="loginPassword" placeholder="">
        </div>
        <button class="auth-btn" id="loginBtn" data-en="Login" data-ar=" ">Login</button>
      </div>
      
      <div class="auth-form hidden" id="signupForm">
        <div class="form-group">
          <label data-en="Username" data-ar=" ">Username</label>
          <input type="text" id="signupUsername" placeholder="Choose a username">
        </div>
        <div class="form-group">
          <label data-en="Email" data-ar=" ">Email</label>
          <input type="email" id="signupEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label data-en="Password" data-ar=" ">Password</label>
          <input type="password" id="signupPassword" placeholder="">
        </div>
        <div class="form-group">
          <label data-en="Confirm Password" data-ar="  ">Confirm Password</label>
          <input type="password" id="signupPasswordConfirm" placeholder="">
        </div>
        <button class="auth-btn" id="signupBtn" data-en="Sign Up" data-ar=" ">Sign Up</button>
      </div>
      
      <div class="auth-footer">
        <p data-en="You need to authenticate to use all features" data-ar="     ">You need to authenticate to use all features</p>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Header Section -->
    <header>
      <div class="logo">
        <i class="fas fa-shield-alt"></i>
      </div>
      <h1>HyperApp</h1>
      <p class="subtitle">Stay Safe...Stay Connected</p>

      <div class="language-switcher" id="languageSwitcher">
        <i class="fas fa-globe"></i> <span id="currentLanguage">EN</span>
      </div>

      <!-- Theme Toggle -->
      <div class="theme-toggle" id="themeToggle" title="Toggle theme">
        <i class="fas fa-moon"></i>
      </div>
    </header>

    <!-- Action Buttons Section -->
    <div class="action-buttons-section">
      <div class="action-btn primary" data-action="report">
        <i class="fas fa-plus-circle"></i>
        <span data-en="Report Vibe" data-ar="  ">Report Vibe</span>
      </div>
      <div class="action-btn secondary" data-action="areas">
        <i class="fas fa-chart-line"></i>
        <span data-en="Top Areas" data-ar=" ">Top Areas</span>
      </div>
      <div class="action-btn emergency" data-action="emergency">
        <i class="fas fa-exclamation-triangle"></i>
        <span data-en="Emergency" data-ar="">Emergency</span>
      </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-item">
        <i class="fas fa-star"></i>
        <span data-en="Rep:" data-ar=":">Rep:</span> <span id="userReputation">0</span>
      </div>
    </div>

    <!-- Main Navigation -->
    <nav class="app-nav">
      <button class="nav-btn active" data-view="main"><i class="fas fa-home"></i></button>
      <button class="nav-btn" data-view="map"><i class="fas fa-map"></i></button>
      <button class="nav-btn" data-view="reports"><i class="fas fa-list"></i></button>
      <button class="nav-btn" data-view="settings"><i class="fas fa-cog"></i></button>
    </nav>

    <!-- Main Content Area -->
    <main class="content-area">
      <!-- Main View -->
      <div id="mainView" class="view active">




        <!-- Statistics Card -->
        <div class="card">
          <div class="card-title">
            <i class="fas fa-chart-bar"></i>
            <span data-en="Community Stats" data-ar=" ">Community Stats</span>
          </div>
          <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
              <div class="stat-number" id="totalReports">0</div>
              <div class="stat-label">Reports</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="activeUsers">0</div>
              <div class="stat-label">Active Users</div>
            </div>
          </div>
        </div>

        <!-- Safety Hub -->
        <div class="card">
          <div class="card-title">
            <i class="fas fa-shield-alt"></i>
            <span data-en="Safety Hub" data-ar=" ">Safety Hub</span>
          </div>
          <div class="safety-hub">
            <div class="weather-alert" id="weatherAlert">
              <i class="fas fa-cloud-sun"></i>
              <div class="alert-content">
                <span class="alert-title" data-en="Weather Alert" data-ar=" ">Weather Alert</span>
                <span class="alert-message" data-en="Loading weather information..." data-ar="   ...">Loading weather information...</span>
              </div>
            </div>
            <div class="safety-tips" id="safetyTips">
              <div class="guideline-item">
                <i class="fas fa-users"></i>
                <span data-en="Avoid crowded areas after dark" data-ar="    ">Avoid crowded areas after dark</span>
              </div>
              <div class="guideline-item">
                <i class="fas fa-mobile-alt"></i>
                <span data-en="Keep your phone charged" data-ar="  ">Keep your phone charged</span>
              </div>
              <div class="guideline-item">
                <i class="fas fa-share-alt"></i>
                <span data-en="Share your location with trusted contacts" data-ar="     ">Share your location with trusted contacts</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Vibe Categories -->
        <div class="card">
          <div class="card-title">
            <i class="fas fa-chart-pie"></i>
            <span data-en="Vibe Categories" data-ar=" ">Vibe Categories</span>
          </div>
          <div class="vibe-categories" id="vibeCategories">
            <div class="vibe-category-card" data-vibe="crowded">
              <div class="category-icon">
                <i class="fas fa-users"></i>
              </div>
              <div class="category-info">
                <span class="category-name" data-en="Crowded" data-ar="">Crowded</span>
                <span class="category-count" id="crowdedCount">0</span>
              </div>
            </div>
            <div class="vibe-category-card" data-vibe="noisy">
              <div class="category-icon">
                <i class="fas fa-volume-up"></i>
              </div>
              <div class="category-info">
                <span class="category-name" data-en="Noisy" data-ar="">Noisy</span>
                <span class="category-count" id="noisyCount">0</span>
              </div>
            </div>
            <div class="vibe-category-card" data-vibe="festive">
              <div class="category-icon">
                <i class="fas fa-glass-cheers"></i>
              </div>
              <div class="category-info">
                <span class="category-name" data-en="Festive" data-ar="">Festive</span>
                <span class="category-count" id="festiveCount">0</span>
              </div>
            </div>
            <div class="vibe-category-card" data-vibe="calm">
              <div class="category-icon">
                <i class="fas fa-peace"></i>
              </div>
              <div class="category-info">
                <span class="category-name" data-en="Calm" data-ar="">Calm</span>
                <span class="category-count" id="calmCount">0</span>
              </div>
            </div>
            <div class="vibe-category-card" data-vibe="suspicious">
              <div class="category-icon">
                <i class="fas fa-eye-slash"></i>
              </div>
              <div class="category-info">
                <span class="category-name" data-en="Suspicious" data-ar="">Suspicious</span>
                <span class="category-count" id="suspiciousCount">0</span>
              </div>
            </div>
            <div class="vibe-category-card" data-vibe="dangerous">
              <div class="category-icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="category-info">
                <span class="category-name" data-en="Dangerous" data-ar="">Dangerous</span>
                <span class="category-count" id="dangerousCount">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Map View -->
      <div id="mapView" class="view">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-map"></i> 
            <span data-en="Vibe Map" data-ar=" ">Vibe Map</span>
          </div>
          <div id="mapContainer" class="map-container">
            <div class="loading-spinner"></div>
          </div>
        </div>
      </div>

      <!-- Reports View -->
      <div id="reportsView" class="view">
        <div class="card">
          <div class="card-title">
            <i class="fas fa-user"></i>
            <span data-en="My Dashboard" data-ar="   ">My Dashboard</span>
          </div>

          <!-- User Profile Section -->
          <div class="user-profile-section" id="userProfileSection">
            <div class="loading-spinner"></div>
          </div>

          <!-- Achievement Badges -->
          <div class="card">
            <div class="card-title">
              <i class="fas fa-trophy"></i>
              <span data-en="Achievements" data-ar="">Achievements</span>
            </div>
            <div id="userBadges" class="badge-showcase">
              <div class="loading-spinner"></div>
            </div>
          </div>

          <!-- Personal Stats -->
          <div class="card">
            <div class="card-title">
              <i class="fas fa-chart-line"></i>
              <span data-en="My Impact" data-ar="">My Impact</span>
            </div>
            <div class="stats-grid" id="userStatsGrid">
              <div class="stat-card">
                <div class="stat-number" id="userTotalReports">0</div>
                <div class="stat-label">My Reports</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="userTotalUpvotes">0</div>
                <div class="stat-label">Upvotes Received</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="userReputationScore">0</div>
                <div class="stat-label">Reputation</div>
              </div>
              <div class="stat-card">
                <div class="stat-number" id="userRank">-</div>
                <div class="stat-label">Community Rank</div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="card">
            <div class="card-title">
              <i class="fas fa-history"></i>
              <span data-en="Recent Activity" data-ar=" ">Recent Activity</span>
              <button id="refreshRecentActivity" class="btn" style="font-size: 12px; padding: 6px 12px; margin-left: auto;">
                <i class="fas fa-sync-alt"></i>
                <span data-en="Refresh" data-ar="">Refresh</span>
              </button>
            </div>
            <div id="userRecentActivity" class="reports-container">
              <div class="loading-spinner"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Settings View -->
      <div id="settingsView" class="view">
        <!-- Profile Header -->
        <div class="card" style="text-align: center; margin-bottom: 28px; position: relative; overflow: hidden;">
          <div style="position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--primary), var(--secondary), var(--info));"></div>
          <div class="user-avatar" style="width: 100px; height: 100px; margin: 24px auto 20px; font-size: 40px; border: 4px solid rgba(255, 255, 255, 0.1); box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);">
            <i class="fas fa-user-circle"></i>
          </div>
          <h3 id="settingsUsername" style="margin: 0 0 12px 0; color: var(--text-light); font-size: 24px; font-weight: 700;">-</h3>
          <div class="reputation-display" style="justify-content: center; margin: 0 auto 16px; font-size: 16px; padding: 12px 20px;">
            <i class="fas fa-star"></i>
            <span><span id="settingsReputation">0</span> Reputation Points</span>
          </div>
          <div style="padding: 16px 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px; margin: 0 20px 20px;">
            <div style="display: flex; justify-content: space-around; text-align: center;">
              <div>
                <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="settingsTotalReports">0</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Reports</div>
              </div>
              <div>
                <div style="font-size: 18px; font-weight: 700; color: var(--success);" id="settingsTotalUpvotes">0</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Upvotes</div>
              </div>
              <div>
                <div style="font-size: 18px; font-weight: 700; color: var(--warning);" id="settingsCommunityRank">-</div>
                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Rank</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Preferences -->
        <div class="card">
          <div class="card-title">
            <i class="fas fa-sliders-h"></i>
            <span data-en="Preferences" data-ar="">Preferences</span>
          </div>

          <div class="settings-section">
            <div class="setting-item">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-language" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text-light); font-size: 16px; margin-bottom: 4px;" data-en="Language" data-ar="">Language</div>
                  <div style="font-size: 13px; color: var(--text-muted);" data-en="Choose your preferred language" data-ar="  ">Choose your preferred language</div>
                </div>
              </div>
              <select id="languageSelect" style="padding: 12px 16px; border-radius: 12px; background: rgba(255, 255, 255, 0.08); border: 2px solid rgba(255, 255, 255, 0.15); color: var(--text-light); font-weight: 600; min-width: 120px;">
                <option value="en"> English</option>
                <option value="ar"> </option>
              </select>
            </div>

            <div class="setting-item">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--secondary), var(--secondary-dark)); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-palette" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text-light); font-size: 16px; margin-bottom: 4px;" data-en="Theme" data-ar="">Theme</div>
                  <div style="font-size: 13px; color: var(--text-muted);" data-en="Choose your visual theme" data-ar="  ">Choose your visual theme</div>
                </div>
              </div>
              <div style="display: flex; gap: 12px;">
                <button id="themeLightBtn" class="btn" style="padding: 12px 20px; background: linear-gradient(135deg, #f8fafc, #e2e8f0); color: #1e293b; border: none; font-size: 14px;">
                  <i class="fas fa-sun" style="margin-right: 8px;"></i>Light
                </button>
                <button id="themeDarkBtn" class="btn" style="padding: 12px 20px; background: linear-gradient(135deg, #0f172a, #1e293b); color: white; border: none; font-size: 14px;">
                  <i class="fas fa-moon" style="margin-right: 8px;"></i>Dark
                </button>
              </div>
            </div>

            <div class="setting-item">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--info), #0891b2); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-bell" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text-light); font-size: 16px; margin-bottom: 4px;" data-en="Notifications" data-ar="">Notifications</div>
                  <div style="font-size: 13px; color: var(--text-muted);" data-en="Weather alerts and safety updates" data-ar="   ">Weather alerts and safety updates</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 13px; color: var(--success); font-weight: 600;" data-en="Enabled" data-ar="">Enabled</span>
                <div style="width: 52px; height: 28px; background: var(--success); border-radius: 14px; position: relative; cursor: pointer; transition: all 0.3s ease;">
                  <div style="width: 24px; height: 24px; background: white; border-radius: 50%; position: absolute; right: 2px; top: 2px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                </div>
              </div>
            </div>

            <div class="setting-item">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #10b981, #059669); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-location-arrow" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text-light); font-size: 16px; margin-bottom: 4px;" data-en="Location Services" data-ar=" ">Location Services</div>
                  <div style="font-size: 13px; color: var(--text-muted);" data-en="Used for accurate safety reporting" data-ar="    ">Used for accurate safety reporting</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 13px; color: var(--success); font-weight: 600;" data-en="Enabled" data-ar="">Enabled</span>
                <div style="width: 52px; height: 28px; background: var(--success); border-radius: 14px; position: relative; cursor: pointer; transition: all 0.3s ease;">
                  <div style="width: 24px; height: 24px; background: white; border-radius: 50%; position: absolute; right: 2px; top: 2px; transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Privacy & Security -->
        <div class="card">
          <div class="card-title">
            <i class="fas fa-shield-alt"></i>
            <span data-en="Privacy & Security" data-ar=" ">Privacy & Security</span>
          </div>

          <div class="settings-section">
            <div class="setting-item">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--success), #16a34a); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-lock" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text-light); font-size: 16px; margin-bottom: 4px;" data-en="Anonymous Reporting" data-ar=" ">Anonymous Reporting</div>
                  <div style="font-size: 13px; color: var(--text-muted);" data-en="Reports are anonymous by default" data-ar="  ">Reports are anonymous by default</div>
                </div>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                <span style="font-size: 13px; color: var(--success); font-weight: 600;" data-en="Active" data-ar="">Active</span>
                <i class="fas fa-check-circle" style="color: var(--success); font-size: 18px;"></i>
              </div>
            </div>

            <div class="setting-item">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--warning), #d97706); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-file-contract" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text-light); font-size: 16px; margin-bottom: 4px;" data-en="Privacy Policy" data-ar=" ">Privacy Policy</div>
                  <div style="font-size: 13px; color: var(--text-muted);" data-en="Learn about data collection and usage" data-ar="    ">Learn about data collection and usage</div>
                </div>
              </div>
              <button class="btn" data-action="privacy-policy" style="font-size: 14px; padding: 12px 20px; font-weight: 600;" data-en="View Policy" data-ar=" ">View Policy</button>
            </div>

            <div class="setting-item">
              <div style="display: flex; align-items: center; gap: 16px;">
                <div style="width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, var(--danger), #dc2626); display: flex; align-items: center; justify-content: center; color: white;">
                  <i class="fas fa-sign-out-alt" style="font-size: 20px;"></i>
                </div>
                <div style="flex: 1;">
                  <div style="font-weight: 700; color: var(--text-light); font-size: 16px; margin-bottom: 4px;" data-en="Account" data-ar="">Account</div>
                  <div style="font-size: 13px; color: var(--text-muted);" data-en="Manage your account and data" data-ar="  ">Manage your account and data</div>
                </div>
              </div>
              <button class="btn btn-danger" id="logoutBtn" style="font-size: 14px; padding: 12px 20px; font-weight: 600;" data-en="Logout" data-ar=" ">Logout</button>
            </div>
          </div>
        </div>

        <!-- About -->
        <div class="card">
          <div class="card-title">
            <i class="fas fa-info-circle"></i>
            <span data-en="About HyperApp" data-ar=" HyperApp">About HyperApp</span>
          </div>

          <div style="text-align: center; padding: 32px 24px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); border-radius: 20px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);">
              <i class="fas fa-shield-alt" style="font-size: 36px; color: white;"></i>
            </div>
            <h3 style="margin: 0 0 12px 0; color: var(--text-light); font-size: 24px; font-weight: 700;">HyperApp</h3>
            <p style="margin: 0 0 8px 0; color: var(--text-muted); font-size: 15px; font-weight: 500;" data-en="Version 1.0.0" data-ar=" 1.0.0">Version 1.0.0</p>
            <p style="margin: 0 0 28px 0; color: var(--text-muted); line-height: 1.6; font-size: 15px;" data-en="HyperApp helps communities stay informed about safety conditions in their area through real-time reporting and collaborative monitoring." data-ar=" HyperApp                 .">
              HyperApp helps communities stay informed about safety conditions in their area through real-time reporting and collaborative monitoring.
            </p>
            <div style="display: flex; justify-content: center; gap: 24px; font-size: 28px; color: var(--text-muted);">
              <i class="fab fa-telegram" style="cursor: pointer; transition: all 0.3s ease;" title="Telegram"></i>
              <i class="fas fa-globe" style="cursor: pointer; transition: all 0.3s ease;" title="Website"></i>
              <i class="fas fa-envelope" style="cursor: pointer; transition: all 0.3s ease;" title="Contact"></i>
            </div>
            <div style="margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
              <p style="margin: 0; color: var(--text-muted); font-size: 13px;" data-en=" 2025 HyperApp. All rights reserved." data-ar=" 2025 HyperApp.   ."> 2025 HyperApp. All rights reserved.</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Report Modal -->
  <div id="reportModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-en="Report Vibe" data-ar="  ">Report Vibe</h2>
        <span class="close" data-dismiss="reportModal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label data-en="What's the vibe?" data-ar="  ">What's the vibe?</label>
          <div class="vibe-options">
            <div class="vibe-option" data-vibe="crowded">
              <i class="fas fa-users"></i>
              <span data-en="Crowded" data-ar="">Crowded</span>
            </div>
            <div class="vibe-option" data-vibe="noisy">
              <i class="fas fa-volume-up"></i>
              <span data-en="Noisy" data-ar="">Noisy</span>
            </div>
            <div class="vibe-option" data-vibe="festive">
              <i class="fas fa-glass-cheers"></i>
              <span data-en="Festive" data-ar="">Festive</span>
            </div>
            <div class="vibe-option" data-vibe="calm">
              <i class="fas fa-peace"></i>
              <span data-en="Calm" data-ar="">Calm</span>
            </div>
            <div class="vibe-option" data-vibe="suspicious">
              <i class="fas fa-eye-slash"></i>
              <span data-en="Suspicious" data-ar="">Suspicious</span>
            </div>
            <div class="vibe-option" data-vibe="dangerous">
              <i class="fas fa-exclamation-triangle"></i>
              <span data-en="Dangerous" data-ar="">Dangerous</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label data-en="Notes (optional)" data-ar=" ()">Notes (optional)</label>
          <textarea id="reportNotes" placeholder="Add details about what you're experiencing"></textarea>
        </div>
        <button class="btn" id="submitReportBtn" data-en="Submit Report" data-ar=" ">Submit Report</button>
      </div>
    </div>
  </div>

  <!-- Emergency Modal -->
  <div id="emergencyModal" class="modal">
    <div class="modal-content emergency">
      <div class="modal-header">
        <h2 data-en="Emergency Report" data-ar=" ">Emergency Report</h2>
        <span class="close" data-dismiss="emergencyModal">&times;</span>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label data-en="Emergency Type" data-ar=" ">Emergency Type</label>
          <select id="emergencyType">
            <option value="medical" data-en="Medical Emergency" data-ar=" ">Medical Emergency</option>
            <option value="police" data-en="Police Needed" data-ar="  ">Police Needed</option>
            <option value="fire" data-en="Fire Emergency" data-ar=" ">Fire Emergency</option>
            <option value="other" data-en="Other Emergency" data-ar=" ">Other Emergency</option>
          </select>
        </div>

        <div class="form-group">
          <label data-en="Details" data-ar="">Details</label>
          <textarea id="emergencyDetails" placeholder="Please provide details about the emergency" required></textarea>
        </div>
        <button class="btn btn-emergency" id="submitEmergencyBtn" data-en="Report Emergency" data-ar="   ">Report Emergency</button>
      </div>
    </div>
  </div>

  <script>
    // HyperApp Mini App - Complete Fixed Implementation
    class HyperApp {
      constructor() {
        this.tg = window.Telegram.WebApp;
        this.currentLanguage = 'en';
        this.userData = null;
        this.nearbyReports = [];
        this.userReports = [];
        this.selectedVibe = null;
        this.isConnected = false;
        this.userLocation = null;
        this.isAuthenticated = false;
        
        // Initialize Supabase with the correct API key
        this.supabaseUrl = 'https://nqwejzbayquzsvcodunl.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xd2VqemJheXF1enN2Y29kdW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTA0MjAsImV4cCI6MjA3Mzk2NjQyMH0.01yifC-tfEbBHD5u315fpb_nZrqMZCbma_UrMacMb78';
        this.supabase = window.supabase.createClient(this.supabaseUrl, this.supabaseKey);
        
        // Check authentication state
        this.checkAuthState();
        
        // Bind all methods to maintain 'this' context
        this.bindMethods();
        
        this.init();
      }
      
      // Bind all methods to maintain proper 'this' context
      bindMethods() {
        const methods = [
          'init', 'setupEventListeners', 'syncUserWithSupabase', 'updateConnectionStatus',
          'updateUserInfo', 'loadInitialData', 'loadNearbyReports', 'displayNearbyReports',
          'loadUserReports', 'displayUserReports', 'voteReport', 'showReportModal',
          'selectVibe', 'submitReport', 'showEmergencyReport', 'submitEmergencyReport',
          'showView', 'loadMap', 'displayMap', 'loadTopAreas', 'toggleLanguage',
          'changeLanguage', 'applyLanguage', 'showNotification', 'closeModal',
          'getVibeIcon', 'getVibeArabicName', 'capitalizeFirstLetter', 'formatTimeAgo',
          'updateTextDirection', 'requestUserLocation', 'checkAuthState',
          'showAuthModal', 'hideAuthModal', 'setupAuthListeners', 'handleAuthLogin',
          'handleAuthSignup', 'loadWeatherData', 'updateSafetyHub', 'generateDynamicSafetyTips',
          'calculateUserReputation', 'updateUserReputation', 'getUserBadges', 'checkBadgeUnlocks',
          'showBadgeNotification', 'loadEnhancedStats', 'renderStatsCharts', 'setupWeatherAlerts',
          'checkWeatherAlerts', 'sendWeatherAlert', 'updateCommunityInsights'
        ];
        
        methods.forEach(method => {
          this[method] = this[method].bind(this);
        });
      }
      
      async init() {
        console.log("Initializing HyperApp with Supabase...");

        // Load saved theme
        const savedTheme = localStorage.getItem('hyperapp-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Update theme toggle icon
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
          themeIcon.className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // Set up auth listeners
        this.setupAuthListeners();

        // Initialize Telegram WebApp
        if (this.tg) {
          this.tg.expand();
          this.tg.MainButton.hide();

          // Get user data
          const user = this.tg.initDataUnsafe.user;
          if (user) {
            this.userData = user;
            this.isAuthenticated = true;
            await this.syncUserWithSupabase();
            this.updateUserInfo();
          }

          // Try to get user location
          this.requestUserLocation();

          // Set up event listeners
          this.setupEventListeners();

          // Update connection status
          this.updateConnectionStatus(true);
        } else {
          console.log("Not in Telegram environment");
          this.updateConnectionStatus(false);
          this.showNotification("Running in standalone mode", "info");

          // For testing without Telegram, show auth modal
          this.showAuthModal();
        }

        // Fast initial load - only critical data
        await this.fastInitialLoad();

        // Lazy load additional features
        setTimeout(() => this.loadAdvancedFeatures(), 100);

        // Make app instance globally available
        window.hyperApp = this;
      }

      async fastInitialLoad() {
        // Load only essential data first
        await this.loadNearbyReports();

        // Update basic stats immediately
        this.updateStats();

        // Load map (lightweight)
        this.loadMap();

        // Update vibe categories with available data
        this.updateVibeCategories();
      }

      async loadAdvancedFeatures() {
        // Load heavier features after initial render
        if (this.isAuthenticated) {
          await this.loadUserReports();
          await this.updateUserReputation();
        }

        // Load enhanced stats
        await this.loadEnhancedStats();

        // Set up weather alerts (with real API)
        this.setupWeatherAlerts();

        // Update community insights periodically (less frequent)
        setInterval(() => {
          this.updateCommunityInsights();
        }, 300000); // Update every 5 minutes instead of 1 minute
      }
      
      async checkAuthState() {
        // Check if we have a Telegram user first
        if (this.tg && this.tg.initDataUnsafe && this.tg.initDataUnsafe.user) {
          const telegramUser = this.tg.initDataUnsafe.user;
          this.userData = telegramUser;
          this.isAuthenticated = true;
          await this.syncUserWithSupabase();
          this.updateUserInfo();
          return;
        }
        
        // Check Supabase authentication as fallback
        const { data: { session }, error } = await this.supabase.auth.getSession();
        if (session && session.user) {
          this.isAuthenticated = true;
          this.userData = {
            id: session.user.id,
            email: session.user.email,
            ...session.user.user_metadata
          };
          await this.syncUserWithSupabase();
          this.updateUserInfo();
        } else {
          // Show auth modal if no authentication found
          this.showAuthModal();
        }
      }
      
      showAuthModal() {
        document.getElementById('authModal').style.display = 'block';
      }
      
      hideAuthModal() {
        document.getElementById('authModal').style.display = 'none';
      }
      
      async setupAuthListeners() {
        // Auth tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.target.getAttribute('data-tab');
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            e.target.classList.add('active');
            document.getElementById(tabName + 'Form').classList.remove('hidden');
          });
        });
        
        // Close auth modal
        document.getElementById('closeAuth').addEventListener('click', () => {
          this.hideAuthModal();
        });
        
        // Login button
        document.getElementById('loginBtn').addEventListener('click', this.handleAuthLogin);
        
        // Signup button
        document.getElementById('signupBtn').addEventListener('click', this.handleAuthSignup);
      }
      
      async handleAuthLogin() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
          this.showNotification("Please fill all fields", "error");
          return;
        }

        // Show loading state
        const loginBtn = document.getElementById('loginBtn');
        const originalText = loginBtn.textContent;
        loginBtn.textContent = 'Logging in...';
        loginBtn.disabled = true;

        try {
          const { data, error } = await this.supabase.auth.signInWithPassword({
            email,
            password
          });

          if (error) {
            let errorMessage = error.message;
            if (error.message.includes('Invalid login credentials')) {
              errorMessage = "Account not found. Please sign up first.";
            } else if (error.message.includes('Email not confirmed')) {
              errorMessage = "Please check your email and confirm your account.";
            }
            this.showNotification(errorMessage, "error");
          } else {
            this.isAuthenticated = true;
            this.userData = {
              id: data.user.id,
              email: data.user.email,
              ...data.user.user_metadata
            };
            await this.syncUserWithSupabase();
            this.updateUserInfo();
            this.hideAuthModal();
            this.loadInitialData();
            this.showNotification("Login successful", "success");
          }
        } catch (error) {
          this.showNotification("Login failed. Please try again.", "error");
          console.error("Login error:", error);
        } finally {
          // Reset button state
          loginBtn.textContent = originalText;
          loginBtn.disabled = false;
        }
      }
      
      async handleAuthSignup() {
        const username = document.getElementById('signupUsername').value;
        const email = document.getElementById('signupEmail').value;
        const password = document.getElementById('signupPassword').value;
        const passwordConfirm = document.getElementById('signupPasswordConfirm').value;

        if (!username || !email || !password || !passwordConfirm) {
          this.showNotification("Please fill all fields", "error");
          return;
        }

        if (password !== passwordConfirm) {
          this.showNotification("Passwords don't match", "error");
          return;
        }

        if (password.length < 6) {
          this.showNotification("Password must be at least 6 characters", "error");
          return;
        }

        // Show loading state
        const signupBtn = document.getElementById('signupBtn');
        const originalText = signupBtn.textContent;
        signupBtn.textContent = 'Signing up...';
        signupBtn.disabled = true;

        try {
          const { data, error } = await this.supabase.auth.signUp({
            email,
            password,
            options: {
              data: {
                username: username,
                reputation: 0,
                language: 'en'
              }
            }
          });

          if (error) {
            let errorMessage = error.message;
            if (error.message.includes('User already registered')) {
              errorMessage = "Account already exists. Please login instead.";
            }
            this.showNotification(errorMessage, "error");
          } else {
            this.showNotification("Signup successful! Please check your email for verification.", "success");
            // Switch to login tab
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            document.querySelector('[data-tab="login"]').classList.add('active');
            document.getElementById('loginForm').classList.remove('hidden');
          }
        } catch (error) {
          this.showNotification("Signup failed. Please try again.", "error");
          console.error("Signup error:", error);
        } finally {
          // Reset button state
          signupBtn.textContent = originalText;
          signupBtn.disabled = false;
        }
      }

      async handleLogout() {
        try {
          const { error } = await this.supabase.auth.signOut();

          if (error) {
            this.showNotification("Logout failed", "error");
            console.error("Logout error:", error);
          } else {
            // Reset app state
            this.isAuthenticated = false;
            this.userData = null;
            this.userReports = [];
            this.nearbyReports = [];

            // Update UI
            this.updateUserInfo();
            this.showAuthModal();
            this.loadInitialData();

            this.showNotification("Logged out successfully", "success");
          }
        } catch (error) {
          this.showNotification("Logout failed", "error");
          console.error("Logout error:", error);
        }
      }
      
      async syncUserWithSupabase() {
        if (!this.userData) {
          console.error("No userData available for sync");
          return false;
        }

        console.log("Syncing user with Supabase:", this.userData.id);

        try {
          // Check if user exists in users table
          const { data, error } = await this.supabase
            .from('users')
            .select('*')
            .eq('user_id', this.userData.id)
            .maybeSingle();

          if (error) {
            console.error("Error checking user in database:", error);
            console.error("Check error details:", JSON.stringify(error, null, 2));
            return false;
          } else if (data) {
            // Update user data with Supabase info
            console.log("User found in database:", data);
            this.userData.reputation = data.reputation || 0;
            this.userData.language = data.language || 'en';
            this.currentLanguage = data.language || 'en';
            this.applyLanguage(this.currentLanguage);

            // Update language selector
            document.getElementById('languageSelect').value = this.currentLanguage;
            document.getElementById('currentLanguage').textContent = this.currentLanguage === 'en' ? 'EN' : 'AR';

            return true;
          } else {
            // User doesn't exist in users table, create a new record
            console.log("User not found in users table, creating new record");
            const { data: newUser, error: insertError } = await this.supabase
              .from('users')
              .insert([
                {
                  user_id: this.userData.id,
                  username: this.userData.username || this.userData.first_name || 'User',
                  reputation: 0,
                  language: 'en'
                }
              ])
              .select()
              .single();

            if (insertError) {
              console.error("Error creating user in database:", insertError);
              console.error("Insert error details:", JSON.stringify(insertError, null, 2));
              return false;
            }

            console.log("User created successfully:", newUser);
            this.userData.reputation = 0;
            this.userData.language = 'en';
            return true;
          }
        } catch (error) {
          console.error("Error syncing user with Supabase:", error);
          console.error("Sync error details:", JSON.stringify(error, null, 2));
          return false;
        }
      }
      
      updateConnectionStatus(connected) {
        this.isConnected = connected;
        // Connection status display removed - keeping internal state for functionality
      }
      
      updateUserInfo() {
        if (this.userData) {
          const usernameElement = document.getElementById('settingsUsername');
          if (usernameElement) {
            usernameElement.textContent = this.userData.username || this.userData.first_name;
          }
          
          document.getElementById('userReputation').textContent = this.userData.reputation || 0;
          document.getElementById('settingsReputation').textContent = this.userData.reputation || 0;
        }
      }
      
      async loadInitialData() {
        await this.loadNearbyReports();
        if (this.isAuthenticated) {
          await this.loadUserReports();
        }
        this.loadMap();
      }
      
      async loadNearbyReports(retryCount = 0) {
        const maxRetries = 2;

        try {
          document.getElementById('nearbyReports').innerHTML = '<div class="loading-spinner"></div>';

          // Performance optimization: Load fewer reports initially (5 instead of 20)
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select(`id, vibe_type, location, notes, created_at, upvotes, downvotes, latitude, longitude, votes (user_id, vote_type)`)
            .order('created_at', { ascending: false })
            .limit(5);

          if (error) {
            console.error("Error loading reports:", error);

            // Retry on network errors
            if (retryCount < maxRetries && (error.message.includes('network') || error.message.includes('fetch'))) {
              console.log(`Retrying loadNearbyReports (${retryCount + 1}/${maxRetries})...`);
              setTimeout(() => this.loadNearbyReports(retryCount + 1), 1000);
              return;
            }

            document.getElementById('nearbyReports').innerHTML =
              '<div class="no-data" data-en="Error loading reports. Please try again." data-ar="   .    .">Error loading reports. Please try again.</div>';
            return;
          }

          this.nearbyReports = reports.map(report => {
            const userVote = report.votes && report.votes.length > 0 ?
              report.votes.find(v => v.user_id === this.userData?.id)?.vote_type : null;

            return { ...report, user_vote: userVote };
          });

          this.displayNearbyReports();
        } catch (error) {
          console.error("Error loading nearby reports:", error);

          if (retryCount < maxRetries) {
            console.log(`Retrying loadNearbyReports (${retryCount + 1}/${maxRetries})...`);
            setTimeout(() => this.loadNearbyReports(retryCount + 1), 1000);
            return;
          }

          document.getElementById('nearbyReports').innerHTML =
            '<div class="no-data" data-en="Error loading reports. Please try again." data-ar="   .    .">Error loading reports. Please try again.</div>';
        }
      }
      
      displayNearbyReports() {
        const container = document.getElementById('nearbyReports');

        if (!this.nearbyReports || this.nearbyReports.length === 0) {
          container.innerHTML = '<div class="no-data" data-en="No reports nearby" data-ar="   ">No reports nearby</div>';
          this.updateTextDirection();
          return;
        }

        container.innerHTML = this.nearbyReports.map(report => `
          <div class="report-item" data-id="${report.id}">
            <div class="report-info">
              <div class="report-type">
                <i class="${this.getVibeIcon(report.vibe_type)}"></i>
                <span data-en="${this.capitalizeFirstLetter(report.vibe_type)}" data-ar="${this.getVibeArabicName(report.vibe_type)}">
                  ${this.capitalizeFirstLetter(report.vibe_type)}
                </span>
              </div>
              <div class="report-details">${report.notes || ''}</div>
              <div class="report-meta">
                <span>${report.location || 'Unknown location'}</span>
                <span>${this.formatTimeAgo(report.created_at)}</span>
              </div>
            </div>
            <div class="report-actions">
              <button class="vote-btn upvote-btn ${report.user_vote === 'upvote' ? 'active' : ''}" data-report-id="${report.id}" data-vote-type="upvote" ${!this.isAuthenticated ? 'aria-disabled="true" title="Login to vote"' : ''}>
                <i class="fas fa-thumbs-up"></i> ${report.upvotes || 0}
              </button>
              <button class="vote-btn downvote-btn ${report.user_vote === 'downvote' ? 'active' : ''}" data-report-id="${report.id}" data-vote-type="downvote" ${!this.isAuthenticated ? 'aria-disabled="true" title="Login to vote"' : ''}>
                <i class="fas fa-thumbs-down"></i> ${report.downvotes || 0}
              </button>
            </div>
          </div>
        `).join('');

        // Vote buttons are handled by delegated event listener in setupEventListeners()

        this.updateTextDirection();
      }
      
      async loadUserReports() {
        if (!this.userData) return;
        
        try {
          document.getElementById('userReports').innerHTML = '<div class="loading-spinner"></div>';
          
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select('*')
            .eq('user_id', this.userData.id)
            .order('created_at', { ascending: false });
          
          if (error) {
            console.error("Error loading user reports:", error);
            document.getElementById('userReports').innerHTML = 
              '<div class="no-data" data-en="Error loading your reports" data-ar="   ">Error loading your reports</div>';
            return;
          }
          
          this.userReports = reports;
          this.displayUserReports();
        } catch (error) {
          console.error("Error loading user reports:", error);
          document.getElementById('userReports').innerHTML = 
            '<div class="no-data" data-en="Error loading your reports" data-ar="   ">Error loading your reports</div>';
        }
      }
      
      displayUserReports() {
        const container = document.getElementById('userReports');
        
        if (!this.userReports || this.userReports.length === 0) {
          container.innerHTML = '<div class="no-data" data-en="You haven\'t submitted any reports" data-ar="    ">You haven\'t submitted any reports</div>';
          this.updateTextDirection();
          return;
        }
        
        container.innerHTML = this.userReports.map(report => `
          <div class="report-item">
            <div class="report-info">
              <div class="report-type">
                <i class="${this.getVibeIcon(report.vibe_type)}"></i>
                <span data-en="${this.capitalizeFirstLetter(report.vibe_type)}" data-ar="${this.getVibeArabicName(report.vibe_type)}">
                  ${this.capitalizeFirstLetter(report.vibe_type)}
                </span>
              </div>
              <div class="report-details">${report.notes || ''}</div>
              <div class="report-meta">
                <span>${report.location || 'Unknown location'}</span>
                <span>${this.formatTimeAgo(report.created_at)}</span>
                <span> ${report.upvotes || 0}  ${report.downvotes || 0}</span>
              </div>
            </div>
          </div>
        `).join('');
        
        this.updateTextDirection();
      }
      
      async voteReport(reportId, voteType) {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to vote", "error");
          return;
        }

        try {
          // Get current session to ensure we're authenticated
          const { data: sessionData, error: sessionError } = await this.supabase.auth.getSession();

          if (sessionError || !sessionData.session) {
            this.showNotification("Authentication expired. Please login again.", "error");
            this.showAuthModal();
            return;
          }

          // Use the authenticated user ID from the session
          const authUserId = sessionData.session.user.id;

          const { data: existingVote, error: voteError } = await this.supabase
            .from('votes')
            .select('*')
            .eq('user_id', authUserId)
            .eq('report_id', reportId)
            .maybeSingle();

          if (voteError && voteError.code !== 'PGRST116') {
            console.error("Error checking vote:", voteError);
            this.showNotification("Failed to submit vote", "error");
            return;
          }

          let operation;

          if (existingVote) {
            if (existingVote.vote_type === voteType) {
              const { error: deleteError } = await this.supabase
                .from('votes')
                .delete()
                .eq('id', existingVote.id);

              if (deleteError) {
                console.error("Error removing vote:", deleteError);
                this.showNotification("Failed to update vote", "error");
                return;
              }

              operation = 'remove';
            } else {
              const { error: updateError } = await this.supabase
                .from('votes')
                .update({ vote_type: voteType })
                .eq('id', existingVote.id);

              if (updateError) {
                console.error("Error updating vote:", updateError);
                this.showNotification("Failed to update vote", "error");
                return;
              }

              operation = 'change';
            }
          } else {
            const { error: insertError } = await this.supabase
              .from('votes')
              .insert([
                {
                  user_id: authUserId,
                  report_id: reportId,
                  vote_type: voteType
                }
              ]);

            if (insertError) {
              console.error("Error inserting vote:", insertError);
              this.showNotification("Failed to submit vote", "error");
              return;
            }

            operation = 'add';
          }

      // Update UI locally for immediate feedback
      this.updateVoteUI(reportId, voteType, operation);
      this.showNotification("Vote recorded", "success");
        } catch (error) {
          console.error("Error voting on report:", error);
          this.showNotification("Failed to submit vote", "error");
        }
      }

      updateVoteUI(reportId, voteType, operation) {
        // Find the report item in the DOM
        const reportItem = document.querySelector(`.report-item[data-id="${reportId}"]`);
        if (!reportItem) return;

        // Find the vote buttons
        const upvoteBtn = reportItem.querySelector('.upvote-btn');
        const downvoteBtn = reportItem.querySelector('.downvote-btn');

        if (!upvoteBtn || !downvoteBtn) return;

        // Get current vote counts from the buttons
        let upvotes = parseInt(upvoteBtn.textContent.match(/\d+/)[0]) || 0;
        let downvotes = parseInt(downvoteBtn.textContent.match(/\d+/)[0]) || 0;

        // Update vote counts based on operation
        if (operation === 'add') {
          if (voteType === 'upvote') {
            upvotes++;
            upvoteBtn.classList.add('active');
            downvoteBtn.classList.remove('active');
          } else if (voteType === 'downvote') {
            downvotes++;
            downvoteBtn.classList.add('active');
            upvoteBtn.classList.remove('active');
          }
        } else if (operation === 'change') {
          if (voteType === 'upvote') {
            upvotes++;
            downvotes--;
            upvoteBtn.classList.add('active');
            downvoteBtn.classList.remove('active');
          } else if (voteType === 'downvote') {
            downvotes++;
            upvotes--;
            downvoteBtn.classList.add('active');
            upvoteBtn.classList.remove('active');
          }
        } else if (operation === 'remove') {
          if (voteType === 'upvote') {
            upvotes--;
            upvoteBtn.classList.remove('active');
          } else if (voteType === 'downvote') {
            downvotes--;
            downvoteBtn.classList.remove('active');
          }
        }

        // Update button text with new counts
        upvoteBtn.innerHTML = `<i class="fas fa-thumbs-up"></i> ${upvotes}`;
        downvoteBtn.innerHTML = `<i class="fas fa-thumbs-down"></i> ${downvotes}`;

        // Update local data for consistency
        const reportIndex = this.nearbyReports.findIndex(r => r.id == reportId);
        if (reportIndex !== -1) {
          this.nearbyReports[reportIndex].upvotes = upvotes;
          this.nearbyReports[reportIndex].downvotes = downvotes;
          this.nearbyReports[reportIndex].user_vote = operation === 'remove' ? null : voteType;
        }
      }

      showReportModal() {
        this.selectedVibe = null;
        document.querySelectorAll('.vibe-option').forEach(option => {
          option.classList.remove('selected');
        });

        // Get current location automatically
        this.getCurrentLocation((location) => {
          this.currentReportLocation = location;
        });

        document.getElementById('reportNotes').value = '';
        document.getElementById('reportModal').style.display = 'block';
      }
      
      selectVibe(vibe) {
        this.selectedVibe = vibe;
        document.querySelectorAll('.vibe-option').forEach(option => {
          option.classList.remove('selected');
        });
        document.querySelector(`.vibe-option[data-vibe="${vibe}"]`).classList.add('selected');
      }
      
      async submitReport() {
        if (!this.selectedVibe) {
          this.showNotification("Please select a vibe type", "error");
          return;
        }

        if (!this.currentReportLocation) {
          this.showNotification("Unable to get your location. Please try again.", "error");
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitReportBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        submitBtn.disabled = true;

        try {
          const notes = document.getElementById('reportNotes').value;

          // Check for existing report with same vibe and location
          const { data: existingReports, error: checkError } = await this.supabase
            .from('reports')
            .select('id, created_at')
            .eq('vibe_type', this.selectedVibe)
            .eq('location', this.currentReportLocation)
            .order('created_at', { ascending: false })
            .limit(1);

          if (checkError) {
            console.error("Error checking for existing reports:", checkError);
          } else if (existingReports && existingReports.length > 0) {
            const existingReport = existingReports[0];
            const reportTime = new Date(existingReport.created_at);
            const now = new Date();
            const timeDiff = (now - reportTime) / (1000 * 60); // Difference in minutes

            // If a similar report exists within the last 30 minutes, don't create a duplicate
            if (timeDiff < 30) {
              this.showNotification(`A ${this.capitalizeFirstLetter(this.selectedVibe)} report already exists for this location. Please try again later.`, "warning");
              this.closeModal('reportModal');
              return;
            }
          }

          // Prepare report data with coordinates if available
          const reportData = {
            user_id: null, // Anonymous report - no user association
            vibe_type: this.selectedVibe,
            location: this.currentReportLocation,
            notes: notes || null
          };

          // Add coordinates if available
          if (this.userLocation) {
            reportData.latitude = this.userLocation.latitude;
            reportData.longitude = this.userLocation.longitude;
          }

          console.log("Submitting report:", reportData);

          const { data, error } = await this.supabase
            .from('reports')
            .insert([reportData])
            .select();

          if (error) {
            console.error("Error submitting report:", error);
            let errorMessage = "Failed to submit report";
            if (error.message.includes('network') || error.message.includes('fetch')) {
              errorMessage = "Network error. Please check your connection and try again.";
            } else {
              errorMessage = `Failed to submit report: ${error.message}`;
            }
            this.showNotification(errorMessage, "error");
          } else {
            console.log("Report submitted successfully:", data);
            this.showNotification("Report submitted successfully", "success");
            this.closeModal('reportModal');
            // Reload data to show the new report
            await this.loadNearbyReports();
            // Refresh map to show new report
            this.loadMap();
          }
        } catch (error) {
          console.error("Error submitting report:", error);
          let errorMessage = "Failed to submit report";
          if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = "Network error. Please check your connection and try again.";
          }
          this.showNotification(errorMessage, "error");
        } finally {
          // Reset button state
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }
      
      showEmergencyReport() {
        // Get current location automatically
        this.getCurrentLocation((location) => {
          this.currentEmergencyLocation = location;
        });

        document.getElementById('emergencyDetails').value = '';
        document.getElementById('emergencyModal').style.display = 'block';
      }
      
      async submitEmergencyReport() {
        if (!this.currentEmergencyLocation) {
          this.showNotification("Unable to get your location. Please try again.", "error");
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitEmergencyBtn');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'Submitting...';
        submitBtn.disabled = true;

        try {
          const emergencyType = document.getElementById('emergencyType').value;
          const details = document.getElementById('emergencyDetails').value;

          if (!details) {
            this.showNotification("Please provide emergency details", "error");
            return;
          }

          // Check for existing emergency report with same location (within last 2 hours for emergencies)
          const { data: existingReports, error: checkError } = await this.supabase
            .from('reports')
            .select('id, created_at')
            .eq('vibe_type', 'dangerous')
            .eq('location', this.currentEmergencyLocation)
            .order('created_at', { ascending: false })
            .limit(1);

          if (checkError) {
            console.error("Error checking for existing emergency reports:", checkError);
          } else if (existingReports && existingReports.length > 0) {
            const existingReport = existingReports[0];
            const reportTime = new Date(existingReport.created_at);
            const now = new Date();
            const timeDiff = (now - reportTime) / (1000 * 60 * 60); // Difference in hours

            // If an emergency report exists within the last 2 hours for the same location, don't create a duplicate
            if (timeDiff < 2) {
              this.showNotification(`An emergency report already exists for this location. Emergency services may already be aware.`, "warning");
              this.closeModal('emergencyModal');
              return;
            }
          }

          console.log("Submitting emergency report:", {
            user_id: null, // Anonymous report - no user association
            vibe_type: 'dangerous',
            location: this.currentEmergencyLocation,
            notes: `EMERGENCY (${emergencyType}): ${details}`
          });

          const { data, error } = await this.supabase
            .from('reports')
            .insert([
              {
                user_id: null, // Anonymous report - no user association
                vibe_type: 'dangerous',
                location: this.currentEmergencyLocation,
                notes: `EMERGENCY (${emergencyType}): ${details}`
              }
            ])
            .select();

          if (error) {
            console.error("Error submitting emergency report:", error);
            let errorMessage = "Failed to submit emergency report";
            if (error.message.includes('network') || error.message.includes('fetch')) {
              errorMessage = "Network error. Please check your connection and try again.";
            } else {
              errorMessage = `Failed to submit emergency report: ${error.message}`;
            }
            this.showNotification(errorMessage, "error");
          } else {
            console.log("Emergency report submitted successfully:", data);
            this.showNotification("Emergency report submitted successfully", "success");
            this.closeModal('emergencyModal');
            // Reload data to show the new emergency report
            await this.loadNearbyReports();
            // Refresh map to show new emergency report
            this.loadMap();
          }
        } catch (error) {
          console.error("Error submitting emergency report:", error);
          let errorMessage = "Failed to submit emergency report";
          if (error.message.includes('network') || error.message.includes('fetch')) {
            errorMessage = "Network error. Please check your connection and try again.";
          }
          this.showNotification(errorMessage, "error");
        } finally {
          // Reset button state
          submitBtn.textContent = originalText;
          submitBtn.disabled = false;
        }
      }
      
      showView(viewId) {
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
        });

        document.getElementById(viewId + 'View').classList.add('active');
        document.querySelector(`.nav-btn[data-view="${viewId}"]`).classList.add('active');

        if (viewId === 'map') {
          this.loadMap();
        } else if (viewId === 'reports') {
          this.loadUserDashboard();
        } else if (viewId === 'settings') {
          // Attach logout button event listener when settings view is shown
          const logoutBtn = document.getElementById('logoutBtn');
          if (logoutBtn) {
            logoutBtn.addEventListener('click', this.handleLogout);
          }
        }
      }

      async loadUserDashboard() {
        if (!this.isAuthenticated || !this.userData) {
          this.showAuthModal();
          return;
        }

        // Load all dashboard components
        await Promise.all([
          this.loadUserProfile(),
          this.loadUserBadges(),
          this.loadUserStats(),
          this.loadUserRecentActivity()
        ]);
      }

      async loadUserProfile() {
        const profileSection = document.getElementById('userProfileSection');

        try {
          // Get user reputation and basic info
          const reputation = await this.calculateUserReputation(this.userData.id);

          profileSection.innerHTML = `
            <div class="user-profile-card">
              <div class="user-avatar">
                <i class="fas fa-user-circle"></i>
              </div>
              <div class="user-info">
                <h3>${this.userData.username || this.userData.first_name || 'User'}</h3>
                <div class="reputation-display ${reputation > 50 ? 'high' : ''}">
                  <i class="fas fa-star"></i>
                  <span>${reputation} Reputation Points</span>
                </div>
                <p class="user-join-date">Member since ${new Date(this.userData.created_at || Date.now()).toLocaleDateString()}</p>
              </div>
            </div>
          `;
        } catch (error) {
          console.error("Error loading user profile:", error);
          profileSection.innerHTML = `
            <div class="user-profile-card">
              <div class="user-avatar">
                <i class="fas fa-user-circle"></i>
              </div>
              <div class="user-info">
                <h3>${this.userData.username || this.userData.first_name || 'User'}</h3>
                <p>Error loading profile data</p>
              </div>
            </div>
          `;
        }
      }

      async loadUserBadges() {
        const badgesContainer = document.getElementById('userBadges');

        try {
          const badges = await this.getUserBadges(this.userData.id);

          if (badges.length === 0) {
            badgesContainer.innerHTML = `
              <div class="no-data">
                <i class="fas fa-medal"></i>
                <p>No badges earned yet. Start reporting to unlock achievements!</p>
              </div>
            `;
            return;
          }

          badgesContainer.innerHTML = badges.map(badge => `
            <div class="badge-item unlocked">
              <div class="badge-icon" style="background: linear-gradient(135deg, ${badge.color}, ${badge.color}dd);">
                <i class="${badge.icon}"></i>
              </div>
              <div class="badge-name">${badge.name}</div>
              <div class="badge-description">${badge.description}</div>
            </div>
          `).join('');
        } catch (error) {
          console.error("Error loading user badges:", error);
          badgesContainer.innerHTML = '<div class="no-data">Error loading badges</div>';
        }
      }

      async loadUserStats() {
        try {
          // Get user's reports for stats
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select('upvotes, created_at, vibe_type')
            .eq('user_id', this.userData.id);

          if (error) {
            console.error("Error loading user stats:", error);
            return;
          }

          const totalReports = reports.length;
          const totalUpvotes = reports.reduce((sum, r) => sum + (r.upvotes || 0), 0);
          const reputation = await this.calculateUserReputation(this.userData.id);

          // Calculate community rank (simplified - would need more complex query in production)
          const rank = await this.calculateUserRank(this.userData.id);

          // Update stats display
          document.getElementById('userTotalReports').textContent = totalReports;
          document.getElementById('userTotalUpvotes').textContent = totalUpvotes;
          document.getElementById('userReputationScore').textContent = reputation;
          document.getElementById('userRank').textContent = rank || '-';
        } catch (error) {
          console.error("Error loading user stats:", error);
        }
      }

      async calculateUserRank(userId) {
        try {
          // Get all users with their reputation scores
          const { data: allUsers, error } = await this.supabase
            .from('users')
            .select('user_id, reputation')
            .order('reputation', { ascending: false });

          if (error) {
            console.error("Error calculating user rank:", error);
            return null;
          }

          const userIndex = allUsers.findIndex(user => user.user_id === userId);
          return userIndex !== -1 ? userIndex + 1 : null;
        } catch (error) {
          console.error("Error calculating user rank:", error);
          return null;
        }
      }

      async loadUserRecentActivity() {
        const activityContainer = document.getElementById('userRecentActivity');

        try {
          // Get user's recent reports
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select('*')
            .eq('user_id', this.userData.id)
            .order('created_at', { ascending: false })
            .limit(5);

          if (error) {
            console.error("Error loading user recent activity:", error);
            activityContainer.innerHTML = '<div class="no-data">Error loading recent activity</div>';
            return;
          }

          if (reports.length === 0) {
            activityContainer.innerHTML = `
              <div class="no-data">
                <i class="fas fa-plus-circle"></i>
                <p>No recent activity. Submit your first report to get started!</p>
              </div>
            `;
            return;
          }

          activityContainer.innerHTML = reports.map(report => `
            <div class="report-item">
              <div class="report-info">
                <div class="report-type">
                  <i class="${this.getVibeIcon(report.vibe_type)}"></i>
                  <span data-en="${this.capitalizeFirstLetter(report.vibe_type)}" data-ar="${this.getVibeArabicName(report.vibe_type)}">
                    ${this.capitalizeFirstLetter(report.vibe_type)}
                  </span>
                </div>
                <div class="report-details">${report.notes || ''}</div>
                <div class="report-meta">
                  <span>${report.location || 'Unknown location'}</span>
                  <span>${this.formatTimeAgo(report.created_at)}</span>
                  <span> ${report.upvotes || 0}  ${report.downvotes || 0}</span>
                </div>
              </div>
            </div>
          `).join('');

          this.updateTextDirection();
        } catch (error) {
          console.error("Error loading user recent activity:", error);
          activityContainer.innerHTML = '<div class="no-data">Error loading recent activity</div>';
        }
      }
      
      loadMap() {
        const mapContainer = document.getElementById('mapContainer');
        const hasReports = this.nearbyReports && this.nearbyReports.length > 0;

        // Clear any existing map
        if (this.map) {
          this.map.remove();
          this.map = null;
        }

        mapContainer.innerHTML = `
          <div class="map-header">
            <h3 data-en="Community Vibe Map" data-ar="  ">Community Vibe Map</h3>
            <p data-en="${hasReports ? 'Showing recent reports in your area' : 'Map of your area - submit reports to see them here'}" data-ar="${hasReports ? '    ' : '  -    '}">
              ${hasReports ? 'Showing recent reports in your area' : 'Map of your area - submit reports to see them here'}
            </p>
          </div>
          <div id="leaflet-map" style="height: 320px; width: 100%; position: relative;"></div>
          <div class="map-controls">
            <button id="myLocationBtn" class="map-control-btn" title="Go to my location">
              <i class="fas fa-crosshairs"></i>
            </button>
          </div>
          <div class="map-legend">
            <div class="legend-item"><i class="fas fa-users" style="color: orange;"></i> <span data-en="Crowded" data-ar="">Crowded</span></div>
            <div class="legend-item"><i class="fas fa-volume-up" style="color: var(--secondary);"></i> <span data-en="Noisy" data-ar="">Noisy</span></div>
            <div class="legend-item"><i class="fas fa-glass-cheers" style="color: var(--success);"></i> <span data-en="Festive" data-ar="">Festive</span></div>
            <div class="legend-item"><i class="fas fa-peace" style="color: var(--info);"></i> <span data-en="Calm" data-ar="">Calm</span></div>
            <div class="legend-item"><i class="fas fa-eye-slash" style="color: var(--warning);"></i> <span data-en="Suspicious" data-ar="">Suspicious</span></div>
            <div class="legend-item"><i class="fas fa-exclamation-triangle" style="color: var(--danger);"></i> <span data-en="Dangerous" data-ar="">Dangerous</span></div>
          </div>
        `;

        // Initialize Leaflet map
        this.initializeLeafletMap();

        this.updateTextDirection();
      }

      initializeLeafletMap() {
        const mapElement = document.getElementById('leaflet-map');
        if (!mapElement) return;

        // Default center (can be user's location if available)
        let initialCenter = [30.0444, 31.2357]; // Cairo, Egypt as default
        let initialZoom = 10;

        // If we already have user location, use it
        if (this.userLocation) {
          initialCenter = [this.userLocation.latitude, this.userLocation.longitude];
          initialZoom = 13;
        }

        // Create map
        this.map = L.map('leaflet-map').setView(initialCenter, initialZoom);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: ' <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          maxZoom: 19,
        }).addTo(this.map);

        // Add markers for reports
        this.addReportMarkers();

        // Try to get user's location for better centering if not already available
        if (navigator.geolocation && !this.userLocation) {
          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              this.userLocation = { latitude, longitude };
              this.map.setView([latitude, longitude], 13);
            },
            (error) => {
              console.log('Geolocation not available or denied');
            },
            { timeout: 10000, enableHighAccuracy: true }
          );
        }

        // Add event listener for My Location button
        const myLocationBtn = document.getElementById('myLocationBtn');
        if (myLocationBtn) {
          myLocationBtn.addEventListener('click', () => {
            this.centerMapOnUserLocation();
          });
        }
      }

      async centerMapOnUserLocation() {
        if (!navigator.geolocation) {
          this.showNotification("Geolocation is not supported by this browser", "error");
          return;
        }

        // Show loading state
        const locationBtn = document.getElementById('myLocationBtn');
        if (locationBtn) {
          locationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
          locationBtn.disabled = true;
        }

        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              timeout: 20000, // Increased timeout to 20 seconds
              enableHighAccuracy: true,
              maximumAge: 300000 // Accept cached position up to 5 minutes old
            });
          });

          const { latitude, longitude } = position.coords;
          this.userLocation = { latitude, longitude };

          if (this.map) {
            this.map.setView([latitude, longitude], 15);
            this.showNotification("Centered on your location", "success");
          }
        } catch (error) {
          console.error('Error getting location:', error);
          let errorMessage = "Unable to get your location";
          if (error.code === 1) {
            errorMessage = "Location access denied. Please enable location permissions in your browser settings.";
          } else if (error.code === 2) {
            errorMessage = "Location unavailable. Please check your GPS settings and try again.";
          } else if (error.code === 3) {
            errorMessage = "Location request timed out. This can happen in poor signal areas. Please try again.";
          }
          this.showNotification(errorMessage, "error");
        } finally {
          // Reset button state
          if (locationBtn) {
            locationBtn.innerHTML = '<i class="fas fa-crosshairs"></i>';
            locationBtn.disabled = false;
          }
        }
      }

      addReportMarkers() {
        if (!this.map || !this.nearbyReports) return;

        // Clear existing markers
        this.map.eachLayer((layer) => {
          if (layer instanceof L.Marker) {
            this.map.removeLayer(layer);
          }
        });

        // Add markers for each report
        this.nearbyReports.forEach(report => {
          // Use actual coordinates if available, otherwise use default location with slight randomization
          let lat, lng;
          if (report.latitude && report.longitude) {
            lat = report.latitude;
            lng = report.longitude;
          } else {
            // Default to Cairo area with some randomization
            const baseLat = 30.0444;
            const baseLng = 31.2357;
            lat = baseLat + (Math.random() - 0.5) * 0.1;
            lng = baseLng + (Math.random() - 0.5) * 0.1;
          }

          // Create custom icon based on vibe type
          const iconHtml = `<div style="
            background: ${this.getVibeColor(report.vibe_type)};
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          ">
            <i class="${this.getVibeIcon(report.vibe_type)}" style="color: white; font-size: 12px;"></i>
          </div>`;

          const customIcon = L.divIcon({
            html: iconHtml,
            className: 'custom-marker',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
          });

          // Create marker
          const marker = L.marker([lat, lng], { icon: customIcon }).addTo(this.map);

          // Add popup with report details
          const popupContent = `
            <div style="font-family: 'Segoe UI', sans-serif; max-width: 200px;">
              <h4 style="margin: 0 0 8px 0; color: ${this.getVibeColor(report.vibe_type)};">
                ${this.capitalizeFirstLetter(report.vibe_type)}
              </h4>
              <p style="margin: 4px 0;"><strong>Location:</strong> ${report.location || 'Unknown'}</p>
              ${report.notes ? `<p style="margin: 4px 0;"><strong>Notes:</strong> ${report.notes}</p>` : ''}
              <p style="margin: 4px 0; font-size: 12px; color: #666;">
                ${this.formatTimeAgo(report.created_at)}
              </p>
              <div style="margin-top: 8px;">
                <span style="color: #28a745;"> ${report.upvotes || 0}</span>
                <span style="color: #dc3545; margin-left: 8px;"> ${report.downvotes || 0}</span>
              </div>
            </div>
          `;

          marker.bindPopup(popupContent);
        });
      }

      getVibeColor(vibeType) {
        const colors = {
          crowded: '#FFA500',
          noisy: '#FF6B35',
          festive: '#28A745',
          calm: '#17A2B8',
          suspicious: '#FFC107',
          dangerous: '#DC3545'
        };
        return colors[vibeType] || '#6C757D';
      }
      
      displayMap() {
        // This will be called when the map view is shown
        this.loadMap();
      }
      
      async loadTopAreas() {
        try {
          // Show loading modal
          const modalContent = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 data-en="Top Areas" data-ar=" ">Top Areas</h2>
                <span class="close" data-dismiss="topAreasModal">&times;</span>
              </div>
              <div class="modal-body">
                <div class="loading-spinner"></div>
                <p data-en="Analyzing community reports..." data-ar="  ...">Analyzing community reports...</p>
              </div>
            </div>
          `;

          let modal = document.getElementById('topAreasModal');
          if (!modal) {
            modal = document.createElement('div');
            modal.id = 'topAreasModal';
            modal.className = 'modal';
            document.body.appendChild(modal);
          }
          modal.innerHTML = modalContent;
          modal.style.display = 'block';

          // Fetch reports with location data
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select('location, vibe_type, latitude, longitude')
            .not('location', 'is', null)
            .not('location', 'eq', 'Unknown Location')
            .not('location', 'eq', 'Location unavailable')
            .not('location', 'eq', 'Location not supported')
            .order('created_at', { ascending: false })
            .limit(100);

          if (error) {
            console.error("Error loading reports for top areas:", error);
            modal.innerHTML = `
              <div class="modal-content">
                <div class="modal-header">
                  <h2 data-en="Top Areas" data-ar=" ">Top Areas</h2>
                  <span class="close" data-dismiss="topAreasModal">&times;</span>
                </div>
                <div class="modal-body">
                  <p data-en="Error loading top areas data" data-ar="     ">Error loading top areas data</p>
                </div>
              </div>
            `;
            return;
          }

          // Analyze the data
          const areaStats = {};

          reports.forEach(report => {
            const location = report.location || 'Unknown';
            if (!areaStats[location]) {
              areaStats[location] = {
                total: 0,
                vibes: {},
                coordinates: report.latitude && report.longitude ? [report.latitude, report.longitude] : null
              };
            }

            areaStats[location].total++;
            if (!areaStats[location].vibes[report.vibe_type]) {
              areaStats[location].vibes[report.vibe_type] = 0;
            }
            areaStats[location].vibes[report.vibe_type]++;
          });

          // Convert to array and sort by total reports
          const topAreas = Object.entries(areaStats)
            .map(([location, data]) => ({ location, ...data }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 10);

          // Generate the modal content
          const areasHtml = topAreas.length > 0 ? topAreas.map((area, index) => `
            <div class="area-item">
              <div class="area-header">
                <div class="area-rank">#${index + 1}</div>
                <div class="area-info">
                  <h3>${area.location}</h3>
                  <span class="area-count">${area.total} report${area.total > 1 ? 's' : ''}</span>
                </div>
              </div>
              <div class="area-vibes">
                ${Object.entries(area.vibes)
                  .sort(([,a], [,b]) => b - a)
                  .map(([vibe, count]) => `
                    <span class="vibe-tag vibe-${vibe}">
                      <i class="${this.getVibeIcon(vibe)}"></i>
                      ${this.capitalizeFirstLetter(vibe)}: ${count}
                    </span>
                  `).join('')}
              </div>
            </div>
          `).join('') : `
            <p data-en="No area data available yet. Submit more reports to see top areas!" data-ar="    .       !">
              No area data available yet. Submit more reports to see top areas!
            </p>
          `;

          modal.innerHTML = `
            <div class="modal-content">
              <div class="modal-header">
                <h2 data-en="Top Areas" data-ar=" ">Top Areas</h2>
                <span class="close" data-dismiss="topAreasModal">&times;</span>
              </div>
              <div class="modal-body">
                <p data-en="Areas with the most community safety reports" data-ar="         ">
                  Areas with the most community safety reports
                </p>
                <div class="top-areas-list">
                  ${areasHtml}
                </div>
              </div>
            </div>
          `;

          // Attach close button event listener
          const closeBtn = modal.querySelector('.close');
          if (closeBtn) {
            closeBtn.addEventListener('click', () => {
              this.closeModal('topAreasModal');
            });
          }

          this.updateTextDirection();

        } catch (error) {
          console.error("Error loading top areas:", error);
          this.showNotification("Failed to load top areas", "error");
        }
      }
      
      toggleLanguage() {
        this.currentLanguage = this.currentLanguage === 'en' ? 'ar' : 'en';
        document.getElementById('currentLanguage').textContent = this.currentLanguage.toUpperCase();
        this.applyLanguage(this.currentLanguage);
        
        // Save language preference if user is authenticated
        if (this.isAuthenticated) {
          this.supabase
            .from('users')
            .update({ language: this.currentLanguage })
            .eq('user_id', this.userData.id)
            .then(({ error }) => {
              if (error) {
                console.error("Error updating language preference:", error);
              }
            });
        }
      }
      
      changeLanguage(lang) {
        this.currentLanguage = lang;
        document.getElementById('currentLanguage').textContent = this.currentLanguage.toUpperCase();
        this.applyLanguage(this.currentLanguage);
        
        // Save language preference if user is authenticated
        if (this.isAuthenticated) {
          this.supabase
            .from('users')
            .update({ language: this.currentLanguage })
            .eq('user_id', this.userData.id)
            .then(({ error }) => {
              if (error) {
                console.error("Error updating language preference:", error);
              }
            });
        }
      }
      
      applyLanguage(lang) {
        document.querySelectorAll('[data-en]').forEach(element => {
          if (element.getAttribute('data-' + lang)) {
            element.textContent = element.getAttribute('data-' + lang);
          }
        });
        
        this.updateTextDirection();
      }
      
      updateTextDirection() {
        document.body.setAttribute('dir', this.currentLanguage === 'ar' ? 'rtl' : 'ltr');
      }
      
      showNotification(message, type = 'info') {
        // Remove any existing notification
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
          existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        
        // Add icon based on notification type
        let icon = 'fas fa-info-circle';
        if (type === 'success') icon = 'fas fa-check-circle';
        if (type === 'error') icon = 'fas fa-exclamation-circle';
        if (type === 'warning') icon = 'fas fa-exclamation-triangle';
        
        notification.innerHTML = `<i class="${icon}"></i> <span>${message}</span>`;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 3000);
      }
      
      closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
      }
      
      getVibeIcon(vibeType) {
        const icons = {
          crowded: 'fas fa-users',
          noisy: 'fas fa-volume-up',
          festive: 'fas fa-glass-cheers',
          calm: 'fas fa-peace',
          suspicious: 'fas fa-eye-slash',
          dangerous: 'fas fa-exclamation-triangle'
        };
        
        return icons[vibeType] || 'fas fa-question-circle';
      }
      
      getVibeArabicName(vibeType) {
        const names = {
          crowded: '',
          noisy: '',
          festive: '',
          calm: '',
          suspicious: '',
          dangerous: ''
        };
        
        return names[vibeType] || vibeType;
      }
      
      capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
      
      formatTimeAgo(timestamp) {
        const now = new Date();
        const time = new Date(timestamp);
        const diffInSeconds = Math.floor((now - time) / 1000);
        
        if (diffInSeconds < 60) {
          return this.currentLanguage === 'en' ? 'Just now' : '';
        }
        
        const diffInMinutes = Math.floor(diffInSeconds / 60);
        if (diffInMinutes < 60) {
          return this.currentLanguage === 'en' 
            ? `${diffInMinutes} min ago` 
            : ` ${diffInMinutes} `;
        }
        
        const diffInHours = Math.floor(diffInMinutes / 60);
        if (diffInHours < 24) {
          return this.currentLanguage === 'en' 
            ? `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago` 
            : ` ${diffInHours} `;
        }
        
        const diffInDays = Math.floor(diffInHours / 24);
        return this.currentLanguage === 'en' 
          ? `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago` 
          : ` ${diffInDays} `;
      }
      
      getCurrentLocation(callback) {
        // Use cached location if available and recent (within 5 minutes)
        if (this.userLocation && this.userLocation.timestamp) {
          const age = Date.now() - this.userLocation.timestamp;
          if (age < 300000) { // 5 minutes
            this.getAddressFromCoordinates(this.userLocation.latitude, this.userLocation.longitude, (address) => {
              callback(address || `${this.userLocation.latitude.toFixed(4)}, ${this.userLocation.longitude.toFixed(4)}`);
            });
            return;
          }
        }

        if (navigator.geolocation) {
          // Show loading notification for location
          this.showNotification("Getting your location...", "info");

          navigator.geolocation.getCurrentPosition(
            (position) => {
              const { latitude, longitude } = position.coords;
              this.userLocation = {
                latitude,
                longitude,
                timestamp: Date.now()
              };

              // Try to get address from coordinates (reverse geocoding)
              this.getAddressFromCoordinates(latitude, longitude, (address) => {
                callback(address || `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
              });
            },
            (error) => {
              console.log('Geolocation error:', error);
              // Use fallback location for demo purposes
              const fallbackLocation = 'Demo Location';
              this.showNotification("Using demo location - enable GPS for accurate reporting", "warning");
              callback(fallbackLocation);
            },
            {
              timeout: 8000, // Reduced timeout for faster response
              enableHighAccuracy: true,
              maximumAge: 300000 // Accept cached position up to 5 minutes old
            }
          );
        } else {
          callback('Location not supported');
        }
      }

      getAddressFromCoordinates(lat, lng, callback) {
        // Use Nominatim (OpenStreetMap) for reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=16&addressdetails=1`)
          .then(response => response.json())
          .then(data => {
            if (data && data.display_name) {
              // Extract a simplified address
              const address = data.display_name.split(',')[0] + ', ' + data.display_name.split(',')[1];
              callback(address.trim());
            } else {
              callback(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
            }
          })
          .catch(error => {
            console.log('Reverse geocoding error:', error);
            callback(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
          });
      }

      requestUserLocation() {
        if (this.tg && this.tg.showPopup && this.tg.isLocationRequested) {
          try {
            this.tg.showPopup({
              title: "Location Access",
              message: "HyperApp needs your location to show nearby reports and map features.",
              buttons: [{ type: "ok", text: "Allow" }, { type: "cancel", text: "Deny" }]
            }, async (buttonId) => {
              if (buttonId === "ok") {
                this.tg.requestLocation();
              }
            });
          } catch (e) {
            console.log("Location request not available in this Telegram version");
          }
        }
      }
      
      setupEventListeners() {
        // Navigation buttons
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const view = e.currentTarget.getAttribute('data-view');
            this.showView(view);
          });
        });
        
        // Language switcher
        const languageSwitcher = document.getElementById('languageSwitcher');
        if (languageSwitcher) {
          languageSwitcher.addEventListener('click', this.toggleLanguage);
        }
        
        // Refresh button
        const refreshBtn = document.getElementById('refreshReports');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', this.loadNearbyReports);
        }
        
        // Quick action buttons
        document.querySelectorAll('.action-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const action = e.currentTarget.getAttribute('data-action');
            if (action === 'report') {
              this.showReportModal();
            } else if (action === 'areas') {
              this.loadTopAreas();
            } else if (action === 'emergency') {
              this.showEmergencyReport();
            }
          });
        });
        
        // Vibe option buttons
        document.querySelectorAll('.vibe-option').forEach(option => {
          option.addEventListener('click', (e) => {
            const vibe = e.currentTarget.getAttribute('data-vibe');
            this.selectVibe(vibe);
          });
        });
        
        // Modal close buttons
        document.querySelectorAll('.close').forEach(closeBtn => {
          closeBtn.addEventListener('click', (e) => {
            const modalId = e.target.getAttribute('data-dismiss');
            if (modalId) {
              this.closeModal(modalId);
            }
          });
        });
        
        // Form submit buttons
        const reportSubmitBtn = document.getElementById('submitReportBtn');
        if (reportSubmitBtn) {
          reportSubmitBtn.addEventListener('click', this.submitReport);
        }
        
        const emergencySubmitBtn = document.getElementById('submitEmergencyBtn');
        if (emergencySubmitBtn) {
          emergencySubmitBtn.addEventListener('click', this.submitEmergencyReport);
        }
        
        // Language select dropdown
        const languageSelect = document.getElementById('languageSelect');
        if (languageSelect) {
          languageSelect.addEventListener('change', (e) => {
            this.changeLanguage(e.target.value);
          });
        }

        // Logout button event delegation
        document.addEventListener('click', (e) => {
          if (e.target.id === 'logoutBtn' || e.target.closest('#logoutBtn')) {
            this.handleLogout();
          }
        });

        // Delegated vote buttons handler
        document.addEventListener('click', (e) => {
          const btn = e.target.closest('.vote-btn');
          if (!btn) return;

          e.preventDefault();

          // If user not authenticated, show auth modal and info
          if (btn.getAttribute('aria-disabled') === 'true') {
            this.showNotification("Please login to vote on reports", "info");
            this.showAuthModal();
            return;
          }

          const reportId = btn.dataset.reportId;
          const voteType = btn.dataset.voteType;
          if (reportId && voteType) {
            this.voteReport(reportId, voteType);
          }
        });

        // Map button in empty state
        document.addEventListener('click', (e) => {
          if (e.target.id === 'firstReportBtn' || e.target.closest('#firstReportBtn')) {
            this.showReportModal();
          }
        });

        // Filter buttons
        document.addEventListener('click', (e) => {
          const filterBtn = e.target.closest('.filter-btn');
          if (filterBtn) {
            const filter = filterBtn.dataset.filter;
            this.filterReports(filter);
          }
        });

        // Emergency contact buttons
        document.addEventListener('click', (e) => {
          const emergencyBtn = e.target.closest('.emergency-btn');
          if (emergencyBtn && emergencyBtn.dataset.contact) {
            const contact = emergencyBtn.dataset.contact;
            this.callEmergency(contact);
          }
        });

        // Theme toggle
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
          themeToggle.addEventListener('click', () => {
            this.toggleTheme();
          });
        }

        // Vibe category cards click handler
        document.addEventListener('click', (e) => {
          const vibeCard = e.target.closest('.vibe-category-card');
          if (vibeCard) {
            const vibeType = vibeCard.dataset.vibe;
            this.showVibeCategoryReports(vibeType);
          }
        });

        // Privacy policy button handler
        document.addEventListener('click', (e) => {
          if (e.target.closest('[data-action="privacy-policy"]')) {
            this.showPrivacyPolicy();
          }
        });

        // Refresh recent activity button handler
        document.addEventListener('click', (e) => {
          if (e.target.id === 'refreshRecentActivity' || e.target.closest('#refreshRecentActivity')) {
            this.loadUserRecentActivity();
            this.showNotification("Recent activity refreshed", "success");
          }
        });

        // Setup offline indicator
        this.setupOfflineIndicator();

        // Setup theme toggle buttons in settings
        this.setupThemeToggleButtons();
      }

      setupThemeToggleButtons() {
        const themeLightBtn = document.getElementById('themeLightBtn');
        const themeDarkBtn = document.getElementById('themeDarkBtn');

        if (themeLightBtn) {
          themeLightBtn.addEventListener('click', () => {
            this.setTheme('light');
          });
        }

        if (themeDarkBtn) {
          themeDarkBtn.addEventListener('click', () => {
            this.setTheme('dark');
          });
        }
      }

      setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('hyperapp-theme', theme);

        // Update theme toggle icon in header
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
          themeIcon.className = theme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        this.showNotification(`Switched to ${theme} theme`, 'info');
      }

      filterReports(filterType) {
        // Update active filter button
        document.querySelectorAll('.filter-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        document.querySelector(`[data-filter="${filterType}"]`).classList.add('active');

        // Filter reports
        const container = document.getElementById('nearbyReports');
        const reports = container.querySelectorAll('.report-item');

        reports.forEach(report => {
          const reportId = report.dataset.id;
          const reportData = this.nearbyReports.find(r => r.id == reportId);

          if (!reportData) return;

          if (filterType === 'all') {
            report.style.display = 'block';
          } else if (filterType === 'dangerous') {
            report.style.display = reportData.vibe_type === 'dangerous' ? 'block' : 'none';
          } else {
            report.style.display = reportData.vibe_type === filterType ? 'block' : 'none';
          }
        });

        // Update stats
        this.updateStats();
      }

      toggleTheme() {
        const root = document.documentElement;
        const currentTheme = root.getAttribute('data-theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

        root.setAttribute('data-theme', newTheme);

        // Update theme toggle icon
        const themeIcon = document.querySelector('#themeToggle i');
        if (themeIcon) {
          themeIcon.className = newTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
        }

        // Save theme preference
        localStorage.setItem('hyperapp-theme', newTheme);

        this.showNotification(`Switched to ${newTheme} theme`, 'info');
      }

      updateStats() {
        const totalReports = this.nearbyReports.length;
        const activeUsers = Math.max(1, Math.floor(totalReports / 3)); // Estimate based on reports

        document.getElementById('totalReports').textContent = totalReports;
        document.getElementById('activeUsers').textContent = activeUsers;

        // Update vibe category counts
        this.updateVibeCategories();
      }

      updateVibeCategories() {
        // Count reports by vibe type
        const vibeCounts = {
          crowded: 0,
          noisy: 0,
          festive: 0,
          calm: 0,
          suspicious: 0,
          dangerous: 0
        };

        this.nearbyReports.forEach(report => {
          if (vibeCounts.hasOwnProperty(report.vibe_type)) {
            vibeCounts[report.vibe_type]++;
          }
        });

        // Update the UI
        Object.keys(vibeCounts).forEach(vibe => {
          const countElement = document.getElementById(vibe + 'Count');
          if (countElement) {
            countElement.textContent = vibeCounts[vibe];
          }
        });
      }

      showVibeCategoryReports(vibeType) {
        // Filter reports by vibe type
        const filteredReports = this.nearbyReports.filter(report => report.vibe_type === vibeType);

        // Create modal content
        const modalContent = `
          <div class="modal-content">
            <div class="modal-header">
              <h2 data-en="${this.capitalizeFirstLetter(vibeType)} Reports" data-ar=" ${this.getVibeArabicName(vibeType)}">
                ${this.capitalizeFirstLetter(vibeType)} Reports
              </h2>
              <span class="close" data-dismiss="vibeCategoryModal">&times;</span>
            </div>
            <div class="modal-body">
              <p data-en="Showing ${filteredReports.length} ${vibeType} report${filteredReports.length !== 1 ? 's' : ''}" data-ar=" ${filteredReports.length}  ${this.getVibeArabicName(vibeType)}">
                Showing ${filteredReports.length} ${vibeType} report${filteredReports.length !== 1 ? 's' : ''}
              </p>
              <div class="reports-container">
                ${filteredReports.length > 0 ? filteredReports.map(report => `
                  <div class="report-item">
                    <div class="report-info">
                      <div class="report-type">
                        <i class="${this.getVibeIcon(report.vibe_type)}"></i>
                        <span data-en="${this.capitalizeFirstLetter(report.vibe_type)}" data-ar="${this.getVibeArabicName(report.vibe_type)}">
                          ${this.capitalizeFirstLetter(report.vibe_type)}
                        </span>
                      </div>
                      <div class="report-details">${report.notes || ''}</div>
                      <div class="report-meta">
                        <span>${report.location || 'Unknown location'}</span>
                        <span>${this.formatTimeAgo(report.created_at)}</span>
                      </div>
                    </div>
                    <div class="report-actions">
                      <button class="vote-btn upvote-btn ${report.user_vote === 'upvote' ? 'active' : ''}" data-report-id="${report.id}" data-vote-type="upvote" ${!this.isAuthenticated ? 'aria-disabled="true" title="Login to vote"' : ''}>
                        <i class="fas fa-thumbs-up"></i> ${report.upvotes || 0}
                      </button>
                      <button class="vote-btn downvote-btn ${report.user_vote === 'downvote' ? 'active' : ''}" data-report-id="${report.id}" data-vote-type="downvote" ${!this.isAuthenticated ? 'aria-disabled="true" title="Login to vote"' : ''}>
                        <i class="fas fa-thumbs-down"></i> ${report.downvotes || 0}
                      </button>
                    </div>
                  </div>
                `).join('') : `
                  <div class="no-data" data-en="No ${vibeType} reports found" data-ar="     ${this.getVibeArabicName(vibeType)}">
                    No ${vibeType} reports found
                  </div>
                `}
              </div>
            </div>
          </div>
        `;

        // Create or update modal
        let modal = document.getElementById('vibeCategoryModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'vibeCategoryModal';
          modal.className = 'modal';
          document.body.appendChild(modal);
        }
        modal.innerHTML = modalContent;
        modal.style.display = 'block';

        // Attach close button event listener
        const closeBtn = modal.querySelector('.close');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            this.closeModal('vibeCategoryModal');
          });
        }

        this.updateTextDirection();
      }

      callEmergency(contactType) {
        const emergencyNumbers = {
          police: '122',
          ambulance: '123',
          fire: '180',
          emergency: '112'
        };

        const number = emergencyNumbers[contactType];
        if (!number) return;

        // Try to call directly (works on mobile)
        window.location.href = `tel:${number}`;

        // Show confirmation
        this.showNotification(`Calling emergency services (${number})`, 'warning');
      }

      setupOfflineIndicator() {
        // Check online status
        const updateOnlineStatus = () => {
          const isOnline = navigator.onLine;
          const indicator = document.querySelector('.offline-indicator') || this.createOfflineIndicator();

          if (isOnline) {
            indicator.classList.add('online');
            indicator.classList.remove('offline-indicator'); // Hide when online
            indicator.style.display = 'none';
          } else {
            indicator.classList.remove('online');
            indicator.classList.add('offline-indicator');
            indicator.style.display = 'block';
            indicator.textContent = 'You are offline - reports will be cached';
          }
        };

        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // Initial check
        updateOnlineStatus();
      }

      createOfflineIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'offline-indicator';
        document.body.appendChild(indicator);
        return indicator;
      }

      async loadWeatherData() {
        if (!this.userLocation) {
          console.log("No user location available for weather data");
          // Show generic weather message
          this.updateWeatherAlert(null);
          return;
        }

        try {
          // Using OpenWeatherMap API with a working API key
          const apiKey = 'e1f274fc241ecaedd6103da6d31aaf94'; // Free tier API key
          const { latitude, longitude } = this.userLocation;

          // Add timeout to prevent hanging
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric`,
            {
              signal: controller.signal,
              headers: {
                'Accept': 'application/json'
              }
            }
          );

          clearTimeout(timeoutId);

          if (!response.ok) {
            throw new Error(`Weather API returned ${response.status}`);
          }

          const weatherData = await response.json();
          this.updateWeatherAlert(weatherData);
        } catch (error) {
          console.error("Error loading weather data:", error);
          // Fallback to generic weather message
          this.updateWeatherAlert(null);
        }
      }

      updateWeatherAlert(weatherData) {
        const weatherAlert = document.getElementById('weatherAlert');
        const alertTitle = weatherAlert.querySelector('.alert-title');
        const alertMessage = weatherAlert.querySelector('.alert-message');
        const weatherIcon = weatherAlert.querySelector('i');

        if (!weatherData) {
          // Fallback message
          alertTitle.textContent = this.currentLanguage === 'en' ? 'Weather Alert' : ' ';
          alertMessage.textContent = this.currentLanguage === 'en'
            ? 'Stay safe during weather changes'
            : '    ';
          weatherIcon.className = 'fas fa-cloud-sun';
          return;
        }

        const temp = Math.round(weatherData.main.temp);
        const condition = weatherData.weather[0].main.toLowerCase();
        const description = weatherData.weather[0].description;

        // Update icon based on weather condition
        const iconMap = {
          clear: 'fas fa-sun',
          clouds: 'fas fa-cloud',
          rain: 'fas fa-cloud-rain',
          drizzle: 'fas fa-cloud-rain',
          thunderstorm: 'fas fa-bolt',
          snow: 'fas fa-snowflake',
          mist: 'fas fa-smog',
          fog: 'fas fa-smog'
        };

        weatherIcon.className = iconMap[condition] || 'fas fa-cloud-sun';

        // Determine if weather requires safety alert
        const severeConditions = ['thunderstorm', 'rain', 'snow', 'fog'];
        const isSevere = severeConditions.includes(condition) ||
                        weatherData.main.temp < 5 ||
                        weatherData.main.temp > 35;

        if (isSevere) {
          alertTitle.textContent = this.currentLanguage === 'en' ? 'Weather Warning' : ' ';
          alertMessage.textContent = this.currentLanguage === 'en'
            ? `${temp}C - ${description}. Take precautions!`
            : `${temp}C - ${description}.  !`;
          weatherAlert.style.borderColor = 'rgba(255, 193, 7, 0.5)';
          weatherAlert.style.background = 'rgba(255, 193, 7, 0.1)';
        } else {
          alertTitle.textContent = this.currentLanguage === 'en' ? 'Weather Update' : ' ';
          alertMessage.textContent = this.currentLanguage === 'en'
            ? `${temp}C - ${description}. Enjoy your day!`
            : `${temp}C - ${description}.  !`;
          weatherAlert.style.borderColor = 'rgba(23, 162, 184, 0.3)';
          weatherAlert.style.background = 'rgba(23, 162, 184, 0.1)';
        }
      }

      updateSafetyHub() {
        // Load weather data
        this.loadWeatherData();

        // Generate dynamic safety tips based on recent reports
        this.generateDynamicSafetyTips();
      }

      generateDynamicSafetyTips() {
        const safetyTipsContainer = document.getElementById('safetyTips');

        if (!this.nearbyReports || this.nearbyReports.length === 0) {
          // Default tips when no reports
          safetyTipsContainer.innerHTML = `
            <div class="guideline-item">
              <i class="fas fa-users"></i>
              <span data-en="Avoid crowded areas after dark" data-ar="    ">Avoid crowded areas after dark</span>
            </div>
            <div class="guideline-item">
              <i class="fas fa-mobile-alt"></i>
              <span data-en="Keep your phone charged" data-ar="  ">Keep your phone charged</span>
            </div>
            <div class="guideline-item">
              <i class="fas fa-share-alt"></i>
              <span data-en="Share your location with trusted contacts" data-ar="     ">Share your location with trusted contacts</span>
            </div>
          `;
          return;
        }

        // Analyze recent reports to generate relevant safety tips
        const recentReports = this.nearbyReports.slice(0, 10); // Last 10 reports
        const vibeCounts = {};

        recentReports.forEach(report => {
          vibeCounts[report.vibe_type] = (vibeCounts[report.vibe_type] || 0) + 1;
        });

        const tips = [];

        // Generate tips based on most common vibes
        if (vibeCounts.dangerous > 0) {
          tips.push({
            icon: 'fas fa-exclamation-triangle',
            text: this.currentLanguage === 'en'
              ? 'High danger reports in area - stay vigilant'
              : '     -  '
          });
        }

        if (vibeCounts.crowded > vibeCounts.calm) {
          tips.push({
            icon: 'fas fa-users',
            text: this.currentLanguage === 'en'
              ? 'Area appears crowded - be aware of surroundings'
              : '   -    '
          });
        }

        if (vibeCounts.suspicious > 0) {
          tips.push({
            icon: 'fas fa-eye-slash',
            text: this.currentLanguage === 'en'
              ? 'Suspicious activity reported - trust your instincts'
              : '     -  '
          });
        }

        // Add default tips if we don't have enough specific ones
        if (tips.length < 3) {
          const defaultTips = [
            {
              icon: 'fas fa-mobile-alt',
              text: this.currentLanguage === 'en'
                ? 'Keep your phone charged and accessible'
                : '   '
            },
            {
              icon: 'fas fa-share-alt',
              text: this.currentLanguage === 'en'
                ? 'Share your location with trusted contacts'
                : '     '
            },
            {
              icon: 'fas fa-users',
              text: this.currentLanguage === 'en'
                ? 'Stay aware of your surroundings'
                : '   '
            }
          ];

          // Add default tips to fill up to 3
          while (tips.length < 3 && defaultTips.length > 0) {
            const tip = defaultTips.shift();
            if (!tips.find(t => t.text === tip.text)) {
              tips.push(tip);
            }
          }
        }

        // Limit to 3 tips and update UI
        const displayTips = tips.slice(0, 3);
        safetyTipsContainer.innerHTML = displayTips.map(tip => `
          <div class="guideline-item">
            <i class="${tip.icon}"></i>
            <span>${tip.text}</span>
          </div>
        `).join('');
      }

      showPrivacyPolicy() {
        const modalContent = `
          <div class="modal-content">
            <div class="modal-header">
              <h2 data-en="Privacy Policy" data-ar=" ">Privacy Policy</h2>
              <span class="close" data-dismiss="privacyModal">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
              <div style="text-align: left; line-height: 1.6;">
                <h3 data-en="Data Collection" data-ar=" ">Data Collection</h3>
                <p data-en="HyperApp collects location data and safety reports to help communities stay informed about local conditions. All reports are anonymous by default." data-ar=" HyperApp             .    .">
                  HyperApp collects location data and safety reports to help communities stay informed about local conditions. All reports are anonymous by default.
                </p>

                <h3 data-en="Location Data" data-ar=" ">Location Data</h3>
                <p data-en="Location information is used solely for safety reporting and map visualization. We do not share your precise location with third parties." data-ar="        .        .">
                  Location information is used solely for safety reporting and map visualization. We do not share your precise location with third parties.
                </p>

                <h3 data-en="Anonymous Reporting" data-ar=" ">Anonymous Reporting</h3>
                <p data-en="You can submit safety reports without creating an account. Reports are stored anonymously and cannot be traced back to individual users." data-ar="      .           .">
                  You can submit safety reports without creating an account. Reports are stored anonymously and cannot be traced back to individual users.
                </p>

                <h3 data-en="Account Data (Optional)" data-ar="  ()">Account Data (Optional)</h3>
                <p data-en="If you choose to create an account, we store your email and username for authentication and reputation tracking. This data is encrypted and never shared." data-ar="            .      .">
                  If you choose to create an account, we store your email and username for authentication and reputation tracking. This data is encrypted and never shared.
                </p>

                <h3 data-en="Data Retention" data-ar=" ">Data Retention</h3>
                <p data-en="Safety reports are retained indefinitely to maintain community safety records. Account data is kept as long as your account is active." data-ar="            .        .">
                  Safety reports are retained indefinitely to maintain community safety records. Account data is kept as long as your account is active.
                </p>

                <h3 data-en="Contact Us" data-ar=" ">Contact Us</h3>
                <p data-en="If you have any questions about this Privacy Policy, please contact us through the app or email us at privacy@hyperapp.com." data-ar="                     privacy@hyperapp.com.">
                  If you have any questions about this Privacy Policy, please contact us through the app or email us at privacy@hyperapp.com.
                </p>
              </div>
            </div>
          </div>
        `;

        // Create or update modal
        let modal = document.getElementById('privacyModal');
        if (!modal) {
          modal = document.createElement('div');
          modal.id = 'privacyModal';
          modal.className = 'modal';
          document.body.appendChild(modal);
        }
        modal.innerHTML = modalContent;
        modal.style.display = 'block';

        // Attach close button event listener
        const closeBtn = modal.querySelector('.close');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            this.closeModal('privacyModal');
          });
        }

        this.updateTextDirection();
      }

      async calculateUserReputation(userId) {
        if (!userId) return 0;

        try {
          // Get user's reports
          const { data: reports, error: reportsError } = await this.supabase
            .from('reports')
            .select('id, vibe_type, upvotes, downvotes, created_at')
            .eq('user_id', userId);

          if (reportsError) {
            console.error("Error fetching user reports for reputation:", reportsError);
            return 0;
          }

          // Get user's votes
          const { data: votes, error: votesError } = await this.supabase
            .from('votes')
            .select('vote_type')
            .eq('user_id', userId);

          if (votesError) {
            console.error("Error fetching user votes for reputation:", votesError);
            return 0;
          }

          let reputation = 0;

          // Base points for reports (10 points each)
          reputation += reports.length * 10;

          // Emergency reports bonus (2x multiplier)
          const emergencyReports = reports.filter(r => r.vibe_type === 'dangerous').length;
          reputation += emergencyReports * 10; // Additional 10 points for emergency reports

          // Quality multiplier based on upvotes/downvotes
          reports.forEach(report => {
            const totalVotes = (report.upvotes || 0) + (report.downvotes || 0);
            if (totalVotes > 0) {
              const upvoteRatio = (report.upvotes || 0) / totalVotes;
              if (upvoteRatio > 0.7) {
                reputation += 5; // Quality bonus for highly upvoted reports
              } else if (upvoteRatio < 0.3) {
                reputation -= 2; // Penalty for downvoted reports
              }
            }
          });

          // Community engagement bonus (voting on reports)
          reputation += votes.length * 2;

          // Consistency bonus (reports in last 7 days)
          const recentReports = reports.filter(r => {
            const reportDate = new Date(r.created_at);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return reportDate > weekAgo;
          }).length;

          if (recentReports > 0) {
            reputation += Math.min(recentReports * 3, 15); // Up to 15 points for consistency
          }

          // Minimum reputation of 0
          return Math.max(0, Math.round(reputation));
        } catch (error) {
          console.error("Error calculating reputation:", error);
          return 0;
        }
      }

      async updateUserReputation() {
        if (!this.isAuthenticated || !this.userData) return;

        try {
          const reputation = await this.calculateUserReputation(this.userData.id);

          // Update user data
          this.userData.reputation = reputation;

          // Update UI
          document.getElementById('userReputation').textContent = reputation;
          document.getElementById('settingsReputation').textContent = reputation;

          // Update database
          await this.supabase
            .from('users')
            .update({ reputation: reputation })
            .eq('user_id', this.userData.id);

          // Check for badge unlocks
          await this.checkBadgeUnlocks();

        } catch (error) {
          console.error("Error updating user reputation:", error);
        }
      }

      async getUserBadges(userId) {
        if (!userId) return [];

        try {
          // Get user's stats for badge calculation
          const { data: reports, error: reportsError } = await this.supabase
            .from('reports')
            .select('vibe_type, upvotes, created_at')
            .eq('user_id', userId);

          if (reportsError) {
            console.error("Error fetching reports for badges:", reportsError);
            return [];
          }

          const badges = [];
          const totalReports = reports.length;
          const totalUpvotes = reports.reduce((sum, r) => sum + (r.upvotes || 0), 0);
          const emergencyReports = reports.filter(r => r.vibe_type === 'dangerous').length;

          // Reporting Badges
          if (totalReports >= 1) badges.push({
            id: 'first_report',
            name: 'First Responder',
            icon: 'fas fa-plus-circle',
            description: 'Submitted your first safety report',
            color: '#28A745',
            unlocked: true
          });

          if (totalReports >= 10) badges.push({
            id: 'safety_guardian',
            name: 'Safety Guardian',
            icon: 'fas fa-shield-alt',
            description: 'Submitted 10+ safety reports',
            color: '#17A2B8',
            unlocked: true
          });

          if (emergencyReports >= 5) badges.push({
            id: 'emergency_responder',
            name: 'Emergency Responder',
            icon: 'fas fa-exclamation-triangle',
            description: 'Reported 5+ emergencies',
            color: '#DC3545',
            unlocked: true
          });

          // Community Badges
          if (totalUpvotes >= 50) badges.push({
            id: 'helpful_citizen',
            name: 'Helpful Citizen',
            icon: 'fas fa-hands-helping',
            description: 'Received 50+ upvotes on reports',
            color: '#FFC107',
            unlocked: true
          });

          if (totalUpvotes >= 100) badges.push({
            id: 'community_leader',
            name: 'Community Leader',
            icon: 'fas fa-crown',
            description: 'Received 100+ upvotes on reports',
            color: '#FF6B35',
            unlocked: true
          });

          // Quality Badges
          const highQualityReports = reports.filter(r => (r.upvotes || 0) > 5).length;
          if (highQualityReports >= 3) badges.push({
            id: 'trusted_reporter',
            name: 'Trusted Reporter',
            icon: 'fas fa-star',
            description: '3+ reports with high community approval',
            color: '#28A745',
            unlocked: true
          });

          // Engagement Badges
          const recentReports = reports.filter(r => {
            const reportDate = new Date(r.created_at);
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            return reportDate > weekAgo;
          }).length;

          if (recentReports >= 3) badges.push({
            id: 'active_contributor',
            name: 'Active Contributor',
            icon: 'fas fa-fire',
            description: '3+ reports in the last week',
            color: '#FF6B35',
            unlocked: true
          });

          return badges;
        } catch (error) {
          console.error("Error getting user badges:", error);
          return [];
        }
      }

      async checkBadgeUnlocks() {
        if (!this.isAuthenticated || !this.userData) return;

        try {
          const currentBadges = await this.getUserBadges(this.userData.id);
          const unlockedBadgeIds = currentBadges.map(b => b.id);

          // Check if we have new badges (this would need to be stored in localStorage or database)
          const previouslyUnlocked = JSON.parse(localStorage.getItem('hyperapp_unlocked_badges') || '[]');
          const newBadges = unlockedBadgeIds.filter(id => !previouslyUnlocked.includes(id));

          if (newBadges.length > 0) {
            // Show badge notification for new unlocks
            newBadges.forEach(badgeId => {
              const badge = currentBadges.find(b => b.id === badgeId);
              if (badge) {
                this.showBadgeNotification(badge);
              }
            });

            // Update stored badges
            localStorage.setItem('hyperapp_unlocked_badges', JSON.stringify(unlockedBadgeIds));
          }
        } catch (error) {
          console.error("Error checking badge unlocks:", error);
        }
      }

      showBadgeNotification(badge) {
        const notification = document.createElement('div');
        notification.className = 'notification success';
        notification.innerHTML = `
          <i class="fas fa-trophy"></i>
          <span><strong>Badge Unlocked!</strong> ${badge.name} - ${badge.description}</span>
        `;

        // Remove any existing notification
        const existingNotification = document.querySelector('.notification');
        if (existingNotification) {
          existingNotification.remove();
        }

        document.body.appendChild(notification);

        // Auto-remove after 5 seconds for badge notifications
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }

      async loadEnhancedStats() {
        try {
          // Get comprehensive stats
          const { data: reports, error } = await this.supabase
            .from('reports')
            .select('vibe_type, created_at, upvotes, downvotes, latitude, longitude')
            .order('created_at', { ascending: false })
            .limit(500);

          if (error) {
            console.error("Error loading enhanced stats:", error);
            return;
          }

          // Process stats data
          const stats = this.processStatsData(reports);

          // Update the stats display
          this.renderStatsCharts(stats);

        } catch (error) {
          console.error("Error loading enhanced stats:", error);
        }
      }

      processStatsData(reports) {
        const stats = {
          totalReports: reports.length,
          vibeDistribution: {},
          hourlyActivity: new Array(24).fill(0),
          dailyActivity: {},
          topLocations: {},
          averageUpvotes: 0,
          safetyScore: 0
        };

        let totalUpvotes = 0;

        reports.forEach(report => {
          // Vibe distribution
          stats.vibeDistribution[report.vibe_type] = (stats.vibeDistribution[report.vibe_type] || 0) + 1;

          // Hourly activity
          const hour = new Date(report.created_at).getHours();
          stats.hourlyActivity[hour]++;

          // Daily activity
          const date = new Date(report.created_at).toDateString();
          stats.dailyActivity[date] = (stats.dailyActivity[date] || 0) + 1;

          // Top locations (simplified)
          const location = report.latitude && report.longitude
            ? `${report.latitude.toFixed(2)},${report.longitude.toFixed(2)}`
            : 'Unknown';
          stats.topLocations[location] = (stats.topLocations[location] || 0) + 1;

          // Upvotes
          totalUpvotes += report.upvotes || 0;
        });

        stats.averageUpvotes = reports.length > 0 ? (totalUpvotes / reports.length).toFixed(1) : 0;

        // Calculate safety score (higher is safer)
        const dangerousReports = stats.vibeDistribution.dangerous || 0;
        const totalReports = stats.totalReports;
        stats.safetyScore = totalReports > 0 ? Math.round(((totalReports - dangerousReports) / totalReports) * 100) : 100;

        return stats;
      }

      renderStatsCharts(stats) {
        // Update existing stats
        document.getElementById('totalReports').textContent = stats.totalReports;

        // Ensure we have valid data for activity patterns
        const maxHourlyActivity = Math.max(...stats.hourlyActivity, 1); // Avoid division by zero

        // Create enhanced stats display
        const enhancedStatsHtml = `
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number">${stats.totalReports}</div>
              <div class="stat-label">Total Reports</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${stats.averageUpvotes}</div>
              <div class="stat-label">Avg. Upvotes</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${stats.safetyScore}%</div>
              <div class="stat-label">Safety Score</div>
            </div>
            <div class="stat-card">
              <div class="stat-number">${Object.keys(stats.dailyActivity).length}</div>
              <div class="stat-label">Active Days</div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">
              <i class="fas fa-chart-bar"></i>
              <span data-en="Vibe Distribution" data-ar=" ">Vibe Distribution</span>
            </div>
            <div class="vibe-distribution-chart">
              ${Object.entries(stats.vibeDistribution).length > 0 ?
                Object.entries(stats.vibeDistribution).map(([vibe, count]) => `
                  <div class="vibe-bar">
                    <div class="vibe-label">${this.capitalizeFirstLetter(vibe)}</div>
                    <div class="vibe-progress">
                      <div class="vibe-fill" style="width: ${(count / stats.totalReports) * 100}%; background: ${this.getVibeColor(vibe)}"></div>
                    </div>
                    <div class="vibe-count">${count}</div>
                  </div>
                `).join('') :
                '<div class="no-data">No vibe data available</div>'
              }
            </div>
          </div>

          <div class="card">
            <div class="card-title">
              <i class="fas fa-clock"></i>
              <span data-en="Activity Patterns" data-ar=" ">Activity Patterns</span>
            </div>
            <div class="activity-chart">
              <div class="activity-bars">
                ${stats.hourlyActivity.map((count, hour) => {
                  const height = maxHourlyActivity > 0 ? (count / maxHourlyActivity) * 100 : 0;
                  return `
                    <div class="activity-bar" title="${hour}:00 - ${count} reports" style="position: relative;">
                      <div class="activity-fill" style="height: ${Math.max(height, 2)}%; background: linear-gradient(180deg, var(--primary), var(--primary-dark));"></div>
                    </div>
                  `;
                }).join('')}
              </div>
              <div class="activity-labels">
                ${Array.from({length: 6}, (_, i) => `<span>${String(i * 4).padStart(2, '0')}:00</span>`).join('')}
              </div>
            </div>
          </div>
        `;

        // Replace the stats grid with enhanced version
        const statsContainer = document.getElementById('statsGrid').parentElement;
        statsContainer.innerHTML = enhancedStatsHtml;

        this.updateTextDirection();
      }

      setupWeatherAlerts() {
        // Set up weather alert checking (would run periodically)
        this.weatherAlertInterval = setInterval(() => {
          this.checkWeatherAlerts();
        }, 300000); // Check every 5 minutes

        // Initial check
        this.checkWeatherAlerts();
      }

      async checkWeatherAlerts() {
        if (!this.userLocation) return;

        try {
          const apiKey = 'e1f274fc241ecaedd6103da6d31aaf94'; // Free tier API key
          const { latitude, longitude } = this.userLocation;

          // Add timeout to prevent hanging
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 3000); // 3 second timeout for alerts

          const response = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${latitude}&lon=${longitude}&appid=${apiKey}&units=metric`,
            {
              signal: controller.signal,
              headers: {
                'Accept': 'application/json'
              }
            }
          );

          clearTimeout(timeoutId);

          if (!response.ok) return;

          const weatherData = await response.json();

          // Check for severe weather conditions
          const severeConditions = ['thunderstorm', 'rain', 'snow', 'fog'];
          const isSevere = severeConditions.includes(weatherData.weather[0].main.toLowerCase()) ||
                          weatherData.main.temp < 5 ||
                          weatherData.main.temp > 35;

          if (isSevere) {
            // Check if we already alerted recently (prevent spam)
            const lastAlert = localStorage.getItem('hyperapp_last_weather_alert');
            const now = Date.now();

            if (!lastAlert || (now - parseInt(lastAlert)) > 3600000) { // 1 hour cooldown
              this.sendWeatherAlert(weatherData);
              localStorage.setItem('hyperapp_last_weather_alert', now.toString());
            }
          }
        } catch (error) {
          console.error("Error checking weather alerts:", error);
          // Don't show error notifications for background weather checks
        }
      }

      sendWeatherAlert(weatherData) {
        const temp = Math.round(weatherData.main.temp);
        const condition = weatherData.weather[0].description;
        const mainCondition = weatherData.weather[0].main.toLowerCase();

        let alertMessage = '';
        let alertType = 'warning';

        if (mainCondition === 'thunderstorm') {
          alertMessage = ` Thunderstorm Warning: ${temp}C with ${condition}. Stay indoors and avoid open areas!`;
        } else if (mainCondition === 'rain' || mainCondition === 'drizzle') {
          alertMessage = ` Heavy Rain Alert: ${temp}C with ${condition}. Drive carefully and watch for flooding.`;
        } else if (mainCondition === 'snow') {
          alertMessage = ` Snow Warning: ${temp}C with ${condition}. Roads may be slippery - take precautions.`;
        } else if (mainCondition === 'fog') {
          alertMessage = ` Dense Fog Alert: ${temp}C with ${condition}. Reduce speed and use headlights.`;
        } else if (temp < 5) {
          alertMessage = ` Extreme Cold Warning: ${temp}C. Dress warmly and avoid prolonged exposure.`;
        } else if (temp > 35) {
          alertMessage = ` Extreme Heat Warning: ${temp}C. Stay hydrated and avoid direct sun exposure.`;
        }

        if (alertMessage) {
          const notification = document.createElement('div');
          notification.className = `notification ${alertType}`;
          notification.innerHTML = `<i class="fas fa-cloud-sun"></i> <span>${alertMessage}</span>`;

          // Remove any existing notification
          const existingNotification = document.querySelector('.notification');
          if (existingNotification) {
            existingNotification.remove();
          }

          document.body.appendChild(notification);

          // Weather alerts stay longer (10 seconds)
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 10000);
        }
      }

      updateCommunityInsights() {
        // Update community insights based on recent activity
        this.loadEnhancedStats();
        this.updateSafetyHub();

        // Update reputation for authenticated users
        if (this.isAuthenticated) {
          this.updateUserReputation();
        }
      }
    }

    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new HyperApp();
    });
  </script>
</body>
</html>
