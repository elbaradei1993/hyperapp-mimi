<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="HyperApp - Real-time safety community platform powered by Telegram Mini App">
    <meta name="keywords" content="safety, community, reports, vibes, location, telegram">
    <meta name="theme-color" content="#FF6B35">

    <!-- Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <title>HyperApp - Safety Hub</title>

    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
            text-rendering: optimizeLegibility;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            font-size: 14px;
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Theme Variables */
        :root[data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --bg-overlay: rgba(248, 249, 250, 0.95);
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --text-accent: #FF6B35;
            --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --success: #28a745;
            --warning: #ffc107;
            --error: #dc3545;
            --info: #17a2b8;
        }

        :root[data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-tertiary: #404040;
            --bg-overlay: rgba(26, 26, 26, 0.95);
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-accent: #FF8C69;
            --border-color: #404040;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --success: #40c057;
            --warning: #ffd43b;
            --error: #fa5252;
            --info: #339af0;
        }

        /* Layout Components */
        .container {
            max-width: 100%;
            padding: 0 16px;
            margin: 0 auto;
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #FF6B35, #FF8C69);
            padding: 20px 16px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 20"><circle cx="10" cy="5" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="30" cy="12" r="1" fill="rgba(255,255,255,0.1)"/><circle cx="70" cy="8" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="90" cy="15" r="1" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
            opacity: 0.1;
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .logo-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 20px;
            font-weight: bold;
        }

        .logo-icon {
            margin-right: 8px;
            font-size: 24px;
        }

        .connection-status {
            display: flex;
            align-items: center;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.2);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            margin-right: 4px;
        }

        .connected {
            background-color: var(--success);
        }

        .disconnected {
            background-color: var(--error);
        }

        .nav-tabs {
            display: flex;
            gap: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .nav-tab {
            padding: 8px 16px;
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .nav-tab.active {
            color: white;
            border-bottom-color: white;
        }

        /* Main Content */
        .main-content {
            min-height: calc(100vh - 140px);
            padding: 16px;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-accent);
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Reports List */
        .reports-list {
            space-y: 12px;
        }

        .report-card {
            background: var(--bg-secondary);
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }

        .report-vibe {
            display: flex;
            align-items: center;
            font-weight: bold;
            color: var(--text-accent);
        }

        .report-time {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .report-description {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .report-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .report-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--text-accent);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Safety Hub */
        .safety-section {
            margin-bottom: 24px;
        }

        .safety-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guidelines-list {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            box-shadow: var(--shadow);
        }

        .guideline-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .guideline-item:last-child {
            border-bottom: none;
        }

        .guideline-item i {
            color: var(--text-accent);
            width: 20px;
        }

        .high-priority i {
            color: var(--error);
        }

        .medium-priority i {
            color: var(--warning);
        }

        .low-priority i {
            color: var(--success);
        }

        /* Map */
        .map-container {
            height: 300px;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 16px; /* Prevent zoom on iOS */
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--text-accent);
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: modalFadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-primary);
            border-radius: 12px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.7); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
        }

        .modal-body {
            padding: 24px;
        }

        /* Auth Modal */
        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-tab.active {
            border-bottom-color: var(--text-accent);
            color: var(--text-accent);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--text-accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            z-index: 1001;
            max-width: 300px;
            animation: slideInFromRight 0.3s ease;
        }

        @keyframes slideInFromRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .notification.success {
            background: var(--success);
            color: white;
        }

        .notification.error {
            background: var(--error);
            color: white;
        }

        .notification.warning {
            background: var(--warning);
            color: black;
        }

        .notification.info {
            background: var(--info);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }

            .header {
                padding: 16px 12px;
            }

            .main-content {
                padding: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .nav-tab {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* Vibe Colors */
        .vibe-dangerous { color: var(--error); }
        .vibe-suspicious { color: var(--warning); }
        .vibe-crowded { color: #6f42c1; }
        .vibe-calm { color: var(--success); }
        .vibe-romantic { color: #e91e63; }
        .vibe-noisy { color: #ff5722; }
        .vibe-clean { color: #009688; }

        /* Utility Classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .mb-4 { margin-bottom: 16px; }
        .text-center { text-align: center; }
        .text-sm { font-size: 12px; }
        .font-bold { font-weight: bold; }
    </style>
</head>
<body id="hyperapp" data-theme="dark">
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-shield-alt logo-icon"></i>
                        <span>HyperApp</span>
                    </div>
                    <div id="connectionStatus" class="connection-status">
                        <i class="fas fa-wifi"></i>
                        <span>Connected</span>
                    </div>
                </div>
                <nav class="nav-tabs">
                    <button class="nav-tab active" data-view="dashboard">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </button>
                    <button class="nav-tab" data-view="reports">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Reports</span>
                    </button>
                    <button class="nav-tab" data-view="safety">
                        <i class="fas fa-shield-alt"></i>
                        <span>Safety Hub</span>
                    </button>
                    <button class="nav-tab" data-view="map">
                        <i class="fas fa-map"></i>
                        <span>Map</span>
                    </button>
                    <button class="nav-tab" data-view="profile">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </button>
                </nav>
                <div class="header-controls">
                    <button id="themeToggle" class="btn btn-sm" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <select id="languageSelect" class="form-select" style="width: auto; display: inline-block; margin-left: 8px;">
                        <option value="en">English</option>
                        <option value="ar">العربية</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content container">
        <!-- Dashboard View -->
        <section id="dashboard" class="view-section active">
            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-number" id="totalReports">0</div>
                    <div class="stat-label">Total Reports</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="nearbyReports">0</div>
                    <div class="stat-label">Nearby</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="userReputation">0</div>
                    <div class="stat-label">Reputation</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">?</div>
                    <div class="stat-label">Active Users</div>
                </div>
            </div>

            <!-- Safety Hub Section -->
            <div class="safety-section">
                <div class="safety-header">
                    <h2 class="section-title">
                        <i class="fas fa-shield-alt"></i>
                        Safety Hub
                    </h2>
                    <button class="btn btn-sm" onclick="window.hyperApp?.generateDynamicSafetyTips()">
                        <i class="fas fa-refresh"></i>
                        Refresh
                    </button>
                </div>
                <div id="safetyTips" class="guidelines-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading safety tips...
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="report-card">
                    <div class="report-header">
                        <div class="report-vibe">
                            <i class="fas fa-compass"></i>
                            <span>Quick Report</span>
                        </div>
                    </div>
                    <div class="report-description">
                        <p>Tap to quickly report the current vibe around you</p>
                    </div>
                    <div class="report-footer">
                        <button class="btn btn-primary" onclick="window.hyperApp?.showEmergencyReport()">
                            <i class="fas fa-exclamation-triangle"></i>
                            Emergency Report
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports View -->
        <section id="reports" class="view-section">
            <div class="card">
                <div class="modal-header">
                    <h3 class="modal-title">Nearby Reports</h3>
                    <button class="btn btn-sm" onclick="window.hyperApp?.loadNearbyReports()">
                        <i class="fas fa-refresh"></i>
                        Refresh
                    </button>
                </div>
                <div id="reportsList" class="modal-body reports-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading reports...
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="modal-header">
                    <h3 class="modal-title">My Reports</h3>
                </div>
                <div id="userReportsList" class="modal-body reports-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading your reports...
                    </div>
                </div>
            </div>
        </section>

        <!-- Safety Hub View -->
        <section id="safety" class="view-section">
            <div class="card">
                <div class="modal-header">
                    <h3 class="modal-title">Community Safety Insights</h3>
                    <button class="btn btn-sm" onclick="window.hyperApp?.generateDynamicSafetyTips()">
                        <i class="fas fa-refresh"></i>
                        Regenerate
                    </button>
                </div>
                <div id="safetyAnalysis" class="modal-body">
                    <div class="loading">
                        <div class="spinner"></div>
                        Analyzing community safety patterns...
                    </div>
                </div>
            </div>
        </section>

        <!-- Map View -->
        <section id="map" class="view-section">
            <div class="card">
                <div class="modal-header">
                    <h3 class="modal-title">Safety Map</h3>
                    <div class="modal-controls">
                        <button id="centerMap" class="btn btn-sm">
                            <i class="fas fa-crosshairs"></i>
                            Center
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <div id="mapContainer" class="map-container"></div>
                </div>
            </div>
        </section>

        <!-- Profile View -->
        <section id="profile" class="view-section">
            <div class="card">
                <div class="modal-header">
                    <h3 class="modal-title">Profile</h3>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <div id="settingsUsername">Loading...</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Reputation Score</label>
                        <div id="settingsReputation">0</div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Language</label>
                        <select id="settingsLanguage" class="form-select">
                            <option value="en">English</option>
                            <option value="ar">العربية</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Report Vibe</h3>
                <button class="modal-close" onclick="window.hyperApp?.closeModal('reportModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Vibe Type</label>
                    <div class="vibe-buttons" id="vibeButtons">
                        <button class="btn btn-sm vibe-btn" data-vibe="calm">
                            <i class="fas fa-peace"></i> Calm
                        </button>
                        <button class="btn btn-sm vibe-btn" data-vibe="crowded">
                            <i class="fas fa-users"></i> Crowded
                        </button>
                        <button class="btn btn-sm vibe-btn" data-vibe="noisy">
                            <i class="fas fa-volume-up"></i> Noisy
                        </button>
                        <button class="btn btn-sm vibe-btn" data-vibe="dangerous">
                            <i class="fas fa-exclamation-triangle"></i> Dangerous
                        </button>
                        <button class="btn btn-sm vibe-btn" data-vibe="suspicious">
                            <i class="fas fa-user-secret"></i> Suspicious
                        </button>
                        <button class="btn btn-sm vibe-btn" data-vibe="romantic">
                            <i class="fas fa-heart"></i> Romantic
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea id="reportDescription" class="form-textarea" placeholder="Describe what you observed..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="anonymousReport" checked> Submit anonymously
                    </label>
                </div>
                <button id="submitReportBtn" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-paper-plane"></i>
                    Submit Report
                </button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Authentication</h3>
                <button class="modal-close" id="closeAuth">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-tabs">
                    <button class="auth-tab active" data-tab="login">Login</button>
                    <button class="auth-tab" data-tab="signup">Sign Up</button>
                </div>

                <form id="loginForm" class="auth-form active">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="loginEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="loginPassword" class="form-input" required>
                    </div>
                    <button type="button" id="loginBtn" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>

                <form id="signupForm" class="auth-form">
                    <div class="form-group">
                        <label class="form-label">Username</label>
                        <input type="text" id="signupUsername" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" id="signupEmail" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" id="signupPassword" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" class="form-input" required>
                    </div>
                    <button type="button" id="signupBtn" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Emergency Report Modal -->
    <div id="emergencyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" style="color: var(--error);">
                    <i class="fas fa-exclamation-triangle"></i>
                    Emergency Report
                </h3>
                <button class="modal-close" onclick="window.hyperApp?.closeModal('emergencyModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--error); font-weight: bold;">
                    This is for immediate safety threats only!
                </p>
                <div class="form-group">
                    <label class="form-label">What's happening?</label>
                    <textarea id="emergencyDescription" class="form-textarea" placeholder="Describe the emergency situation..." required></textarea>
                </div>
                <button id="submitEmergencyBtn" class="btn btn-danger" style="width: 100%;">
                    <i class="fas fa-siren"></i>
                    Submit Emergency Report
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // HyperApp Mini App - Enhanced with AI-like safety intelligence
        class HyperApp {
            constructor() {
                // Configuration - Move these to environment variables in production
                this.config = {
                    supabaseUrl: 'https://nqwejzbayquzsvcodunl.supabase.co',
                    supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xd2VqemJheXF1enN2Y29kdW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTA0MjAsImV4cCI6MjA3Mzk2NjQyMH0.01yifC-tfEbBHD5u315fpb_nZrqMZCbma_UrMacMb78',
                    weatherApiKey: 'bd5e378503939ddaee76f12ad7a97608',
                    // Feature flags for graceful degradation
                    features: {
                        realtime: true,
                        geofencing: true,
                        weather: true,
                        map: true
                    }
                };

                // Dependency loading status
                this.dependenciesLoaded = {
                    telegram: false,
                    supabase: false,
                    leaflet: false,
                    leafletHeat: false,
                    fontAwesome: false
                };

                // Error tracking
                this.errors = [];
                this.fallbackMode = false;

                this.tg = window.Telegram.WebApp;
                this.currentLanguage = 'en';
                this.userData = null;
                this.nearbyReports = [];
                this.userReports = [];
                this.selectedVibe = null;
                this.isConnected = false;
                this.userLocation = null;
                this.isAuthenticated = false;

                // Initialize with error handling
                this.initializeApp();
            }

            // Medium-term error handling - balanced approach
            async initializeApp() {
                console.log('Initializing HyperApp...');

                // Quick dependency check for critical services
                await this.checkCriticalDependencies();

                // Initialize Supabase with basic error handling
                try {
                    this.supabase = window.supabase.createClient(this.config.supabaseUrl, this.config.supabaseKey);
                } catch (error) {
                    console.warn('Supabase initialization failed:', error);
                    this.showNotification('Database connection limited', 'warning');
                }

                // Check authentication state
                this.checkAuthState();

                // Bind methods and initialize
                this.bindMethods();
                this.init();
            }

            // Check only critical dependencies
            async checkCriticalDependencies() {
                // Simple check for Supabase (most critical)
                if (typeof window.supabase === 'undefined') {
                    console.warn('Supabase library not loaded');
                    this.showNotification('Some features may be limited', 'info');
                }

                // Check Telegram WebApp
                if (!window.Telegram || !window.Telegram.WebApp) {
                    console.warn('Telegram WebApp not available');
                }
            }

            // Bind all methods to maintain proper 'this' context
            bindMethods() {
                const methods = [
                    'init', 'setupEventListeners', 'syncUserWithSupabase', 'updateConnectionStatus',
                    'updateUserInfo', 'loadInitialData', 'loadNearbyReports', 'displayNearbyReports',
                    'loadUserReports', 'displayUserReports', 'voteReport', 'showReportModal',
                    'selectVibe', 'submitReport', 'showEmergencyReport', 'submitEmergencyReport',
                    'showView', 'loadMap', 'displayMap', 'loadTopAreas', 'toggleLanguage',
                    'changeLanguage', 'applyLanguage', 'showNotification', 'closeModal',
                    'getVibeIcon', 'getVibeArabicName', 'capitalizeFirstLetter', 'formatTimeAgo',
                    'updateTextDirection', 'requestUserLocation', 'checkAuthState',
                    'showAuthModal', 'hideAuthModal', 'setupAuthListeners', 'handleAuthLogin',
                    'handleAuthSignup', 'loadWeatherData', 'updateSafetyHub', 'generateDynamicSafetyTips',
                    'calculateUserReputation', 'updateUserReputation', 'getUserBadges', 'checkBadgeUnlocks',
                    'showBadgeNotification', 'loadEnhancedStats', 'renderStatsCharts', 'setupWeatherAlerts',
                    'checkWeatherAlerts', 'sendWeatherAlert', 'updateCommunityInsights',
                    // Geofence methods
                    'loadGeofenceSettings', 'saveGeofenceSettings', 'toggleGeofenceMonitoring',
                    'classifyGeofenceZones', 'startGeofenceMonitoring', 'stopGeofenceMonitoring',
                    'checkGeofenceStatus', 'handleGeofenceEvent', 'sendGeofenceNotification',
                    'getGeofenceNotificationPriority', 'getGeofenceNotificationMessage',
                    // AI safety analysis methods
                    'analyzeAreaSafetyIntelligence', 'analyzeLocationBasedRisks', 'analyzeTemporalPatterns',
                    'analyzeWeatherSafety', 'analyzeCommunityVibeTrends', 'calculatePredictedRisks',
                    'considerPersonalSafetyFactors', 'generateIntelligentSafetyTips', 'calculateAreaDangerLevel',
                    'analyzeReportDensity', 'getCurrentWeatherData', 'getSeasonalSafetyFactor',
                    'analyzeRecentActivityTrends', 'getWeatherSafetyModifier', 'calculateCommunityConsensus',
                    'findVibeCorrelations', 'calculateEmergencyReadiness', 'generateFallbackTips',
                    'generateDefaultTips'
                ];

                methods.forEach(method => {
                    this[method] = this[method].bind(this);
                });
            }

            async init() {
                // Load saved theme
                const savedTheme = localStorage.getItem('hyperapp-theme') || 'dark';
                document.documentElement.setAttribute('data-theme', savedTheme);

                // Update theme toggle icon
                const themeIcon = document.querySelector('#themeToggle i');
                if (themeIcon) {
                    themeIcon.className = savedTheme === 'dark' ? 'fas fa-moon' : 'fas fa-sun';
                }

                // Always force fresh data load on app initialization
                this.forceFreshDataLoad = true;
                // Clear local data to ensure fresh load
                this.nearbyReports = [];
                this.userReports = [];
                // Clear any cached weather data
                localStorage.removeItem('hyperapp_weather_data');
                localStorage.removeItem('hyperapp_weather_time');
                console.log('App initialization - forcing fresh data load');

                // Set up auth listeners first
                this.setupAuthListeners();

                // Initialize Telegram WebApp
                if (this.tg) {
                    this.tg.expand();
                    this.tg.MainButton.hide();

                    // Get user data
                    const user = this.tg.initDataUnsafe.user;
                    if (user) {
                        this.userData = user;
                        this.isAuthenticated = true;
                        await this.syncUserWithSupabase();
                        this.updateUserInfo();
                    }

                    // Update connection status
                    this.updateConnectionStatus(true);
                } else {
                    this.updateConnectionStatus(false);
                    this.showNotification("Running in standalone mode", "info");

                    // For testing without Telegram, show auth modal
                    this.showAuthModal();
                }

                // Set up event listeners early
                this.setupEventListeners();

                // Critical: Request location immediately and wait for it before loading data
                await this.requestLocationImmediately();

                // Load all data synchronously after location is available
                await this.loadAllDataImmediately();

                // Set up real-time subscriptions after initial data load
                this.setupRealtimeSubscriptions();

                // Make app instance globally available
                window.hyperApp = this;
            }

            // Placeholder methods - need to be implemented
            async requestLocationImmediately() {
                console.log('Requesting location...');
                // Implement location request logic
            }

            async loadAllDataImmediately() {
                console.log('Loading all data...');
                // Implement data loading logic
            }

            setupRealtimeSubscriptions() {
                console.log('Setting up real-time subscriptions...');
                // Implement real-time subscription logic
            }

            setupEventListeners() {
                console.log('Setting up event listeners...');
                // Implement event listener setup
            }

            showNotification(message, type) {
                console.log('Notification:', message, type);
                // Implement notification display logic
            }

            closeModal(modalId) {
                console.log('Closing modal:', modalId);
                // Implement modal close logic
            }

            showEmergencyReport() {
                console.log('Showing emergency report modal');
                // Implement emergency report modal
            }

            loadNearbyReports() {
                console.log('Loading nearby reports');
                // Implement report loading
            }

            loadUserReports() {
                console.log('Loading user reports');
                // Implement user report loading
            }

            loadEnhancedStats() {
                console.log('Loading enhanced stats');
                // Implement stats loading
            }

            updateStats() {
                console.log('Updating stats');
                // Implement stats update
            }

            loadMap() {
                console.log('Loading map');
                // Implement map loading
            }

            // Enhanced safety tip generation with AI-like analysis
            generateDynamicSafetyTips() {
                const safetyTipsContainer = document.getElementById('safetyTips');
                if (!safetyTipsContainer) return;

                if (!this.nearbyReports || this.nearbyReports.length === 0) {
                    // Default tips when no reports
                    safetyTipsContainer.innerHTML = `
                        <div class="guideline-item">
                            <i class="fas fa-users"></i>
                            <span data-en="Avoid crowded areas after dark" data-ar="تجنب المناطق المزدحمة بعد الظلام">Avoid crowded areas after dark</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-mobile-alt"></i>
                            <span data-en="Keep your phone charged" data-ar="احتفظ بهاتفك مشحوناً">Keep your phone charged</span>
                        </div>
                        <div class="guideline-item">
                            <i class="fas fa-share-alt"></i>
                            <span data-en="Share your location with trusted contacts" data-ar="شارك موقعك مع جهات الاتصال الموثوقة">Share your location with trusted contacts</span>
                        </div>
                    `;
                    return;
                }

                // AI-powered safety tip generation algorithm
                const insights = this.analyzeAreaSafetyIntelligence();

                // Generate personalized safety tips based on comprehensive analysis
                const tips = this.generateIntelligentSafetyTips(insights);

                // Display the intelligent tips with dynamic styling
                safetyTipsContainer.innerHTML = tips.slice(0, 3).map(tip => `
                    <div class="guideline-item ${tip.priority || ''}" style="${tip.style || ''}">
                        <i class="${tip.icon}"></i>
                        <span>${tip.text}</span>
                    </div>
                `).join('');
            }

            // AI safety analysis methods
            analyzeAreaSafetyIntelligence() {
                const insights = {
                    locationBased: this.analyzeLocationBasedRisks(),
                    temporal: this.analyzeTemporalPatterns(),
                    weatherImpact: this.analyzeWeatherSafety(),
                    communityVibes: this.analyzeCommunityVibeTrends(),
                    predictedRisks: this.calculatePredictedRisks(),
                    personalFactors: this.considerPersonalSafetyFactors()
                };
                return insights;
            }

            analyzeLocationBasedRisks() {
                if (!this.userLocation) return { hasLocationData: false };

                const locationRisks = {
                    hasLocationData: true,
                    proximityRisks: [],
                    safeAreas: [],
                    riskZones: [],
                    densityAnalysis: this.analyzeReportDensity()
                };

                // Analyze reports within different radius ranges
                const ranges = [500, 1000, 2000]; // meters
                ranges.forEach(radius => {
                    const nearby = this.nearbyReports.filter(report => {
                        if (!report.latitude || !report.longitude) return false;
                        const distance = this.calculateDistance(
                            this.userLocation.latitude, this.userLocation.longitude,
                            report.latitude, report.longitude
                        );
                        return distance * 1000 <= radius;
                    });

                    const dangerLevel = this.calculateAreaDangerLevel(nearby);

                    if (radius === 500) {
                        locationRisks.immediateAreaDanger = dangerLevel;
                    } else if (radius === 1000) {
                        locationRisks.nearbyAreaDanger = dangerLevel;
                    }
                });

                return locationRisks;
            }

            analyzeTemporalPatterns() {
                const now = new Date();
                const hour = now.getHours();
                const dayOfWeek = now.getDay();

                const temporalInsights = {
                    isNighttime: hour >= 22 || hour <= 5,
                    isWeekend: dayOfWeek === 0 || dayOfWeek === 6,
                    peakHours: hour >= 17 && hour <= 21, // Evening peak
                    lowActivityHours: hour >= 2 && hour <= 6,
                    seasonalFactor: this.getSeasonalSafetyFactor(),
                    recentActivityTrend: this.analyzeRecentActivityTrends()
                };

                return temporalInsights;
            }

            analyzeWeatherSafety() {
                const weatherData = this.getCurrentWeatherData();
                if (!weatherData) return {};

                const weatherInsights = {
                    affectsVisibility: ['rain', 'fog', 'snow'].includes(weatherData.condition),
                    affectsMobility: ['rain', 'snow', 'wind'].includes(weatherData.condition),
                    extremeTemperature: Math.abs(weatherData.temperature - 22) > 15, // Far from comfortable 22°C
                    precipitationRisk: weatherData.condition === 'rain' || weatherData.condition === 'snow',
                    safetyModifier: this.getWeatherSafetyModifier(weatherData)
                };

                return weatherInsights;
            }

            analyzeCommunityVibeTrends() {
                // Analyze vibe distribution and trends
                const recentReports = this.nearbyReports.slice(0, 50); // Analyze more reports for trends

                const vibeAnalysis = {
                    dominantVibes: {},
                    trendingUp: [],
                    trendingDown: [],
                    communityConsensus: this.calculateCommunityConsensus(recentReports),
                    vibeCorrelations: this.findVibeCorrelations(recentReports)
                };

                // Calculate dominant vibes
                recentReports.forEach(report => {
                    if (!vibeAnalysis.dominantVibes[report.vibe_type]) {
                        vibeAnalysis.dominantVibes[report.vibe_type] = 0;
                    }
                    vibeAnalysis.dominantVibes[report.vibe_type]++;
                });

                // Find trending vibes (compare last 24h vs previous 24h)
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);

                const recent24h = recentReports.filter(r => new Date(r.created_at) > yesterday);
                const previous24h = recentReports.filter(r => {
                    const reportDate = new Date(r.created_at);
                    return reportDate > new Date(yesterday.getTime() - 24 * 60 * 60 * 1000) && reportDate <= yesterday;
                });

                Object.keys(vibeAnalysis.dominantVibes).forEach(vibe => {
                    const recentCount = recent24h.filter(r => r.vibe_type === vibe).length;
                    const previousCount = previous24h.filter(r => r.vibe_type === vibe).length;

                    if (recentCount > previousCount * 1.5) {
                        vibeAnalysis.trendingUp.push(vibe);
                    } else if (recentCount < previousCount * 0.5) {
                        vibeAnalysis.trendingDown.push(vibe);
                    }
                });

                return vibeAnalysis;
            }

            calculatePredictedRisks() {
                const predictions = {
                    shortTermRisk: 'medium',
                    mediumTermTrend: 'stable',
                    locationSpecificWarnings: [],
                    timeBasedAdvice: []
                };

                const communityInsights = this.analyzeCommunityVibeTrends();

                if (communityInsights.trendingUp.includes('dangerous')) {
                    predictions.shortTermRisk = 'high';
                    predictions.locationSpecificWarnings.push('Increasing dangerous activity reported');
                }

                if (communityInsights.trendingUp.includes('crowded') && this.analyzeTemporalPatterns().isNighttime) {
                    predictions.locationSpecificWarnings.push('Crowded evening areas may become risky');
                }

                const temporal = this.analyzeTemporalPatterns();
                if (temporal.isNighttime && communityInsights.dominantVibes.dangerous > 5) {
                    predictions.timeBasedAdvice.push('Nighttime caution due to reported dangerous activity');
                }

                return predictions;
            }

            considerPersonalSafetyFactors() {
                return {
                    hasReportedRecently: false,
                    trustedNetworkSize: 0,
                    emergencyPreparedness: 'basic',
                    locationHistoryPatterns: []
                };
            }

            generateIntelligentSafetyTips(insights) {
                const tips = [];

                // High priority alerts
                if (insights.predictedRisks.shortTermRisk === 'high') {
                    tips.push({
                        icon: 'fas fa-exclamation-triangle',
                        text: 'High alert: Immediate safety concerns detected in your area',
                        priority: 'high-priority'
                    });
                }

                // Location-based recommendations
                if (insights.locationBased.hasLocationData) {
                    if (insights.locationBased.immediateAreaDanger > 0.7) {
                        tips.push({
                            icon: 'fas fa-exclamation-triangle',
                            text: 'High danger reports within 500m - consider relocating safely',
                            priority: 'high-priority',
                            style: 'color: #dc3545;'
                        });
                    } else if (insights.weatherImpact.affectsVisibility) {
                        tips.push({
                            icon: 'fas fa-eye',
                            text: 'Poor visibility due to weather - use extra caution moving around',
                            priority: 'medium-priority'
                        });
                    }
                }

                // Temporal patterns
                if (insights.temporal.isNighttime) {
                    if (insights.communityVibes.dominantVibes.dangerous > 3) {
                        tips.push({
                            icon: 'fas fa-moon',
                            text: 'Nighttime high-risk area: Travel well-lit routes with others when possible',
                            priority: 'medium-priority'
                        });
                    }
                }

                // Weather safety integration
                if (insights.weatherImpact.safetyModifier < 0.7) {
                    tips.push({
                        icon: 'fas fa-cloud-rain',
                        text: 'Weather conditions may impact safety - plan accordingly',
                        priority: 'medium-priority'
                    });
                }

                // Community consensus tips
                const consensus = insights.communityVibes.communityConsensus;
                if (consensus && consensus.confidence > 0.7) {
                    switch (consensus.dominantSentiment) {
                        case 'dangerous':
                            tips.push({
                                icon: 'fas fa-shield-alt',
                                text: 'Community consensus: High-caution area with multiple danger reports',
                                priority: 'high-priority'
                            });
                            break;
                        case 'calm':
                            tips.push({
                                icon: 'fas fa-peace',
                                text: 'Community rated area as generally calm and safe',
                                priority: 'low-priority',
                                style: 'color: #28a745;'
                            });
                            break;
                    }
                }

                // Predictive recommendations
                if (insights.predictedRisks.locationSpecificWarnings.length > 0) {
                    tips.push({
                        icon: 'fas fa-chart-line',
                        text: insights.predictedRisks.locationSpecificWarnings[0],
                        priority: 'medium-priority'
                    });
                }

                // Fallback tips if not enough AI-generated content
                return tips.length > 0 ? tips : this.generateDefaultTips();
            }

            calculateAreaDangerLevel(reports) {
                if (!reports || reports.length === 0) return 0;
                const dangerous = reports.filter(r => r.vibe_type === 'dangerous').length;
                const suspicious = reports.filter(r => r.vibe_type === 'suspicious').length;
                const total = reports.length;
                return (dangerous * 1.0 + suspicious * 0.5) / total;
            }

            analyzeReportDensity() {
                if (!this.userLocation) return { density: 0 };
                const nearbyReports = this.nearbyReports.filter(report => {
                    if (!report.latitude || !report.longitude) return false;
                    const distance = this.calculateDistance(
                        this.userLocation.latitude, this.userLocation.longitude,
                        report.latitude, report.longitude
                    );
                    return distance <= 1;
                });
                return {
                    density: nearbyReports.length,
                    densityCategory: nearbyReports.length > 10 ? 'high' : nearbyReports.length > 5 ? 'medium' : 'low'
                };
            }

            getCurrentWeatherData() {
                const weatherData = localStorage.getItem('hyperapp_weather_data');
                if (!weatherData) return null;
                try {
                    const data = JSON.parse(weatherData);
                    return {
                        temperature: data.main?.temp,
                        condition: data.weather?.[0]?.main?.toLowerCase()
                    };
                } catch (e) {
                    return null;
                }
            }

            getSeasonalSafetyFactor() {
                const month = new Date().getMonth();
                if (month >= 11 || month <= 2) return 0.8;
                if (month >= 5 && month <= 8) return 1.0;
                return 0.9;
            }

            analyzeRecentActivityTrends() {
                const recent = this.nearbyReports.slice(0, 20);
                const older = this.nearbyReports.slice(20, 40);
                const recentDangerous = recent.filter(r => r.vibe_type === 'dangerous').length;
                const olderDangerous = older.filter(r => r.vibe_type === 'dangerous').length;

                if (recentDangerous > olderDangerous * 1.5) return 'increasing';
                if (recentDangerous < olderDangerous * 0.5) return 'decreasing';
                return 'stable';
            }

            getWeatherSafetyModifier(weatherData) {
                if (!weatherData) return 1.0;
                let modifier = 1.0;
                const condition = weatherData.condition;
                const temp = weatherData.temperature;

                if (['rain', 'snow', 'fog'].includes(condition)) modifier *= 0.8;
                if (condition === 'storm' || condition === 'thunderstorm') modifier *= 0.7;
                if (temp < 0 || temp > 35) modifier *= 0.8;

                if (condition === 'clear' && temp >= 15 && temp <= 25) modifier *= 1.1;

                return Math.max(0.5, Math.min(1.5, modifier));
            }

            calculateCommunityConsensus(reports) {
                if (!reports || reports.length < 5) return null;

                const vibeCounts = {};
                reports.forEach(report => {
                    vibeCounts[report.vibe_type] = (vibeCounts[report.vibe_type] || 0) + 1;
                });

                const total = reports.length;
                let dominantVibe = null;
                let maxCount = 0;

                Object.entries(vibeCounts).forEach(([vibe, count]) => {
                    if (count > maxCount) {
                        maxCount = count;
                        dominantVibe = vibe;
                    }
                });

                const confidence = maxCount / total;
                return {
                    dominantSentiment: dominantVibe,
                    confidence: confidence,
                    consensusStrength: confidence > 0.6 ? 'strong' : confidence > 0.4 ? 'moderate' : 'weak'
                };
            }

            findVibeCorrelations(reports) {
                return {};
            }

            calculateEmergencyReadiness(reports) {
                return 'basic';
            }

            generateFallbackTips(insights) {
                const tips = [];
                if (insights.weatherImpact.precipitationRisk) {
                    tips.push({
                        icon: 'fas fa-umbrella',
                        text: 'Weather conditions suggest carrying rain gear and staying aware of slippery surfaces'
                    });
                }
                if (insights.temporal.isWeekend && insights.temporal.peakHours) {
                    tips.push({
                        icon: 'fas fa-clock',
                        text: 'Weekend evening hours may have higher activity and different safety dynamics'
                    });
                }
                return tips;
            }

            generateDefaultTips() {
                return [
                    {
                        icon: 'fas fa-users',
                        text: 'Stay aware of your surroundings and trust your instincts'
                    },
                    {
                        icon: 'fas fa-mobile-alt',
                        text: 'Keep emergency contacts saved and battery charged'
                    },
                    {
                        icon: 'fas fa-share-alt',
                        text: 'Consider sharing location with trusted friends when in unfamiliar areas'
                    }
                ];
            }

            // Distance calculation utility
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
        }

        // Initialize app
        window.hyperApp = new HyperApp();
    </script>
</body>
</html>
+
