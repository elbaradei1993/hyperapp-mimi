<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HyperApp - Community Safety Platform</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* All your existing CSS remains the same */
    /* Adding only the auth modal styles below */
    
    .auth-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      backdrop-filter: blur(5px);
    }
    
    .auth-content {
      background: var(--dark-bg);
      margin: 15% auto;
      width: 90%;
      max-width: 400px;
      border-radius: var(--border-radius);
      overflow: hidden;
      animation: modalFadeIn 0.3s;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-header {
      background: var(--card-bg);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-tabs {
      display: flex;
      background: var(--card-bg);
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .auth-tab {
      flex: 1;
      padding: 15px;
      text-align: center;
      cursor: pointer;
      opacity: 0.7;
      transition: all 0.3s ease;
    }
    
    .auth-tab.active {
      opacity: 1;
      border-bottom: 2px solid var(--primary);
    }
    
    .auth-form {
      padding: 20px;
    }
    
    .auth-form.hidden {
      display: none;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
    }
    
    .auth-btn {
      width: 100%;
      padding: 12px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .auth-btn:hover {
      background: var(--primary-dark);
    }
    
    .auth-footer {
      padding: 15px 20px;
      text-align: center;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 14px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <!-- Auth Modal -->
  <div id="authModal" class="auth-modal">
    <div class="auth-content">
      <div class="auth-header">
        <h2 data-en="Authentication Required" data-ar="مطلوب مصادقة">Authentication Required</h2>
        <span class="close" id="closeAuth">&times;</span>
      </div>
      
      <div class="auth-tabs">
        <div class="auth-tab active" data-tab="login">Login</div>
        <div class="auth-tab" data-tab="signup">Sign Up</div>
      </div>
      
      <div class="auth-form" id="loginForm">
        <div class="form-group">
          <label data-en="Email" data-ar="البريد الإلكتروني">Email</label>
          <input type="email" id="loginEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label data-en="Password" data-ar="كلمة المرور">Password</label>
          <input type="password" id="loginPassword" placeholder="••••••••">
        </div>
        <button class="auth-btn" id="loginBtn" data-en="Login" data-ar="تسجيل الدخول">Login</button>
      </div>
      
      <div class="auth-form hidden" id="signupForm">
        <div class="form-group">
          <label data-en="Username" data-ar="اسم المستخدم">Username</label>
          <input type="text" id="signupUsername" placeholder="Choose a username">
        </div>
        <div class="form-group">
          <label data-en="Email" data-ar="البريد الإلكتروني">Email</label>
          <input type="email" id="signupEmail" placeholder="your@email.com">
        </div>
        <div class="form-group">
          <label data-en="Password" data-ar="كلمة المرور">Password</label>
          <input type="password" id="signupPassword" placeholder="••••••••">
        </div>
        <div class="form-group">
          <label data-en="Confirm Password" data-ar="تأكيد كلمة المرور">Confirm Password</label>
          <input type="password" id="signupPasswordConfirm" placeholder="••••••••">
        </div>
        <button class="auth-btn" id="signupBtn" data-en="Sign Up" data-ar="إنشاء حساب">Sign Up</button>
      </div>
      
      <div class="auth-footer">
        <p data-en="You need to authenticate to use all features" data-ar="تحتاج إلى المصادقة لاستخدام جميع الميزات">You need to authenticate to use all features</p>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Your existing HTML content remains the same -->
    <!-- ... -->
  </div>

  <script>
    // HyperApp Mini App - Fixed Authentication Implementation
    class HyperApp {
      constructor() {
        this.tg = window.Telegram.WebApp;
        this.currentLanguage = 'en';
        this.userData = null;
        this.nearbyReports = [];
        this.userReports = [];
        this.selectedVibe = null;
        this.isConnected = false;
        this.userLocation = null;
        this.isAuthenticated = false;
        
        // Initialize Supabase
        this.supabaseUrl = 'https://nqwejzbayquzsvcodunl.supabase.co';
        this.supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xd2VqemJheXF1enN2Y29kdW5sIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzOTA0MjAsImV4cCI6MjA3Mzk2NjQyMH0.01yifC-tfEbBHD5u315fpb_nZrqMZCbma_UrMacMb78';
        this.supabase = window.supabase.createClient(this.supabaseUrl, this.supabaseKey);
        
        // Check authentication state
        this.checkAuthState();
        
        // Bind all methods
        this.bindMethods();
        
        this.init();
      }
      
      async checkAuthState() {
        // Check if we have a Telegram user first
        if (this.tg && this.tg.initDataUnsafe && this.tg.initDataUnsafe.user) {
          const telegramUser = this.tg.initDataUnsafe.user;
          this.userData = telegramUser;
          this.isAuthenticated = true;
          await this.syncUserWithSupabase();
          this.updateUserInfo();
          return;
        }
        
        // Check Supabase authentication as fallback
        const { data: { session }, error } = await this.supabase.auth.getSession();
        if (session && session.user) {
          this.isAuthenticated = true;
          this.userData = {
            id: session.user.id,
            email: session.user.email,
            ...session.user.user_metadata
          };
          await this.syncUserWithSupabase();
          this.updateUserInfo();
        } else {
          // Show auth modal if no authentication found
          this.showAuthModal();
        }
      }
      
      showAuthModal() {
        document.getElementById('authModal').style.display = 'block';
      }
      
      hideAuthModal() {
        document.getElementById('authModal').style.display = 'none';
      }
      
      async setupAuthListeners() {
        // Auth tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.target.getAttribute('data-tab');
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
            e.target.classList.add('active');
            document.getElementById(tabName + 'Form').classList.remove('hidden');
          });
        });
        
        // Close auth modal
        document.getElementById('closeAuth').addEventListener('click', () => {
          this.hideAuthModal();
        });
        
        // Login button
        document.getElementById('loginBtn').addEventListener('click', async () => {
          const email = document.getElementById('loginEmail').value;
          const password = document.getElementById('loginPassword').value;
          
          if (!email || !password) {
            this.showNotification("Please fill all fields", "error");
            return;
          }
          
          try {
            const { data, error } = await this.supabase.auth.signInWithPassword({
              email,
              password
            });
            
            if (error) {
              this.showNotification(error.message, "error");
            } else {
              this.isAuthenticated = true;
              this.userData = {
                id: data.user.id,
                email: data.user.email,
                ...data.user.user_metadata
              };
              await this.syncUserWithSupabase();
              this.updateUserInfo();
              this.hideAuthModal();
              this.loadInitialData();
              this.showNotification("Login successful", "success");
            }
          } catch (error) {
            this.showNotification("Login failed. Please try again.", "error");
            console.error("Login error:", error);
          }
        });
        
        // Signup button
        document.getElementById('signupBtn').addEventListener('click', async () => {
          const username = document.getElementById('signupUsername').value;
          const email = document.getElementById('signupEmail').value;
          const password = document.getElementById('signupPassword').value;
          const passwordConfirm = document.getElementById('signupPasswordConfirm').value;
          
          if (!username || !email || !password || !passwordConfirm) {
            this.showNotification("Please fill all fields", "error");
            return;
          }
          
          if (password !== passwordConfirm) {
            this.showNotification("Passwords don't match", "error");
            return;
          }
          
          if (password.length < 6) {
            this.showNotification("Password must be at least 6 characters", "error");
            return;
          }
          
          try {
            const { data, error } = await this.supabase.auth.signUp({
              email,
              password,
              options: {
                data: {
                  username: username,
                  reputation: 0,
                  language: 'en'
                }
              }
            });
            
            if (error) {
              this.showNotification(error.message, "error");
            } else {
              this.showNotification("Signup successful! Please check your email for verification.", "success");
              // Switch to login tab
              document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
              document.querySelectorAll('.auth-form').forEach(f => f.classList.add('hidden'));
              document.querySelector('[data-tab="login"]').classList.add('active');
              document.getElementById('loginForm').classList.remove('hidden');
            }
          } catch (error) {
            this.showNotification("Signup failed. Please try again.", "error");
            console.error("Signup error:", error);
          }
        });
      }
      
      async syncUserWithSupabase() {
        if (!this.userData) return false;
        
        try {
          // Check if user exists in users table
          const { data, error } = await this.supabase
            .from('users')
            .select('*')
            .eq('user_id', this.userData.id)
            .maybeSingle();
          
          if (error && error.code === 'PGRST116') {
            // User doesn't exist in users table, create a new record
            const { data: newUser, error: insertError } = await this.supabase
              .from('users')
              .insert([
                {
                  user_id: this.userData.id,
                  username: this.userData.username || this.userData.first_name,
                  reputation: 0,
                  language: 'en'
                }
              ])
              .select()
              .single();
            
            if (insertError) {
              console.error("Error creating user:", insertError);
              return false;
            }
            
            this.userData.reputation = 0;
            this.userData.language = 'en';
            return true;
          } else if (error) {
            console.error("Error checking user:", error);
            return false;
          } else {
            // Update user data with Supabase info
            this.userData.reputation = data.reputation || 0;
            this.userData.language = data.language || 'en';
            this.currentLanguage = data.language || 'en';
            this.applyLanguage(this.currentLanguage);
            
            // Update language selector
            const languageSelect = document.getElementById('languageSelect');
            const currentLanguage = document.getElementById('currentLanguage');
            
            if (languageSelect) languageSelect.value = this.currentLanguage;
            if (currentLanguage) currentLanguage.textContent = this.currentLanguage === 'en' ? 'EN' : 'AR';
            
            return true;
          }
        } catch (error) {
          console.error("Error syncing user with Supabase:", error);
          return false;
        }
      }
      
      // Your existing methods remain the same with minor adjustments
      // ... (init, setupEventListeners, updateConnectionStatus, etc.)
      
      // Make sure to call setupAuthListeners in your init method
      async init() {
        console.log("Initializing HyperApp with Supabase...");
        
        // Set up auth listeners
        this.setupAuthListeners();
        
        // Initialize Telegram WebApp
        if (this.tg) {
          this.tg.expand();
          this.tg.MainButton.hide();
          
          // Get user data
          const user = this.tg.initDataUnsafe.user;
          if (user) {
            this.userData = user;
          }
          
          // Try to get user location
          this.requestUserLocation();
          
          // Set up event listeners
          this.setupEventListeners();
          
          // Update connection status
          this.updateConnectionStatus(true);
        } else {
          console.log("Not in Telegram environment");
          this.updateConnectionStatus(false);
          this.showNotification("Running in standalone mode", "info");
          
          // Simulate user data for testing
          this.userData = {
            id: 123456789,
            first_name: "Test User",
            username: "testuser"
          };
        }
        
        // Load initial data if authenticated
        if (this.isAuthenticated) {
          await this.loadInitialData();
        }
        
        // Make app instance globally available
        window.hyperApp = this;
      }
      
      // Add authentication checks to relevant methods
      async voteReport(reportId, voteType) {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to vote", "error");
          return;
        }
        
        // Your existing voteReport implementation
        // ...
      }
      
      async showReportModal() {
        if (!this.isAuthenticated) {
          this.showAuthModal();
          this.showNotification("Please login to submit reports", "error");
          return;
        }
        
        // Your existing showReportModal implementation
        // ...
      }
      
      // ... other methods remain the same
    }

    // Initialize the app when the page loads
    document.addEventListener('DOMContentLoaded', () => {
      window.app = new HyperApp();
    });
  </script>
</body>
</html>